<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Service + Comptes + Patients (admin supprime avertissements)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <style>

/* === Logs modal boxes === */
.logbox{
  background: var(--card-soft);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px;
  max-height: 76vh;
  overflow-y: auto; overflow-x: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12.5px;
  line-height: 1.4;
  white-space: pre;
}


/* Hide 'Finir son service' by default; JS will show for admin/tech */
#pf_forceEndBtn{display:none;}


/* === Sticky Warning Toast (top-right, non-blocking) === */
.warning-toast {
  position: fixed;
  top: 16px;
  right: 16px;
  max-width: 360px;
  background: #ef7d13; /* orange */
  color: #21242B;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 12px;
  padding: 12px 16px 12px 14px;
  box-shadow: 0 8px 28px rgba(0,0,0,0.35);
  z-index: 9999;
  display: none;
  font-family: inherit;
}
.warning-toast.show { display: block; }
.warning-toast .wt-header {
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 6px;
  display:flex; align-items:center; gap:8px;
}
.warning-toast .wt-body {
  font-size: 13px;
  line-height: 1.35;
  color: #1a1d23;
}
.warning-toast .wt-meta {
  margin-top: 6px;
  font-size: 12px;
  opacity: 0.8;
}
.warning-toast .wt-close {
  margin-left: auto;
  font-weight: 700;
  cursor: pointer;
  user-select: none;
  padding: 2px 6px;
  border-radius: 6px;
}
.warning-toast .wt-close:hover { background: rgba(0,0,0,0.1); }


    :root{
      --bg:#21242B; --surf:#262A33; --card:#2B3039; --card-soft:#2F3540; --border:#3A404C;
      --text:#E8ECF3; --muted:#A6AEBB; --primary:#4F8CFF; --primary-weak:#3A68C7;
      --green:#2ECC71; --red:#E25555; --orange:#F39C12; --shadow:0 8px 30px rgba(0,0,0,.35);
      --gray:#8B93A2;
      --glass-bg: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      --glass-br: rgba(255,255,255,.18);
      --glass-hl: rgba(255,255,255,.35);
      --role-new:#9da3af; --role-certifie:#4F8CFF; --role-technicien:#2ECC71;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; background:var(--bg); color:var(--text);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center;
      padding-left: 280px; padding-right: 340px;
    }
    body.warn-border-mid::after,
    body.warn-border-high::after{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:100; border-radius:8px;
    }
    body.warn-border-mid::after{ border:4px solid var(--orange); }
    body.warn-border-high::after{ border:4px solid var(--red); }

    .site-logo{ position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:6; display:none; opacity:.9; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
    .site-logo img{ height:32px; }
    body.view-service .site-logo, body.view-admin .site-logo{ display:block; }

    .glass{
      background: var(--glass-bg);
      backdrop-filter: blur(18px) saturate(160%);
      -webkit-backdrop-filter: blur(18px) saturate(160%);
      border:1px solid var(--glass-br);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 var(--glass-hl);
    }
    .overlay.glass, .panel-right.glass{
      background: rgba(33,36,43,.50);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.35);
    }
    .panel-right.glass input, .panel-right.glass select, .panel-right.glass textarea{
      background: rgba(20,22,27,.65); border-color: rgba(255,255,255,.20); color:var(--text);
    }

    /* Overlay joueurs (gauche) */
    .overlay{
      position:fixed; inset:0 auto 0 0; width:260px; padding:14px;
      border-right:1px solid var(--border);
      overflow:hidden; display:flex; flex-direction:column; gap:10px;
      border-top-right-radius:14px; border-bottom-right-radius:14px;
      z-index:5;
    }
    .overlay h3{ margin:2px 0 6px; font-size:14px; font-weight:700; }
    .overlay .list{ overflow:auto; flex:1; padding-right:4px; border-top:1px solid var(--border); margin-top:6px; padding-top:6px; }

    .player{ display:flex; flex-direction:column; gap:4px; padding:10px 12px; border-radius:12px; cursor:pointer; transition:background .18s ease; }
    .player:hover{ background:rgba(255,255,255,.06); }
    .player.active{ outline:2px solid rgba(79,140,255,.35); background:rgba(79,140,255,.12); }
    .player .head{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .player .name{ font-weight:700; font-size:13.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .player .status{ font-size:11.5px; color:var(--muted); }
    .player .status.green{ color:var(--green); font-weight:700; }
    .role-pill{ padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; line-height:1.6; background:#ddd; color:#111; text-transform:capitalize; }
    .role-new{ background:var(--role-new); color:#111; }
    .role-certifie{ background:var(--role-certifie); color:#fff; }
    .role-technicien{ background:var(--role-technicien); color:#0f1a12; }
    .hint-sm{ font-size:11px; color:var(--muted); text-align:center; margin-top:-2px; }

    /* Panneau patients (droite) */
    .panel-right{
      position:fixed; inset:0 0 0 auto; width:320px; padding:12px;
      border-left:1px solid var(--border);
      display:flex; flex-direction:column; gap:8px;
      border-top-left-radius:14px; border-bottom-left-radius:14px;
      z-index:5;
    }
    .panel-right h3{ margin:2px 0 2px; font-size:14px; font-weight:800; }
    .panel-right .actions{ display:flex; gap:8px; }
    .panel-right .btn-lite{ flex:1; padding:9px 10px; border-radius:10px; background:rgba(79,140,255,.14); border:1px solid var(--glass-br); cursor:pointer; font-weight:700; }
    .panel-right .btn-lite:hover{ background:rgba(79,140,255,.2); }
    .panel-right .search{ display:flex; }
    .panel-right input, .panel-right select, .panel-right textarea{ width:100%; padding:8px 10px; border:1px solid var(--glass-br); border-radius:10px; font-size:13px; }
    .panel-right .list{ overflow:auto; flex:1; border-top:1px solid var(--border); padding-top:6px; }
    .patient-row{ padding:8px 10px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background .18s ease; }
    .patient-row:hover{ background:rgba(255,255,255,.06); }
    .patient-name{ font-weight:600; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .patient-meta{ font-size:11px; color:var(--muted); }

    .box{ background:var(--card); padding:2rem; border-radius:14px; box-shadow:var(--shadow); width:min(92vw, 520px); text-align:center; border:1px solid var(--border); }
    input.main, button.main, select.main, textarea.main{
      width:100%; padding:10px 12px; margin:.5rem 0; border-radius:10px; border:1px solid var(--border); font-size:1rem; background:#252A33; color:var(--text);
    }
    button.main{ border:1px solid transparent; background:var(--primary); color:#fff; cursor:pointer; font-weight:700; transition:filter .18s ease, background .18s ease; }
    button.main:hover{ background:var(--primary-weak); }
    .btn{ flex:1; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:700;}
    .start{ background: var(--green); color:#0f1a12;}
    .end{ background: var(--red); color:#fff;}
    .home{ background:#6c757d; color:#fff;}
    .btn:disabled{ opacity:.6; cursor:not-allowed;}
    .msg{ margin-top:.4rem; font-size:.9em;} .ok{ color:var(--green);} .error{ color:#FF8A8A;}
    .timer{ margin-top:.75rem; font-weight:800; font-size:1.35rem; letter-spacing:.5px;}
    .subtle{ color:var(--muted); font-size:.9rem; margin-top:.2rem;}
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:14px; text-align:left; }
    .card{ background:var(--card-soft); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .label{ font-size:.85rem; color:var(--muted); }
    .value{ font-weight:800; font-size:1.05rem; margin-top:2px; color:var(--text); }

    .admin-box{ background:var(--card); padding:1.2rem; border-radius:14px; box-shadow:var(--shadow); width:min(96vw, 1200px); border:1px solid var(--border); }
    .admin-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .admin-title{ font-size:1.2rem; font-weight:800;}
    .admin-actions{ display:flex; gap:10px; }
    .btn-sm{ padding:.55rem .8rem; border-radius:10px; border:1px solid var(--border); cursor:pointer; color:#fff; background:#3B4250; }
    .btn-sm:hover{ filter:brightness(1.05); }
    .btn-sm.danger{ background:#B24B4B;}
    table{ width:100%; border-collapse:separate; border-spacing:0; color:var(--text); }
    th, td{ text-align:left; padding:.6rem .7rem; font-size:.95rem; }
    thead th{ position:sticky; top:0; background:#2C3240; border-bottom:1px solid var(--border); z-index:1;}
    tbody tr:nth-child(odd){ background:#292F3A;} tbody tr:nth-child(even){ background:#262C36;}
    tbody tr:hover{ background:#313846;}
    .td-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{ font-size:.8rem; padding:.25rem .5rem; border-radius:999px; color:#fff; }
    .pill.green{ background:var(--green);} .pill.gray{ background:#6B7382;}
    .role-select{ background:#2E3442; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:.35rem .5rem; font-size:.9rem; }

    /* Modales */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:50;}
    #patientHistoryModal { z-index: 55; }
    #patientDetailsModal { z-index: 60; }
    .modal{ width:min(92vw, 760px); background:var(--card); border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,.45); padding:18px; border:1px solid var(--border); }
    .modal h3{ margin:0 0 8px; font-size:1.2rem; }
    .modal .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .modal .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .modal .actions{ display:flex; gap:10px; margin-top:12px; }
    .logo-big{ width:140px; display:block; margin:0 auto 8px; filter: drop-shadow(0 8px 24px rgba(0,0,0,.35)); }

    .warn-card{ cursor:default; transition:box-shadow .18s ease, transform .08s ease; }
    .warn-card.clickable{ cursor:pointer; }
    .warn-ok{ border-color:#2c3e50; }
    .warn-mid{ border-color:var(--orange); box-shadow:0 0 0 2px rgba(243,156,18,.25) inset; }
    .warn-high{ border-color:var(--red); box-shadow:0 0 0 2px rgba(226,85,85,.25) inset; }
    .warn-item{ padding:10px 12px; border-radius:10px; background:#2b313c; border:1px solid var(--border); margin-top:8px; }
    .warn-item .wi-head{ display:flex; justify-content:space-between; gap:8px; font-size:.9rem; color:var(--muted); }
    .warn-item .wi-reason{ margin-top:6px; white-space:pre-wrap; }
    .warn-actions{ display:flex; gap:8px; align-items:center; }
    .warn-global-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }

    .badge-warn{ padding:2px 8px; border-radius:999px; font-size:11px; font-weight:900; line-height:1.6; background:#2E3442; color:#fff; display:inline-block; }
    .badge-warn.mid{ background:var(--orange); color:#111; }
    .badge-warn.high{ background:var(--red); color:#fff; }

    /* === TOPBAR (ic√¥ne courrier) ‚Äî coll√©e au logo === */
    .topbar{
      position:fixed; top:8px; left:50%; transform:translateX(110px);
      z-index:7; display:none; align-items:center; gap:10px;
    }
    .mail-btn{
      position:relative;
      display:inline-flex; align-items:center; justify-content:center;
      width:38px; height:38px; border-radius:999px; border:1px solid var(--glass-br);
      background: rgba(33,36,43,.50); box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.35);
      cursor:pointer; font-size:20px; line-height:1; transition:transform .06s ease, filter .18s ease;
    }
    .mail-btn:active{ transform:scale(.98); }
    .mail-badge{
      position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; padding:0 5px;
      border-radius:999px; background:var(--red); color:#fff; font-size:11px; font-weight:900;
      display:none; align-items:center; justify-content:center; border:2px solid rgba(33,36,43,.85);
    }

    /* === Modale Bo√Æte de r√©ception === */
    #inboxModal{ z-index:65; }
    .inbox-list{ max-height:52vh; overflow:auto; border-top:1px solid var(--border); padding-top:8px; margin-top:6px; }
    .msg-card{ padding:10px 12px; border-radius:10px; background:#2b313c; border:1px solid var(--border); margin-top:8px; }
    .msg-head{ display:flex; justify-content:space-between; gap:10px; font-size:.9rem; color:var(--muted); }
    .msg-title{ font-weight:800; color:var(--text); }
    .msg-actions{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    .badge-unread{ padding:2px 6px; border-radius:999px; background:var(--primary); color:#fff; font-size:11px; font-weight:900; }
    .compose-area{ margin-top:10px; border-top:1px solid var(--border); padding-top:8px; }

    /* === Toasts d'avertissement (haut-droit) === */
    .toast-container{
      position:fixed; top:12px; right:12px; display:flex; flex-direction:column; gap:10px;
      z-index:90; pointer-events:none; /* n'intercepte pas le reste du site */
    }
    .toast{
      pointer-events:auto;
      min-width:280px; max-width:380px;
      background:rgba(243,156,18,.18); border:1px solid rgba(243,156,18,.55);
      color:#fff; border-radius:12px; padding:12px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.25);
      backdrop-filter:blur(12px) saturate(140%); -webkit-backdrop-filter:blur(12px) saturate(140%);
    }
    .toast .t-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .toast .t-title{ font-weight:900; color:#F39C12; font-size:14px; letter-spacing:.2px; }
    .toast .t-close{ cursor:pointer; border:none; background:transparent; color:#fff; font-size:18px; line-height:1; }
    .toast .t-body{ margin-top:6px; font-size:13.2px; white-space:pre-wrap; }

    @media (max-width: 1080px){
      body{ padding-left:0; padding-right:0; }
      .overlay{ width:100%; height:46%; inset:auto 0 0 0; border-right:none; border-top:1px solid var(--border); border-radius:0; }
      .panel-right{ width:100%; height:48%; inset:0 0 auto 0; border-left:none; border-bottom:1px solid var(--border); border-radius:0; }
      .site-logo img{ height:28px; }
      .logo-big{ width:120px; }
      .topbar{ left:auto; right:12px; transform:none; top:8px; }
    }
  </style>
</head>
<body>
  <div class="site-logo" aria-hidden="true"><img src="logo.png" alt="Logo"></div>

  <!-- TOPBAR (ic√¥ne courrier visible pour admin/technicien) -->
  <div class="topbar" id="topbar">
    <button class="mail-btn" id="mailBtn" title="Bo√Æte de r√©ception">üì¨
      <span class="mail-badge" id="mailBadge"></span>
    </button>
  </div>

  <!-- OVERLAY gauche -->
  <aside class="overlay glass" id="overlay">
    <h3>Joueurs</h3>
    <div class="list" id="playersList"></div>
    <div class="hint-sm">Clique un pseudo pour voir son profil</div>
  </aside>

  <!-- PANNEAU DROIT patients -->
  <aside class="panel-right glass" id="panelRight" style="display:none;">
    <h3>Patients</h3>
    <div class="actions" id="panelRightActions" style="display:none;">
      <button class="btn-lite" id="btnNewPatient">‚ûï Nouvelle fiche patient</button>
    </div>
    <div class="search"><input id="patientSearch" placeholder="Rechercher (nom, pr√©nom)‚Ä¶"></div>
    <div class="list" id="patientList"></div>
  </aside>

  <!-- ACCUEIL / LOGIN -->
  <div class="box" id="pseudoBox">
    <img class="logo-big" src="logo.png" alt="Logo">
    <h2>Identification</h2>
    <input class="main" id="pseudoInput" placeholder="Entrez un pseudo" required>
    <button class="main" id="pseudoBtn">Continuer</button>
    <div id="passwordArea" style="display:none; margin-top:.5rem;">
      <label id="pwdLabel" for="passwordInput" style="display:block; text-align:left; font-size:.95rem; margin:.25rem 0;">Mot de passe</label>
      <input class="main" id="passwordInput" type="password" placeholder="Mot de passe">
      <button class="main" id="passwordBtn">Valider</button>
      <button class="mutelink" id="changePseudoBtn" type="button">Changer de pseudo</button>
    </div>
    <p id="message" class="msg"></p>
  </div>

  <!-- SERVICE -->
  <div class="box" id="serviceBox" style="display:none;">
    <h2 id="welcome"></h2>
    <div id="timer" class="timer">0h00</div>
    <div class="subtle">(heures et minutes, persistant au rechargement)</div>
    <div class="row" style="margin-top:10px;">
      <button class="btn start" id="startBtn" onclick="startService()">üöÄ D√©but</button>
      <button class="btn end" id="endBtn" onclick="endService()">‚èπÔ∏è Fin</button>
    </div>
    <div class="grid">
      <div class="card"><div class="label">Pseudo</div><div class="value" id="statPseudo">-</div></div>
      <div class="card"><div class="label">R√¥le</div><div class="value" id="statRole">-</div></div>
      <div class="card"><div class="label">Compte cr√©√© le</div><div class="value" id="statCreated">-</div></div>
      <div class="card"><div class="label">Temps total</div><div class="value" id="statTotal">0h00</div></div>
      <div class="card"><div class="label">Temps semaine (lun-dim)</div><div class="value" id="statWeek">0h00</div></div>
    </div>
    <button class="btn home" style="margin-top:12px;" onclick="goHome()" id="homeBtn">üè† Accueil</button>
    <p id="status" class="msg"></p>
  </div>

  <!-- ADMIN -->
  <div class="admin-box" id="adminBox" style="display:none;">
    <div class="admin-header">
      <div class="admin-title">üëë Panneau d‚Äôadministration</div>
      <div class="admin-actions">
        <button class="btn-sm" onclick="goHome()">üè† Accueil</button>
        <button class="btn-sm danger" onclick="deleteAllUsers()">üóëÔ∏è Supprimer tous les joueurs</button>
      </div>
    </div>
    <div style="overflow:auto; max-height:70vh;">
      <table id="adminTable">
        <thead><tr>
          <th>Pseudo</th><th>R√¥le</th><th>Statut</th><th>Timer actuel</th><th>Total cumul√©</th><th>Avertissements</th><th>Cr√©√© le</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
    <div class="admin-actions" id="logsBar" style="margin-top:10px; display:none;">
      <button class="btn-sm" id="openLogsBtn">üìú Logs</button>
      <span class="subtle" style="font-size:12px;">Historique des 24 derni√®res heures</span>
    </div>


  <!-- PROFIL JOUEUR -->
  <div class="modal-backdrop" id="profileModal">
    <div class="modal">
      <h3 id="pf_title">üë§ Profil joueur</h3>
      <div class="grid" style="margin-top:6px;">
        <div class="card"><div class="label">Pseudo</div><div class="value" id="pf_pseudo">-</div></div>
        <div class="card"><div class="label">R√¥le</div><div class="value" id="pf_role">-</div></div>
        <div class="card" id="pf_roleEditor" style="display:none;">
          <div class="label">Changer le r√¥le</div>
          <select class="main" id="pf_roleSelect">
            <option value="new">new</option>
            <option value="certifi√©">certifi√©</option>
            <option value="technicien">technicien</option>
          </select>
          <div class="subtle">üí° Visible pour technicien / admin.</div>
        </div>
        <div class="card"><div class="label">Cr√©√© le</div><div class="value" id="pf_created">-</div></div>
        <div class="card"><div class="label">Statut</div><div class="value" id="pf_status">-</div></div>
        <div class="card"><div class="label">Timer actuel</div><div class="value" id="pf_current">0h00</div></div>
        <div class="card"><div class="label">Semaine</div><div class="value" id="pf_week">0h00</div></div>
        <div class="card"><div class="label">Total cumul√©</div><div class="value" id="pf_total">0h00</div></div>
        <div class="card"><div class="label">Fiches cr√©√©es</div><div class="value" id="pf_createdCount">0</div></div>
        <div class="card"><div class="label">Fiches modifi√©es</div><div class="value" id="pf_modifiedCount">0</div></div>
        <div class="card warn-card" id="pf_warnCard" title="">
          <div class="label" id="pf_warnLabel">Avertissements</div>
          <div class="value" id="pf_warnCount">0</div>
          <div class="subtle" id="pf_warnHint" style="display:none;">Cliquer pour voir l‚Äôhistorique</div>
        </div>
      </div>
      <div class="actions">
        <button class="main end" id="pf_forceEndBtn">‚èπÔ∏è Finir son service</button>
        <button class="main" style="background:#3B4250" id="pf_closeBtn">Fermer</button>
      </div>
      <div id="pf_msg" class="msg"></div>
    </div>
  </div>

  <!-- MODALES existantes -->
  <div class="modal-backdrop" id="endReasonModal">
    <div class="modal">
      <h3 id="er_title">üìù Terminer le service</h3>
      <div class="row2">
        <textarea class="main" id="er_reason" rows="4" placeholder="Raison (obligatoire)"></textarea>
        <div>
          <label class="label" for="er_warning">Avertissement</label>
          <select class="main" id="er_warning">
            <option value="no">Non</option>
            <option value="yes">Oui</option>
          </select>
          <div class="subtle">Enregistr√© avec la session.</div>
        </div>
      </div>
      <div class="actions">
        <button class="main end" id="er_confirmBtn">Valider et terminer</button>
        <button class="main" style="background:#3B4250" id="er_cancelBtn">Annuler</button>
      </div>
      <div id="er_msg" class="msg"></div>
    </div>
  </div>

  <div class="modal-backdrop" id="warnHistoryModal">
    <div class="modal">
      <h3 id="wh_title">üìí Historique des avertissements</h3>
      <div id="wh_list"></div>
      <div class="warn-global-actions" id="wh_global" style="display:none;">
        <button class="main end" id="wh_deleteAllBtn">üóëÔ∏è Supprimer tous</button>
      </div>
      <div class="actions">
        <button class="main" style="background:#3B4250" id="wh_closeBtn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- MODALE : NOUVELLE FICHE PATIENT -->
  <div class="modal-backdrop" id="patientModal">
    <div class="modal">
      <h3>‚ûï Nouvelle fiche patient</h3>
      <h4 style="margin:.4rem 0 .2rem">Informations patient</h4>
      <div class="row3">
        <input class="main" id="np_nom" placeholder="Nom *">
        <input class="main" id="np_prenom" placeholder="Pr√©nom *">
        <select class="main" id="np_sexe">
          <option value="">Sexe</option>
          <option>H</option>
          <option>F</option>
          <option>Autre</option>
        </select>
      </div>
      <div class="row3">
        <input class="main" id="np_dob" type="date" placeholder="Date de naissance">
        <input class="main" id="np_age" type="number" min="0" placeholder="√Çge" disabled>
        <input class="main" id="np_tel" placeholder="T√©l√©phone">
      </div>
      <div class="row3">
        <input class="main" id="np_taille" type="number" step="0.1" placeholder="Taille (cm)">
        <input class="main" id="np_poid" type="number" step="0.1" placeholder="Poids (kg)">
        <select class="main" id="np_groupe">
          <option value="">Groupe sanguin</option>
          <option>O+</option><option>O-</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </div>
      <textarea class="main" id="np_allergies" rows="2" placeholder="Allergies"></textarea>

      <h4 style="margin:.8rem 0 .2rem">Commentaire</h4>
      <textarea class="main" id="np_commentaire" rows="5" placeholder="Commentaire (libre)‚Ä¶"></textarea>

      <h4 style="margin:.8rem 0 .2rem">Fiche bilan</h4>
      <div class="row3">
        <input class="main" id="np_staff" placeholder="Personnel en charge">
        <input class="main" id="np_nature" placeholder="Nature de la blessure">
        <input class="main" id="np_typeBlessure" placeholder="Type de blessure">
      </div>
      <div class="row3">
        <select class="main" id="np_gravite">
          <option value="">Gravit√©</option>
          <option>Faible</option><option>Moyenne</option><option>√âlev√©e</option><option>Critique</option>
        </select>
        <input class="main" id="np_soins" placeholder="Soins prodigu√©s (court)">
        <input class="main" id="np_prise" placeholder="Type de prise en charge">
      </div>
      <div class="row3">
        <select class="main" id="np_irm"><option value="">IRM</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="np_scanner"><option value="">Scanner</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="np_operation"><option value="">Op√©ration</option><option>Non</option><option>Oui</option></select>
      </div>

      <div class="actions">
        <button class="main" id="btnSavePatient">Enregistrer</button>
        <button class="main" style="background:#3B4250" id="btnCancelPatient">Annuler</button>
      </div>
      <div id="patientMsg" class="msg"></div>
    </div>
  </div>

  <!-- MODALE : D√âTAILS / MODIF PATIENT -->
  <div class="modal-backdrop" id="patientDetailsModal">
    <div class="modal">
      <h3 id="pd_title">üë§ D√©tails du patient</h3>

      <h4 style="margin:.4rem 0 .2rem">Informations patient</h4>
      <div class="row3">
        <input class="main" id="pd_nom" placeholder="Nom *" disabled>
        <input class="main" id="pd_prenom" placeholder="Pr√©nom *" disabled>
        <select class="main" id="pd_sexe" disabled>
          <option value="">Sexe</option>
          <option>H</option>
          <option>F</option>
          <option>Autre</option>
        </select>
      </div>
      <div class="row3">
        <input class="main" id="pd_dob" type="date" placeholder="Date de naissance" disabled>
        <input class="main" id="pd_age" type="number" min="0" placeholder="√Çge" disabled>
        <input class="main" id="pd_tel" placeholder="T√©l√©phone" disabled>
      </div>
      <div class="row3">
        <input class="main" id="pd_taille" type="number" step="0.1" placeholder="Taille (cm)" disabled>
        <input class="main" id="pd_poid" type="number" step="0.1" placeholder="Poids (kg)" disabled>
        <select class="main" id="pd_groupe" disabled>
          <option value="">Groupe sanguin</option>
          <option>O+</option><option>O-</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </div>
      <textarea class="main" id="pd_allergies" rows="2" placeholder="Allergies" disabled></textarea>

      <h4 style="margin:.8rem 0 .2rem">Commentaire</h4>
      <textarea class="main" id="pd_commentaire" rows="5" placeholder="Commentaire (libre)‚Ä¶" disabled></textarea>

      <h4 style="margin:.8rem 0 .2rem">Fiche bilan</h4>
      <div class="row3">
        <input class="main" id="pd_staff" placeholder="Personnel en charge" disabled>
        <input class="main" id="pd_nature" placeholder="Nature de la blessure" disabled>
        <input class="main" id="pd_typeBlessure" placeholder="Type de blessure" disabled>
      </div>
      <div class="row3">
        <select class="main" id="pd_gravite" disabled>
          <option value="">Gravit√©</option>
          <option>Faible</option><option>Moyenne</option><option>√âlev√©e</option><option>Critique</option>
        </select>
        <input class="main" id="pd_soins" placeholder="Soins prodigu√©s (court)" disabled>
        <input class="main" id="pd_prise" placeholder="Type de prise en charge" disabled>
      </div>
      <div class="row3">
        <select class="main" id="pd_irm" disabled><option value="">IRM</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="pd_scanner" disabled><option value="">Scanner</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="pd_operation" disabled><option value="">Op√©ration</option><option>Non</option><option>Oui</option></select>
      </div>

      <h4 style="margin:.8rem 0 .2rem">M√©tadonn√©es</h4>
      <div class="row3">
        <div class="card"><div class="label">Cr√©√©e par</div><div class="value" id="pd_metaCreatedBy">‚Äî</div></div>
        <div class="card"><div class="label">Cr√©√©e le</div><div class="value" id="pd_metaCreatedAt">‚Äî</div></div>
        <div class="card"><div class="label">Derni√®re modification</div><div class="value">
          <span id="pd_metaModifiedBy">‚Äî</span><span class="subtle"> ¬∑ </span><span id="pd_metaModifiedAt">‚Äî</span>
        </div></div>
      </div>

      <div class="actions">
        <button class="main" id="pd_editBtn">‚úèÔ∏è Modifier</button>
        <button class="main" id="pd_saveBtn" style="display:none;">üíæ Enregistrer</button>
        <button class="main end" id="pd_deleteBtn" style="display:none;">üóëÔ∏è Supprimer</button>
        <button class="main" style="background:#3B4250" id="pd_closeBtn">Fermer</button>
      </div>
      <div id="pd_msg" class="msg"></div>
    </div>
  </div>

  
  <!-- MODALE : LOGS -->
  <div class="modal-backdrop" id="logsModal">
    <div class="modal" style="width:min(92vw, 820px); max-height:92vh; display:flex; flex-direction:column;">
      <h3>üìú Logs (24h)</h3>
      <div class="subtle" style="margin-bottom:8px;">Mise √† jour en continu ‚Ä¢ purge automatique au-del√† de 24h</div>
      <div class="row2" style="grid-template-columns: 2fr 1fr; gap:12px;">
        <div id="logsText" class="logbox"></div>
        <div id="logsTimes" class="logbox"></div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="main" style="background:#3B4250" id="logsCloseBtn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- MODALE : ACC√àS ADMIN -->
  <div class="modal-backdrop" id="adminGateModal">
    <div class="modal" style="width:min(92vw, 520px)">
      <h3>üîê Acc√®s administrateur</h3>
      <label for="adminPwd" style="display:block; text-align:left; font-size:.95rem; margin:.25rem 0;">Mot de passe</label>
      <input class="main" id="adminPwd" type="password" placeholder="Mot de passe admin">
      <div id="adminGateMsg" class="msg" style="margin-top:.5rem;"></div>
      <div class="actions">
        <button class="main" style="background:#3B4250" id="adminGateCancel">Annuler</button>
        <button class="main" id="adminGateOk">Se connecter</button>
      </div>
    </div>
  </div>
<!-- MODALE : BO√éTE DE R√âCEPTION COMMUNE -->
  <div class="modal-backdrop" id="inboxModal">
    <div class="modal" style="width:min(92vw, 820px); max-height:84vh; display:flex; flex-direction:column;">
      <h3>üì¨ Bo√Æte de r√©ception</h3>
      <div class="inbox-list" id="inboxList"></div>

      <div class="compose-area" id="composeArea" style="display:none;">
        <h4 style="margin:.6rem 0 .2rem">Nouveau message</h4>
        <input class="main" id="in_subject" placeholder="Sujet *">
        <textarea class="main" id="in_body" rows="4" placeholder="Message *"></textarea>
        <div class="actions">
          <button class="main" id="in_sendBtn">Envoyer</button>
          <button class="main" style="background:#3B4250" id="in_cancelBtn">Annuler</button>
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="main" id="in_newBtn" style="display:none;">‚úâÔ∏è Nouveau</button>
        <button class="main" style="background:#3B4250" id="in_closeBtn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- CONTENEUR DE TOASTS (persistant, non bloquant) -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<script>
  /* ====== CL√âS & √âTAT ====== */
  const ADMIN_NAME = "admin";
  const PSEUDOS_KEY = "pseudos";
  const ACTIVE_PSEUDO_KEY = "activePseudo";
  const userKey  = p => `user:${p}`;
  const startKey = p => `serviceStart:${p}`;
  const totalKey = p => `serviceTotalMs:${p}`;
  const sessionsKey = p => `serviceSessions:${p}`;
  const PATIENTS_KEY = "patients";

  /* ====== Inbox (commune) ====== */
  const INBOX_KEY = "inboxMessages"; // [{id,subject,body,from,createdAt,readBy:[], type?, target?}]

  // ====== S√©lecteurs DOM ======
  const playersList       = document.getElementById('playersList');

  const panelRight        = document.getElementById('panelRight');
  const panelRightActions = document.getElementById('panelRightActions');
  const patientList       = document.getElementById('patientList');

  const pseudoBox  = document.getElementById('pseudoBox');
  const serviceBox = document.getElementById('serviceBox');
  const adminBox   = document.getElementById('adminBox');

  const welcome = document.getElementById('welcome');
  const timer   = document.getElementById('timer');
  const status  = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');
  const endBtn   = document.getElementById('endBtn');
  const homeBtn  = document.getElementById('homeBtn');

  const statPseudo  = document.getElementById('statPseudo');
  const statRole    = document.getElementById('statRole');
  const statCreated = document.getElementById('statCreated');
  const statTotal   = document.getElementById('statTotal');
  const statWeek    = document.getElementById('statWeek');

  const profileModal    = document.getElementById('profileModal');
  const endReasonModal  = document.getElementById('endReasonModal');
  // S√©lecteurs modale "fin de service"
  const er_title      = document.getElementById('er_title');
  const er_reason     = document.getElementById('er_reason');
  const er_warning    = document.getElementById('er_warning');
  const er_msg        = document.getElementById('er_msg');
  const er_cancelBtn  = document.getElementById('er_cancelBtn');
  const er_confirmBtn = document.getElementById('er_confirmBtn');

  /* Topbar / Inbox */
  const topbar     = document.getElementById('topbar');
  const mailBtn    = document.getElementById('mailBtn');
  const mailBadge  = document.getElementById('mailBadge');

  const inboxModal = document.getElementById('inboxModal');
  const inboxList  = document.getElementById('inboxList');

  const in_newBtn   = document.getElementById('in_newBtn');
  const in_closeBtn = document.getElementById('in_closeBtn');
  const composeArea = document.getElementById('composeArea');
  const in_subject  = document.getElementById('in_subject');
  const in_body     = document.getElementById('in_body');
  const in_sendBtn  = document.getElementById('in_sendBtn');
  const in_cancelBtn= document.getElementById('in_cancelBtn');

  const ADMIN_CRED_KEY = "admin:password";
  const ADMIN_THROTTLE_KEY = "loginThrottle:admin";

  async function pbkdf2Hash(pwd, salt, iterations=120000){
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits({ name:'PBKDF2', hash:'SHA-256', salt: enc.encode(salt), iterations }, key, 256);
    return [...new Uint8Array(bits)].map(b=>b.toString(16)).map(h=>h.padStart(2,'0')).join('');
  }
  function randomSalt(len=16){
    const a = new Uint8Array(len);
    crypto.getRandomValues(a);
    return [...a].map(b=>b.toString(16)).join('');
  }

  function canAttemptAdmin(){
    try{
      const s = JSON.parse(localStorage.getItem(ADMIN_THROTTLE_KEY) || "{}");
      return !s.until || Date.now() > s.until;
    }catch{ return true; }
  }
  function registerAdminFail(){
    let s; try{ s = JSON.parse(localStorage.getItem(ADMIN_THROTTLE_KEY) || "{}"); }catch{ s = {}; }
    s.count = (s.count||0)+1;
    if(s.count >= 5){ s.until = Date.now() + 60_000; s.count = 0; }
    localStorage.setItem(ADMIN_THROTTLE_KEY, JSON.stringify(s));
  }
  function registerAdminSuccess(){ localStorage.removeItem(ADMIN_THROTTLE_KEY); }

  const ROLE_NEW = "new";
  const ROLE_CERTIFIE = "certifi√©";
  const ROLE_TECH = "technicien";
  const ROLES = [ROLE_NEW, ROLE_CERTIFIE, ROLE_TECH];

  let pseudos = JSON.parse(localStorage.getItem(PSEUDOS_KEY)) || [];
  let patients = JSON.parse(localStorage.getItem(PATIENTS_KEY) || "[]");
  let currentPseudo = null, startTimeMs = null, tickHandle = null;
  let mode = null;
  let adminTickHandle = null;
  let profileTickHandle = null;
  let currentPatientId = null;
  let profileTarget = null;
  let warnHistoryState = null;

  /* ====== Utils ====== */
  const msToHM = ms => { const t=Math.floor(ms/60000), h=Math.floor(t/60), m=t%60; return [h,m]; };
  const formatHM = (h,m) => `${h}h${String(m).padStart(2,"0")}`;
  const setTimer = ms => { const [h,m]=msToHM(Math.max(0,ms)); timer.textContent = formatHM(h,m); };
  async function hash(text){ const enc=new TextEncoder().encode(text); const buf=await crypto.subtle.digest("SHA-256",enc); return [...new Uint8Array(buf)].map(b=>b.toString(16)).join(""); }
  const getTotalMs = p => parseInt(localStorage.getItem(totalKey(p)) || "0", 10);
  const setTotalMs = (p,ms) => localStorage.setItem(totalKey(p), String(ms));
  const getSessions = p => JSON.parse(localStorage.getItem(sessionsKey(p)) || "[]");
  const setSessions = (p,arr) => localStorage.setItem(sessionsKey(p), JSON.stringify(arr));
  const nowISO = () => new Date().toISOString();

  function getUserData(p){ return JSON.parse(localStorage.getItem(userKey(p)) || "{}"); }
  function setUserData(p, data){ localStorage.setItem(userKey(p), JSON.stringify(data)); }
  function getUserRole(p){ const u=getUserData(p); return u.role || ROLE_NEW; }
  function setUserRole(p,role){ const u=getUserData(p); u.role=role; setUserData(p,u); }

  /* ====== Permissions ====== */
  const isAdmin = ()=> currentPseudo === ADMIN_NAME;
  const canCreatePatients = () => {
    if (!currentPseudo) return false;
    if (isAdmin()) return true;
    const r = getUserRole(currentPseudo);
    return r === ROLE_CERTIFIE || r === ROLE_TECH;
  };
  // Modifier = admin + technicien (PAS "certifi√©")
const canModifyPatients = () => {
  if (!currentPseudo) return false;
  if (isAdmin()) return true;
  return getUserRole(currentPseudo) === ROLE_TECH;
};
// Supprimer = ADMIN uniquement
const canDeletePatients = () => isAdmin();
  const canForceEndOther = () => {
    if (!currentPseudo) return false;
    if (isAdmin()) return true;
    const r = getUserRole(currentPseudo);
    return r === ROLE_TECH;
  };
  // Affichage du bouton "Finir son service" : visible uniquement pour ADMIN & TECH
  const canSeeForceEndBtn = () => {
    if (!currentPseudo) return false;
    if (isAdmin()) return true;
    return getUserRole(currentPseudo) === ROLE_TECH;
  };

  const canEditRoles = () => {
    if(!currentPseudo) return false;
    const r = getUserRole(currentPseudo);
    return r === ROLE_TECH || isAdmin();
  };
  const canViewWarnings = () => {
    if (!currentPseudo) return false;
    return isAdmin() || getUserRole(currentPseudo) === ROLE_TECH;
  };

  /* ====== S√©lecteurs avertissements ====== */
  const warnHistoryModal = document.getElementById('warnHistoryModal');
  const wh_title = document.getElementById('wh_title');
  const wh_closeBtn = document.getElementById('wh_closeBtn');

  /* ====== S√©lecteurs profil ====== */
  const pf_title = document.getElementById('pf_title');
  const pf_pseudo = document.getElementById('pf_pseudo');
  const pf_role = document.getElementById('pf_role');
  const pf_roleEditor = document.getElementById('pf_roleEditor');
  const pf_roleSelect = document.getElementById('pf_roleSelect');
  if (pf_roleSelect) {
    pf_roleSelect.addEventListener("change", () => {
      if (!profileTarget) return;
      if (!canEditRoles() || profileTarget === ADMIN_NAME) return;
      const allowed = new Set(ROLES);
      const newRole = allowed.has(pf_roleSelect.value) ? pf_roleSelect.value : ROLE_NEW;
      setUserRole(profileTarget, newRole);
      pf_role.textContent = newRole;
      pf_roleSelect.value = newRole;
      buildAdminTable();
      renderOverlay();
      showPatientPanel(true);
      if (currentPseudo === profileTarget) {
        renderAccountStats();
        showPatientPanel(true);
      }
      updateTopbar();
    });
  }

  const pf_created = document.getElementById('pf_created');
  const pf_status = document.getElementById('pf_status');
  const pf_current = document.getElementById('pf_current');
  const pf_week = document.getElementById('pf_week');
  const pf_total = document.getElementById('pf_total');
  const pf_createdCount = document.getElementById('pf_createdCount');
  const pf_modifiedCount = document.getElementById('pf_modifiedCount');
  const pf_warnCard = document.getElementById('pf_warnCard');
  const pf_warnHint = document.getElementById('pf_warnHint');
  const pf_warnCount = document.getElementById('pf_warnCount');
  const pf_forceEndBtn = document.getElementById('pf_forceEndBtn');

  /* ====== Login: refs + √©v√©nements ====== */
  const pseudoInput     = document.getElementById('pseudoInput');
  const pseudoBtn       = document.getElementById('pseudoBtn');
  const passwordInput   = document.getElementById('passwordInput');
  const passwordBtn     = document.getElementById('passwordBtn');
  const passwordArea    = document.getElementById('passwordArea');
  const message         = document.getElementById('message');
  const pwdLabel        = document.getElementById('pwdLabel');
  const changePseudoBtn = document.getElementById('changePseudoBtn');

  // Actions boutons
  pseudoBtn   && pseudoBtn.addEventListener('click', enterPseudoFlow);
  passwordBtn && passwordBtn.addEventListener('click', submitPassword);

  // Entr√©e pour valider
  pseudoInput && pseudoInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') enterPseudoFlow();
  });
  passwordInput && passwordInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter') submitPassword();
  });

  /* ====== Semaine courante ====== */
  function currentWeekRange(){
    const now=new Date(), d=new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const day=d.getDay(), diffToMonday=(day===0)?6:(day-1);
    const monday=new Date(d); monday.setDate(d.getDate()-diffToMonday);
    const start=new Date(monday.getFullYear(), monday.getMonth(), monday.getDate(),0,0,0,0);
    const end=new Date(start); end.setDate(start.getDate()+7); end.setMilliseconds(-1);
    return [start.getTime(), end.getTime()];
  }
  const overlapMs = (a1,a2,b1,b2)=>Math.max(0, Math.min(a2,b2)-Math.max(a1,b1));
  function calcWeekMs(p){
    const [wStart,wEnd]=currentWeekRange(); const now=Date.now();
    return getSessions(p).reduce((sum,s)=>{
      const st=typeof s.start==="number"?s.start:Date.parse(s.start);
      const en=s.end==null?now:(typeof s.end==="number"?s.end:Date.parse(s.end));
      if(isNaN(st)) return sum;
      return sum + overlapMs(st,en,wStart,wEnd);
    },0);
  }

  /* ====== Overlay statut ====== */
  function overlayStatusText(p){
    const start = localStorage.getItem(startKey(p));
    if(!start) return "Hors service";
    const elapsed = Date.now() - parseInt(start,10);
    const [h,m] = msToHM(elapsed);
    return `En service depuis ${formatHM(h,m)}`;
  }
  function updateOverlayTimers(){
    document.querySelectorAll("#playersList .player").forEach(row=>{
      const p = row.dataset.player;
      const st = row.querySelector(".status");
      if(!p || !st) return;
      const inSvc = !!localStorage.getItem(startKey(p));
      st.textContent = overlayStatusText(p);
      st.classList.toggle("green", inSvc);
    });
  }

  /* ====== Overlay joueurs ====== */
  function renderOverlay(){
    playersList.innerHTML = "";
    const sorted=[...pseudos].sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
    if(!sorted.length){
      playersList.innerHTML="<div class='hint-sm' style='padding:12px;'>Aucun joueur</div>";
      return;
    }
    for(const p of sorted){
      const inSvc = !!localStorage.getItem(startKey(p));
      const isAct = currentPseudo===p;
      const role = getUserRole(p);
      const row=document.createElement("div");
      row.className="player"+(isAct?" active":"");
      row.dataset.player = p;
      row.innerHTML = `
        <div class="head">
          <div class="name">${p}</div>
          <div class="role-pill ${roleClass(role)}" title="R√¥le">${role}</div>
        </div>
        <div class="status ${inSvc ? "green" : ""}">${overlayStatusText(p)}</div>
      `;
      row.onclick = ()=>handleOverlayClick(p);
      playersList.appendChild(row);
    }
  }
  function roleClass(role){ if(role===ROLE_CERTIFIE) return "role-certifie"; if(role===ROLE_TECH) return "role-technicien"; return "role-new"; }
  function handleOverlayClick(target){
    if(target === ADMIN_NAME){ promptLoginFor(target); return; }
    if(currentPseudo){ openPlayerProfile(target); }
    else { promptLoginFor(target); }
  }

  /* ====== Patients : utils ====== */
  function uniquePeopleFromPatients(list){
    const map = new Map();
    for(const p of list){
      const key = `${(p.nom||'').trim().toLowerCase()}|${(p.prenom||'').trim().toLowerCase()}`;
      if(!map.has(key)){
        map.set(key, { nom:p.nom||'', prenom:p.prenom||'', count:0, last:p });
      }
      const slot = map.get(key);
      slot.count++;
      const lastTime = new Date(slot.last?.lastModifiedAt || slot.last?.createdAt || 0).getTime();
      const curTime  = new Date(p.lastModifiedAt || p.createdAt || 0).getTime();
      if(curTime > lastTime) slot.last = p;
    }
    return [...map.values()];
  }
  function peopleNameMatches(nom, prenom){
    const n = (nom||'').trim().toLowerCase();
    const pr = (prenom||'').trim().toLowerCase();
    return patients
      .filter(p=>{
        const pn = (p.nom||'').trim().toLowerCase();
        const ppr= (p.prenom||'').trim().toLowerCase();
        if(n && pr) return pn===n && ppr===pr;
        if(n && !pr) return pn===n;
        if(!n && pr) return ppr===pr;
        return false;
      })
      .sort((a,b)=>{
        const ta = new Date(a.lastModifiedAt || a.createdAt || 0).getTime();
        const tb = new Date(b.lastModifiedAt || b.createdAt || 0).getTime();
        return tb - ta;
      });
  }

  // Datalist (suggestions)
  let dlNames, dlFirstnames;
  function ensureDatalists(){
    if(!dlNames){
      dlNames = document.createElement('datalist');
      dlNames.id = 'namesDatalist';
      document.body.appendChild(dlNames);
      const nomInput = document.getElementById('np_nom');
      if (nomInput) nomInput.setAttribute('list','namesDatalist');
    }
    if(!dlFirstnames){
      dlFirstnames = document.createElement('datalist');
      dlFirstnames.id = 'firstnamesDatalist';
      document.body.appendChild(dlFirstnames);
      const prenomInput = document.getElementById('np_prenom');
      if (prenomInput) prenomInput.setAttribute('list','firstnamesDatalist');
    }
  }
  function refreshDatalists(){
    ensureDatalists();
    const people = uniquePeopleFromPatients(patients);
    const uniqNoms = [...new Set(people.map(p => (p.nom||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
    dlNames.innerHTML = uniqNoms.map(n => `<option value="${n}">`).join('');
    const uniqPrenoms = [...new Set(people.map(p => (p.prenom||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
    dlFirstnames.innerHTML = uniqPrenoms.map(n => `<option value="${n}">`).join('');
  }

  // Pr√©-remplissage identit√© si match
  function prefillFromExistingIfMatch(){
    const nom = (np_nom?.value||'').trim();
    const prenom = (np_prenom?.value||'').trim();
    if(!nom && !prenom) return;

    let matches = peopleNameMatches(nom, prenom);
    if(!matches.length && nom && !prenom){
      const uniqueByNom = uniquePeopleFromPatients(patients).filter(x => (x.nom||'').trim().toLowerCase() === nom.toLowerCase());
      if(uniqueByNom.length === 1) matches = [uniqueByNom[0].last];
    }
    if(!matches.length) return;

    const ref = matches[0];
    if(np_sexe)   np_sexe.value   = ref.sexe || '';
    if(np_dob)    np_dob.value    = ref.dob  || '';
    if(np_age)    np_age.value    = computeAgeFromDob(ref.dob) || ref.age || '';
    if(np_tel)    np_tel.value    = ref.tel  || '';
    if(np_taille) np_taille.value = (ref.taille ?? '');
    if(np_poid)   np_poid.value   = (ref.poid ?? '');
    if(np_groupe) np_groupe.value = ref.groupe || '';
    if(np_allergies) np_allergies.value = ref.allergies || '';
    if(np_commentaire) np_commentaire.value = ref.commentaire || '';
  }
// ====== Patients : refs + handlers (AJOUT) ======
// New patient form refs
const np_nom = document.getElementById('np_nom');
const np_prenom = document.getElementById('np_prenom');
const np_sexe = document.getElementById('np_sexe');
const np_dob = document.getElementById('np_dob');
const np_age = document.getElementById('np_age');
const np_tel = document.getElementById('np_tel');
const np_taille = document.getElementById('np_taille');
const np_poid = document.getElementById('np_poid');
const np_groupe = document.getElementById('np_groupe');
const np_allergies = document.getElementById('np_allergies');
const np_commentaire = document.getElementById('np_commentaire');
const np_staff = document.getElementById('np_staff');
const np_nature = document.getElementById('np_nature');
const np_typeBlessure = document.getElementById('np_typeBlessure');
const np_gravite = document.getElementById('np_gravite');
const np_soins = document.getElementById('np_soins');
const np_prise = document.getElementById('np_prise');
const np_irm = document.getElementById('np_irm');
const np_scanner = document.getElementById('np_scanner');
const np_operation = document.getElementById('np_operation');
const btnSavePatient = document.getElementById('btnSavePatient');

// Details modal refs
const pd_title = document.getElementById('pd_title');
const pd_nom = document.getElementById('pd_nom');
const pd_prenom = document.getElementById('pd_prenom');
const pd_sexe = document.getElementById('pd_sexe');
const pd_dob = document.getElementById('pd_dob');
const pd_age = document.getElementById('pd_age');
const pd_tel = document.getElementById('pd_tel');
const pd_taille = document.getElementById('pd_taille');
const pd_poid = document.getElementById('pd_poid');
const pd_groupe = document.getElementById('pd_groupe');
const pd_allergies = document.getElementById('pd_allergies');
const pd_commentaire = document.getElementById('pd_commentaire');
const pd_staff = document.getElementById('pd_staff');
const pd_nature = document.getElementById('pd_nature');
const pd_typeBlessure = document.getElementById('pd_typeBlessure');
const pd_gravite = document.getElementById('pd_gravite');
const pd_soins = document.getElementById('pd_soins');
const pd_prise = document.getElementById('pd_prise');
const pd_irm = document.getElementById('pd_irm');
const pd_scanner = document.getElementById('pd_scanner');
const pd_operation = document.getElementById('pd_operation');
const pd_metaCreatedBy = document.getElementById('pd_metaCreatedBy');
const pd_metaCreatedAt = document.getElementById('pd_metaCreatedAt');
const pd_metaModifiedBy = document.getElementById('pd_metaModifiedBy');
const pd_metaModifiedAt = document.getElementById('pd_metaModifiedAt');
const pd_editBtn = document.getElementById('pd_editBtn');
const pd_saveBtn = document.getElementById('pd_saveBtn');
const pd_deleteBtn = document.getElementById('pd_deleteBtn');
const pd_closeBtn = document.getElementById('pd_closeBtn');
const patientDetailsModal = document.getElementById('patientDetailsModal');

// Helpers stockage (pas de doublon ailleurs)
function loadPatients(){ try{ return JSON.parse(localStorage.getItem(PATIENTS_KEY) || "[]"); }catch{ return []; } }
function savePatients(arr){ localStorage.setItem(PATIENTS_KEY, JSON.stringify(arr)); }
function nextPatientId(){
  const maxId = patients.reduce((m,p)=>Math.max(m, Number.isFinite(+p.id)? +p.id : 0), 0);
  return maxId + 1; // auto-incr√©ment
}

// Auto-√¢ge sur changement DOB
if (np_dob && np_age){
  const updAge = ()=>{ np_age.value = computeAgeFromDob(np_dob.value) || ""; };
  np_dob.addEventListener('input', updAge);
  np_dob.addEventListener('change', updAge);
}

// Pr√©-remplissage identit√© si on tape nom/pr√©nom (ta fonction existe d√©j√†)
if (np_nom) np_nom.addEventListener('change', prefillFromExistingIfMatch);
if (np_prenom) np_prenom.addEventListener('change', prefillFromExistingIfMatch);

// Sauvegarde nouvelle fiche
if (btnSavePatient && !btnSavePatient._wired){
  btnSavePatient._wired = true;
  btnSavePatient.addEventListener('click', ()=>{
    if (!canCreatePatients()) { alert('Droit insuffisant.'); return; }
    const nom = (np_nom?.value||'').trim();
    const prenom = (np_prenom?.value||'').trim();
    const msg = document.getElementById('patientMsg');
    if (!nom || !prenom){
      if (msg){ msg.textContent = "Nom et pr√©nom sont requis."; msg.className="msg error"; }
      return;
    }
    const rec = {
      id: nextPatientId(),
      nom, prenom,
      sexe: np_sexe?.value||'',
      dob: np_dob?.value||'',
      age: np_age?.value||'',
      tel: np_tel?.value||'',
      taille: np_taille?.value? Number(np_taille.value) : '',
      poid: np_poid?.value? Number(np_poid.value) : '',
      groupe: np_groupe?.value||'',
      allergies: np_allergies?.value||'',
      commentaire: np_commentaire?.value||'',
      staff: np_staff?.value||'',
      nature: np_nature?.value||'',
      typeBlessure: np_typeBlessure?.value||'',
      gravite: np_gravite?.value||'',
      soins: np_soins?.value||'',
      prise: np_prise?.value||'',
      irm: np_irm?.value||'',
      scanner: np_scanner?.value||'',
      operation: np_operation?.value||'',
      createdAt: new Date().toISOString(),
      createdBy: currentPseudo || "‚Äî"
    };
    patients.push(rec);
    savePatients(patients);
    if (msg){ msg.textContent = "‚úÖ Fiche enregistr√©e."; msg.className="msg ok"; }
    document.getElementById('patientModal').style.display='none';
    renderPatientList?.();
    openPatientDetails(rec.id);
  });
}

function setDetailsDisabled(disabled){
  [pd_nom,pd_prenom,pd_sexe,pd_dob,pd_age,pd_tel,pd_taille,pd_poid,pd_groupe,pd_allergies,pd_commentaire,
   pd_staff,pd_nature,pd_typeBlessure,pd_gravite,pd_soins,pd_prise,pd_irm,pd_scanner,pd_operation].forEach(el=>{
     if (el) el.disabled = disabled;
   });
}

function fillDetails(p){
  if (pd_title) pd_title.textContent = `üë§ D√©tails du patient ‚Äî ${p.nom||'‚Äî'} ${p.prenom||''}`;
  if (pd_nom) pd_nom.value = p.nom||'';
  if (pd_prenom) pd_prenom.value = p.prenom||'';
  if (pd_sexe) pd_sexe.value = p.sexe||'';
  if (pd_dob) pd_dob.value = p.dob||'';
  if (pd_age) pd_age.value = computeAgeFromDob(p.dob)||p.age||'';
  if (pd_tel) pd_tel.value = p.tel||'';
  if (pd_taille) pd_taille.value = p.taille??'';
  if (pd_poid) pd_poid.value = p.poid??'';
  if (pd_groupe) pd_groupe.value = p.groupe||'';
  if (pd_allergies) pd_allergies.value = p.allergies||'';
  if (pd_commentaire) pd_commentaire.value = p.commentaire||'';
  if (pd_staff) pd_staff.value = p.staff||'';
  if (pd_nature) pd_nature.value = p.nature||'';
  if (pd_typeBlessure) pd_typeBlessure.value = p.typeBlessure||'';
  if (pd_gravite) pd_gravite.value = p.gravite||'';
  if (pd_soins) pd_soins.value = p.soins||'';
  if (pd_prise) pd_prise.value = p.prise||'';
  if (pd_irm) pd_irm.value = p.irm||'';
  if (pd_scanner) pd_scanner.value = p.scanner||'';
  if (pd_operation) pd_operation.value = p.operation||'';
  if (pd_metaCreatedBy) pd_metaCreatedBy.textContent = p.createdBy || '‚Äî';
  if (pd_metaCreatedAt) pd_metaCreatedAt.textContent = p.createdAt ? new Date(p.createdAt).toLocaleString() : '‚Äî';
  if (pd_metaModifiedBy) pd_metaModifiedBy.textContent = p.modifiedBy || '‚Äî';
  if (pd_metaModifiedAt) pd_metaModifiedAt.textContent = p.lastModifiedAt ? new Date(p.lastModifiedAt).toLocaleString() : '‚Äî';
}

// üëâ Fonction manquante dans ton code original
function openPatientDetails(id){
  const p = patients.find(x => String(x.id) === String(id));
  if (!p){ alert('Fiche introuvable.'); return; }
  currentPatientId = p.id;
  fillDetails(p);
  setDetailsDisabled(true);
  if (pd_saveBtn) pd_saveBtn.style.display = 'none';
  if (pd_deleteBtn) pd_deleteBtn.style.display = canDeletePatients() ? 'inline-block' : 'none';
  if (pd_editBtn)   pd_editBtn.style.display   = canModifyPatients() ? 'inline-block' : 'none';
  if (patientDetailsModal) patientDetailsModal.style.display = 'flex';
}

// Actions fiche d√©taill√©e
if (pd_closeBtn) pd_closeBtn.onclick = ()=> { if (patientDetailsModal) patientDetailsModal.style.display='none'; currentPatientId = null; };
if (pd_editBtn) pd_editBtn.onclick = ()=>{
  if (!canModifyPatients()) return;
  setDetailsDisabled(false);
  if (pd_saveBtn) pd_saveBtn.style.display = 'inline-block';
  if (pd_deleteBtn) pd_deleteBtn.style.display = canDeletePatients() ? 'inline-block' : 'none';
  if (pd_editBtn) pd_editBtn.style.display = 'none';
};
if (pd_saveBtn) pd_saveBtn.onclick = ()=>{
  if (currentPatientId==null) return;
  const idx = patients.findIndex(x => String(x.id) === String(currentPatientId));
  if (idx<0) return;
  const p = patients[idx];
  const updated = {
    ...p,
    nom: pd_nom?.value||'',
    prenom: pd_prenom?.value||'',
    sexe: pd_sexe?.value||'',
    dob: pd_dob?.value||'',
    age: pd_age?.value||'',
    tel: pd_tel?.value||'',
    taille: pd_taille?.value? Number(pd_taille.value) : '',
    poid: pd_poid?.value? Number(pd_poid.value) : '',
    groupe: pd_groupe?.value||'',
    allergies: pd_allergies?.value||'',
    commentaire: pd_commentaire?.value||'',
    staff: pd_staff?.value||'',
    nature: pd_nature?.value||'',
    typeBlessure: pd_typeBlessure?.value||'',
    gravite: pd_gravite?.value||'',
    soins: pd_soins?.value||'',
    prise: pd_prise?.value||'',
    irm: pd_irm?.value||'',
    scanner: pd_scanner?.value||'',
    operation: pd_operation?.value||'',
    lastModifiedAt: new Date().toISOString(),
    modifiedBy: currentPseudo || "‚Äî"
  };
  patients[idx] = updated;
  savePatients(patients);
  fillDetails(updated);
  setDetailsDisabled(true);
  if (pd_saveBtn) pd_saveBtn.style.display = 'none';
  if (pd_editBtn) pd_editBtn.style.display = 'inline-block';
  renderPatientList?.();
};
if (pd_deleteBtn) pd_deleteBtn.onclick = ()=>{
    if (!canDeletePatients()) return;
if (currentPatientId==null) return;
  if (!confirm('Supprimer d√©finitivement cette fiche ?')) return;
  patients = patients.filter(x => String(x.id) !== String(currentPatientId));
  savePatients(patients);
  if (patientDetailsModal) patientDetailsModal.style.display='none';
  currentPatientId = null;
  renderPatientList?.();
};

  /* ====== Patients : liste ====== */
  function renderPatientList(filter=""){
    patientList.innerHTML="";
    const f = (filter||"").trim().toLowerCase();

    const people = uniquePeopleFromPatients(patients)
      .filter(p => {
        const full = `${(p.nom||'')} ${(p.prenom||'')}`.trim().toLowerCase();
        return !f || full.includes(f);
      })
      .sort((a,b)=>{
        const an = (a.nom||'').localeCompare(b.nom||'','fr',{sensitivity:'base'});
        return an!==0 ? an : (a.prenom||'').localeCompare(b.prenom||'','fr',{sensitivity:'base'});
      });

    if(!people.length){
      patientList.innerHTML = "<div class='hint-sm' style='padding:10px;'>Aucun patient</div>";
      return;
    }
    for(const person of people){
      const count = person.count;
      const row=document.createElement("div"); row.className="patient-row";
      row.innerHTML=`
        <div class="patient-name">${person.nom || "‚Äî"} ${person.prenom || ""}</div>
        <div class="patient-meta">${count>1 ? (count+" fiches") : (person.last?.sexe || "")}</div>`;
      row.onclick = ()=> openPatientHistory(person.nom, person.prenom);
      patientList.appendChild(row);
    }
  }

  // Modale historique par personne (cr√©ation dynamique)
  let patientHistoryModalEl = null;
  function ensurePatientHistoryModal(){
    if(patientHistoryModalEl) return patientHistoryModalEl;
    const back = document.createElement('div');
    back.className = 'modal-backdrop';
    back.id = 'patientHistoryModal';
    back.innerHTML = `
      <div class="modal" style="max-height:84vh; display:flex; flex-direction:column;">
        <h3 id="ph_title">üóÇÔ∏è Historique du patient</h3>
        <div id="ph_list" style="overflow:auto; border-top:1px solid var(--border); padding-top:8px; margin-top:6px;"></div>
        <div class="actions"><button class="main" style="background:#3B4250" id="ph_closeBtn">Fermer</button></div>
      </div>`;
    document.body.appendChild(back);
    back.querySelector('#ph_closeBtn').onclick = ()=> back.style.display='none';
    patientHistoryModalEl = back;
    return back;
  }
  function openPatientHistory(nom, prenom){
    const modal = ensurePatientHistoryModal();

    if (profileModal && profileModal.style.display === 'flex') {
      profileModal.style.display = 'none';
    }

    const title = modal.querySelector('#ph_title');
    const list  = modal.querySelector('#ph_list');
    const fullName = `${nom||''} ${prenom||''}`.trim();
    title.textContent = `üóÇÔ∏è Historique ‚Äî ${fullName||'(sans nom)'}`;

    const items = peopleNameMatches(nom, prenom);
    if(!items.length){
      list.innerHTML = `<div class="hint-sm" style="padding:8px;">Aucune fiche trouv√©e.</div>`;
    } else {
      list.innerHTML = items.map(p=>{
        const when = new Date(p.lastModifiedAt || p.createdAt || Date.now()).toLocaleString();
        const id = p.id;
        return `
          <div class="warn-item" style="margin-bottom:10px;">
            <div class="wi-head"><span>${when}</span><span>cr√©√©e par <strong>${p.createdBy||'‚Äî'}</strong></span></div>
            <div class="wi-reason" style="margin-top:8px;">
              <div><strong>Sexe:</strong> ${p.sexe||'‚Äî'} &nbsp; <strong>√Çge:</strong> ${p.age||'‚Äî'} &nbsp; <strong>Tel:</strong> ${p.tel||'‚Äî'}</div>
              <div><strong>Taille:</strong> ${p.taille||'‚Äî'} cm &nbsp; <strong>Poids:</strong> ${p.poid||'‚Äî'} kg &nbsp; <strong>GS:</strong> ${p.groupe||'‚Äî'}</div>
              <div><strong>Allergies:</strong> ${p.allergies||'‚Äî'}</div>
              <div><strong>Commentaire:</strong> ${p.commentaire||'‚Äî'}</div>
            </div>
            <div class="warn-actions" style="margin-top:8px;">
              <button class="btn-sm" data-open-id="${id}">üîé Ouvrir la fiche</button>
            </div>
          </div>`;
      }).join('');

      list.querySelectorAll('[data-open-id]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const pid = e.currentTarget.getAttribute('data-open-id');
          openPatientDetails(pid);
          modal.style.display = 'none';
        });
      });
    }

    modal.style.display = 'flex';
  }

  /* ====== Recherche patients ====== */
  const patientSearch = document.getElementById("patientSearch");
  patientSearch && patientSearch.addEventListener("input", ()=>renderPatientList(patientSearch.value));

  function showPatientPanel(show){
    panelRight.style.display = show ? "flex" : "none";
    const showCreate = show && currentPseudo && canCreatePatients();
    panelRightActions.style.display = showCreate ? "flex" : "none";
    if(show) renderPatientList(patientSearch.value);
  }

  /* ====== Vues ====== */
  function setBodyViewClass(v){
    document.body.classList.remove("view-pseudo","view-service","view-admin");
    document.body.classList.add(`view-${v}`);
  }
    function showView(v){
      pseudoBox.style.display  = (v==="pseudo")  ? "block" : "none";
      serviceBox.style.display = (v==="service") ? "block" : "none";
      adminBox.style.display   = (v==="admin")   ? "block" : "none";
      setBodyViewClass(v);
      showPatientPanel((v==="service" || v==="admin") && currentPseudo);
      const hb = document.getElementById('homeBtn'); if(hb){ hb.disabled = false; }
      applyWarningBorder(currentPseudo);
      updateTopbar();
      // üëâ √† chaque changement de vue, on affiche les avertissements en attente pour l‚Äôutilisateur
      renderWarnToastsFor(currentPseudo);
    }
    function enableButtons(running){ startBtn.disabled = running; endBtn.disabled = !running; }

    /* =============================
       TOASTS AVERTISSEMENT (persistants)
       ============================= */
    const toastContainer = document.getElementById('toastContainer');
    const warnDismissedKey = p => `warnDismissed:${p}`; // tableau d'IDs d'avertissements ferm√©s

    // ID stable par avertissement (index de session + timestamp de fin) pour identifier une "r√©cidive" comme un nouveau warn
    function computeWarnId(item){
      const t = item?.date?.getTime?.() || 0;
      return `${item.index}:${t}`;
    }
    function loadDismissedWarnIds(p){
      try{ return JSON.parse(localStorage.getItem(warnDismissedKey(p)) || "[]"); }catch{ return []; }
    }
    function saveDismissedWarnIds(p, arr){
      localStorage.setItem(warnDismissedKey(p), JSON.stringify(Array.from(new Set(arr))));
    }
    function markWarnDismissed(p, warnId){
      const arr = loadDismissedWarnIds(p);
      if(!arr.includes(warnId)){ arr.push(warnId); saveDismissedWarnIds(p, arr); }
    }
    function roleEligibleForWarnToast(role){
      return role === ROLE_NEW || role === ROLE_CERTIFIE;
    }
    function pendingWarnItems(p){
      if(!p) return [];
      const role = getUserRole(p);
      if(!roleEligibleForWarnToast(role)) return [];
      const items = getWarningEventsDetailed(p); // {index,date,reason,by}
      const dismissed = new Set(loadDismissedWarnIds(p));
      return items.filter(it => !dismissed.has(computeWarnId(it)));
    }
    function clearWarnToasts(){
      if(!toastContainer) return;
      toastContainer.innerHTML = "";
    }
    function renderWarnToastsFor(p){
      clearWarnToasts();
      if(!p) return;
      const items = pendingWarnItems(p);
      if(!items.length) return;
      for(const it of items){
        const id = computeWarnId(it);
        const who = it.by || "‚Äî";
        const when = it.date ? it.date.toLocaleString() : "‚Äî";
        const reason = (it.reason || "(sans raison)").trim();
        const wrap = document.createElement('div');
        wrap.className = 'toast glass';
        wrap.setAttribute('data-warn-id', id);
        wrap.innerHTML = `
          <div class="t-head">
            <div class="t-title">‚ö†Ô∏è Attention</div>
            <button class="t-close" title="Fermer" aria-label="Fermer">&times;</button>
          </div>
          <div class="t-body">
            Attention vous avez pris un avertissement de <strong>${who}</strong>
            √† <strong>${when}</strong> pour&nbsp;: ${reason}
          </div>
        `;
        const btn = wrap.querySelector('.t-close');
        btn.addEventListener('click', ()=>{
          markWarnDismissed(p, id); // üëâ m√©morise la fermeture : ne reviendra plus
          wrap.remove();
        });
        toastContainer.appendChild(wrap);
      }
    }

    /* ====== Auth (tes fonctions existantes + int√©gration toasts) ====== */
    function resetPasswordArea(){ passwordArea.style.display="none"; passwordInput.value=""; message.textContent=""; }
    function enterPseudoFlow(){
      const p = pseudoInput.value.trim();
      if(!p){ message.textContent="Entrez un pseudo."; message.className="msg error"; return; }
      if (p.toLowerCase() === ADMIN_NAME) {
        mode = "login"; currentPseudo = ADMIN_NAME;
        pwdLabel.textContent = "Mot de passe admin";
        passwordBtn.textContent = "Se connecter (Admin)";
        passwordArea.style.display = "block";
        passwordInput.focus(); message.textContent = "Acc√®s administrateur"; message.className = "msg"; return;
      }
      if (!pseudos.includes(p)) {
        mode = "create"; currentPseudo = p;
        pwdLabel.textContent = "Choisissez un mot de passe";
        passwordBtn.textContent = "Cr√©er le compte";
        passwordArea.style.display = "block";
        passwordInput.focus(); message.textContent = "Nouveau pseudo : compte √† cr√©er."; message.className = "msg ok";
      } else {
        mode = "login"; currentPseudo = p;
        pwdLabel.textContent = "Entrez votre mot de passe";
        passwordBtn.textContent = "Se connecter";
        passwordArea.style.display = "block";
        passwordInput.focus(); message.textContent = "Pseudo existant : identifiez-vous."; message.className = "msg";
      }
    }

    function postJoinRequestMessage(username){
      createMessage({
        subject: "Nouvelle recrue",
        body: `${username} vient de rejoindre la communaut√©.\nL'acceptez-vous ou pas ? (oui / non)`,
        from: "syst√®me",
        type: "join_request",
        target: username
      });
      updateTopbar();
    }

    async function submitPassword(){
      const pwd = passwordInput.value;
      if(!pwd){ message.textContent="Le mot de passe est requis."; message.className="msg error"; return; }

      if (currentPseudo && currentPseudo.toLowerCase() === ADMIN_NAME) {
        if (!canAttemptAdmin()){
          message.textContent = "Trop d‚Äôessais. R√©essaie dans 1 minute.";
          message.className = "msg error";
          return;
        }
        let adminCred = null;
        try{ adminCred = JSON.parse(localStorage.getItem(ADMIN_CRED_KEY) || "null"); }catch{}
        if (!adminCred) {
          if (!confirm("Aucun mot de passe admin n‚Äôest encore d√©fini. D√©finir celui que tu viens d‚Äôentrer comme mot de passe admin ?")) {
            message.textContent = "D√©finition annul√©e.";
            message.className = "msg";
            return;
          }
          const salt = randomSalt();
          const iterations = 120000;
          const storedHash = await pbkdf2Hash(pwd, salt, iterations);
          const blob = { salt, iterations, hash: storedHash, createdAt: nowISO() };
          localStorage.setItem(ADMIN_CRED_KEY, JSON.stringify(blob));
          registerAdminSuccess();
          message.textContent = "‚úÖ Mot de passe admin d√©fini. Connect√© en tant qu‚Äôadmin.";
          message.className = "msg ok";
          openAdmin();
          resetPasswordArea(); pseudoInput.value = "";
          return;
        }
        const { salt, iterations, hash: stored } = adminCred;
        const calc = await pbkdf2Hash(pwd, salt, iterations);
        if (calc !== stored) {
          registerAdminFail();
          message.textContent = "Mot de passe admin incorrect.";
          message.className = "msg error";
          return;
        }
        registerAdminSuccess();
        message.textContent = "‚úÖ Connect√© en tant qu'admin.";
        message.className = "msg ok";
        openAdmin();
        resetPasswordArea(); pseudoInput.value = "";
        return;
      }

      if (mode === "create") {
        const h = await hash(pwd);
        const data = { passwordHash: h, createdAt: new Date().toISOString(), role: ROLE_NEW };
        localStorage.setItem(userKey(currentPseudo), JSON.stringify(data));
        if(!pseudos.includes(currentPseudo)){ pseudos.push(currentPseudo); localStorage.setItem(PSEUDOS_KEY, JSON.stringify(pseudos)); }
        postJoinRequestMessage(currentPseudo);
        localStorage.setItem(ACTIVE_PSEUDO_KEY, currentPseudo);
        message.textContent = "‚úÖ Compte cr√©√©. Vous √™tes connect√©."; message.className = "msg ok";
        openServiceAfterAuth(); renderOverlay();
      } else if (mode === "login") {
        const raw = localStorage.getItem(userKey(currentPseudo));
        if(!raw){ message.textContent="Compte introuvable."; message.className="msg error"; return; }
        const user = JSON.parse(raw);
        const h = await hash(pwd);
        if (h !== user.passwordHash) { message.textContent = "Mot de passe incorrect."; message.className = "msg error"; return; }
        if(!user.role){ user.role = ROLE_NEW; localStorage.setItem(userKey(currentPseudo), JSON.stringify(user)); }
        localStorage.setItem(ACTIVE_PSEUDO_KEY, currentPseudo);
        message.textContent = "‚úÖ Authentifi√©."; message.className = "msg ok";
        openServiceAfterAuth(); renderOverlay();
      }
    }

    function promptLoginFor(p){
      showView("pseudo");
      pseudoInput.value = p;
      currentPseudo = (p.toLowerCase() === ADMIN_NAME) ? ADMIN_NAME : p;
      mode = "login";
      pwdLabel.textContent = (currentPseudo===ADMIN_NAME) ? "Mot de passe admin" : "Entrez votre mot de passe";
      passwordBtn.textContent = (currentPseudo===ADMIN_NAME) ? "Se connecter (Admin)" : "Se connecter";
      passwordArea.style.display = "block";
      passwordInput.focus();
      message.textContent = (currentPseudo===ADMIN_NAME) ? "Acc√®s administrateur" : "Pseudo existant : identifiez-vous.";
      message.className = "msg";
    }

    function openServiceAfterAuth(){
      welcome.textContent = "Bienvenue " + currentPseudo;
      showView("service");
      renderAccountStats();
      const started = localStorage.getItem(startKey(currentPseudo));
      if (started) {
        startTimeMs = parseInt(started, 10);
        const sess = getSessions(currentPseudo);
        if (!sess.length || sess[sess.length-1].end != null) { sess.push({ start: startTimeMs, end: null }); setSessions(currentPseudo, sess); }
        startTick(); status.textContent = currentPseudo + " est en service ‚úÖ";
      } else { stopTick(); startTimeMs = null; setTimer(0); status.textContent = ""; }
      resetPasswordArea(); pseudoInput.value = "";
      renderOverlay(); showPatientPanel(true);
      const role = getUserRole(currentPseudo);
      if(role === ROLE_NEW){ startBtn.disabled = true; }
      homeBtn.disabled = false;
      applyWarningBorder(currentPseudo);
      updateTopbar();
      renderWarnToastsFor(currentPseudo); // üëâ affiche les warns en attente
    }

    /* ====== Inbox helpers (inchang√©) ====== */
    const loadInbox = ()=> {
      try { return JSON.parse(localStorage.getItem(INBOX_KEY) || "[]"); }
      catch { return []; }
    };
    const saveInbox = (arr)=> localStorage.setItem(INBOX_KEY, JSON.stringify(arr));
    function canSeeInbox(){
      if(!currentPseudo) return false;
      return isAdmin() || getUserRole(currentPseudo) === ROLE_TECH;
    }
    function unreadCountFor(user){
      const msgs = loadInbox();
      return msgs.reduce((n,m)=> n + (m.readBy?.includes(user) ? 0 : 1), 0);
    }
    function ensureSeedInbox(){
      const msgs = loadInbox();
      if(msgs.length) return;
      const seed = {
        id: Math.random().toString(36).slice(2)+Date.now().toString(36),
        subject: "Bienvenue dans la bo√Æte commune",
        body: "Ici, les techniciens et l‚Äôadmin partagent des messages.\n‚Ä¢ Cliquez un message pour le marquer comme lu.\n‚Ä¢ Le badge ne compte que vos non-lus.\n‚Ä¢ Admin peut supprimer des messages.",
        from: "syst√®me",
        createdAt: nowISO(),
        readBy: []
      };
      saveInbox([seed]);
    }
    function updateTopbar(){
      const visible = canSeeInbox() && (document.body.classList.contains('view-service') || document.body.classList.contains('view-admin'));
      topbar.style.display = visible ? "flex" : "none";
      if(!visible){ return; }
      const n = unreadCountFor(currentPseudo);
      if(n > 0){
        mailBadge.style.display = "flex";
        mailBadge.textContent = String(n);
      } else {
        mailBadge.style.display = "none";
      }
    }
    function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }
    function openInbox(){
      ensureSeedInbox();
      renderInboxList();
      in_newBtn.style.display = canSeeInbox() ? "inline-block" : "none";
      composeArea.style.display = "none";
      inboxModal.style.display = "flex";
    }
    function closeInbox(){ inboxModal.style.display = "none"; }

    function renderInboxList(){
      const msgs = loadInbox().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      if(!msgs.length){
        inboxList.innerHTML = `<div class="hint-sm" style="padding:8px;">Aucun message.</div>`;
        return;
      }
      inboxList.innerHTML = msgs.map(m=>{
        const when = new Date(m.createdAt).toLocaleString();
        const unread = !m.readBy?.includes(currentPseudo);
        const isJoin = m.type === "join_request";
        const joinText = isJoin
          ? `${escapeHTML(m.target||"Quelqu'un")} vient de rejoindre la communaut√© l'acceptez vous ou pas? oui non ?`
          : escapeHTML(m.body||"");
        return `
          <div class="msg-card" data-mid="${m.id}">
            <div class="msg-head">
              <span class="subtle">${when} ¬∑ par <strong>${m.from || "‚Äî"}</strong></span>
              ${unread ? `<span class="badge-unread">non lu</span>` : ``}
            </div>
            <div class="msg-title" style="margin-top:6px;">${escapeHTML(m.subject||"(sans sujet)")}</div>
            <div class="wi-reason" style="margin-top:6px; white-space:pre-wrap;">${joinText}</div>
            <div class="msg-actions">
              <button class="btn-sm" data-act="mark" data-id="${m.id}">Marquer comme lu</button>
              ${
                isJoin && canSeeInbox()
                  ? `<button class="btn-sm" data-act="accept-join" data-id="${m.id}" data-user="${escapeHTML(m.target||"")}">‚úÖ Oui</button>
                     <button class="btn-sm danger" data-act="deny-join" data-id="${m.id}" data-user="${escapeHTML(m.target||"")}">‚ùå Non</button>`
                  : ``
              }
              ${ isAdmin() ? `<button class="btn-sm danger" data-act="del" data-id="${m.id}">Supprimer</button>` : ``}
            </div>
          </div>`;
      }).join('');

      inboxList.querySelectorAll('[data-act="mark"]').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          markMessageRead(id, currentPseudo);
          renderInboxList();
          updateTopbar();
        });
      });
      inboxList.querySelectorAll('[data-act="del"]').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          if(!isAdmin()) return;
          if(!confirm("Supprimer ce message ?")) return;
          deleteMessage(id);
          renderInboxList();
          updateTopbar();
        });
      });
      inboxList.querySelectorAll('[data-act="accept-join"]').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const user = e.currentTarget.getAttribute('data-user');
          if(!canSeeInbox()) return;
          if(!user) return;
          setUserRole(user, ROLE_CERTIFIE);
          deleteMessage(id);
          buildAdminTable?.();
          renderOverlay();
          if (currentPseudo === user) renderAccountStats();
          renderInboxList();
          updateTopbar();
          alert(`${user} est maintenant certifi√© ‚úÖ`);
        });
      });
      inboxList.querySelectorAll('[data-act="deny-join"]').forEach(b=>{
        b.addEventListener('click', (e)=>{
          const id = e.currentTarget.getAttribute('data-id');
          const user = e.currentTarget.getAttribute('data-user');
          if(!canSeeInbox()) return;
          deleteMessage(id);
          renderInboxList();
          updateTopbar();
          alert(`Demande de ${user||"recrue"} refus√©e ‚ùå`);
        });
      });
      inboxList.querySelectorAll('.msg-card').forEach(card=>{
        card.addEventListener('click', (ev)=>{
          if (ev.target.closest('button')) return;
          const id = card.getAttribute('data-mid');
          markMessageRead(id, currentPseudo);
          const badge = card.querySelector('.badge-unread'); if(badge) badge.remove();
          updateTopbar();
        });
      });
    }
    function markMessageRead(id, user){
      let msgs = loadInbox();
      const i = msgs.findIndex(m=>m.id===id);
      if(i<0) return;
      msgs[i].readBy = Array.isArray(msgs[i].readBy) ? msgs[i].readBy : [];
      if(!msgs[i].readBy.includes(user)) msgs[i].readBy.push(user);
      saveInbox(msgs);
    }
    function deleteMessage(id){
      let msgs = loadInbox().filter(m=>m.id!==id);
      saveInbox(msgs);
    }
    function createMessage({subject, body, from, type=null, target=null}){
      const m = {
        id: Math.random().toString(36).slice(2)+Date.now().toString(36),
        subject: String(subject||"").trim() || "(sans sujet)",
        body: String(body||"").trim(),
        from: from || currentPseudo || "‚Äî",
        createdAt: nowISO(),
        readBy: [],
        ...(type ? {type} : {}),
        ...(target ? {target} : {})
      };
      const msgs = loadInbox(); msgs.push(m); saveInbox(msgs);
    }
    mailBtn && mailBtn.addEventListener('click', openInbox);
    in_closeBtn && (in_closeBtn.onclick = closeInbox);
    in_newBtn && (in_newBtn.onclick = ()=>{
      if(!canSeeInbox()) return;
      composeArea.style.display = "block";
      in_subject.value = "";
      in_body.value = "";
      setTimeout(()=> in_subject.focus(), 0);
    });
    in_cancelBtn && (in_cancelBtn.onclick = ()=> composeArea.style.display = "none");
    in_sendBtn && (in_sendBtn.onclick = ()=>{
      if(!canSeeInbox()) return;
      const subj = (in_subject.value||"").trim();
      const body = (in_body.value||"").trim();
      if(!subj || !body) { alert("Sujet et message requis."); return; }
      createMessage({subject: subj, body, from: currentPseudo});
      composeArea.style.display = "none";
      renderInboxList();
      updateTopbar();
    });

    /* ====== TIMER ====== */
    function tick(){
      if(startTimeMs==null) return;
      setTimer(Date.now()-startTimeMs);
      renderAccountStats();
      updateOverlayTimers();
      updateAdminTimersOnly?.();
      updateProfileLive?.();
    }
    function startTick(){ if(tickHandle) clearInterval(tickHandle); tick(); tickHandle = setInterval(tick, 1000); enableButtons(true); }
    function stopTick(){ if(tickHandle) clearInterval(tickHandle); tickHandle = null; enableButtons(false); }

    /* ====== SERVICE ====== */
    function startService(){
      if(!currentPseudo) return;
      const role = getUserRole(currentPseudo);
      if(role === ROLE_NEW){
        alert("Ton grade est 'new' : le d√©but de service est bloqu√© jusqu‚Äô√† passage en 'certifi√©'.");
        return;
      }
      const k = startKey(currentPseudo); if(localStorage.getItem(k)) return;
      startTimeMs = Date.now();
      localStorage.setItem(k, String(startTimeMs));
      const arr = getSessions(currentPseudo); arr.push({ start: startTimeMs, end: null }); setSessions(currentPseudo, arr);
      startTick(); status.textContent = currentPseudo + " a d√©marr√© ‚úÖ";
      renderOverlay(); updateOverlayTimers(); refreshAdminTable?.(); renderPatientList?.(patientSearch?.value); renderAccountStats();
    }
    function endService(){
      if(!currentPseudo) return;
      forceEndService(currentPseudo, null);
    }
    function goHome(){
      currentPseudo = null; localStorage.removeItem(ACTIVE_PSEUDO_KEY);
      document.body.classList.remove('warn-border-mid','warn-border-high');
      clearWarnToasts(); // üëâ enl√®ve juste l‚Äôaffichage (les dismiss restent m√©moris√©s)
      showView("pseudo"); resetPasswordArea(); renderOverlay(); showPatientPanel(false);
    }

    /* ====== FORCE END + META ====== */
    function forceEndService(pseudo, meta){
      const k = startKey(pseudo), s = localStorage.getItem(k); if(!s) return;
      const ended = Date.now(); const started = parseInt(s,10); const elapsed = ended - started;
      const arr = JSON.parse(localStorage.getItem(sessionsKey(pseudo)) || "[]");
      for (let i = arr.length-1; i >= 0; i--) {
        if (arr[i].end == null) {
          arr[i].end = ended;
          arr[i].endedAt = ended;
          if(meta){
            arr[i].endReason = String(meta.reason || "");
            arr[i].warning = !!meta.warning;
            arr[i].endedBy = currentPseudo || null;
          }
          break;
        }
      }
      localStorage.setItem(sessionsKey(pseudo), JSON.stringify(arr));
      const totalPrev = getTotalMs(pseudo);
      setTotalMs(pseudo, totalPrev + elapsed);
      localStorage.removeItem(k);

      if (currentPseudo === pseudo) {
        stopTick(); startTimeMs = null; setTimer(0);
        status.textContent = `${pseudo} a termin√© ‚Äî dur√©e : ${formatHM(...msToHM(elapsed))} ‚èπÔ∏è`;
        applyWarningBorder(currentPseudo);
      }
      renderOverlay(); updateOverlayTimers(); refreshAdminTable?.(); renderAccountStats?.();

      // üëâ si un avertissement a √©t√© pos√©, l‚Äôentr√©e existe d√©sormais dans sessions -> on affiche les toasts restants
      if (pseudo === currentPseudo){
        renderWarnToastsFor(currentPseudo);
      }
    }

    /* ====== AVERTISSEMENTS ====== */
    function getWarningEventsDetailed(pseudo){
      const arr = getSessions(pseudo);
      const items = [];
      arr.forEach((s, idx)=>{
        if(s.warning === true){
          const date = s.endedAt ? new Date(s.endedAt) : (s.end ? new Date(s.end) : null);
          items.push({ index: idx, date, reason: s.endReason || "", by: s.endedBy || "‚Äî" });
        }
      });
      items.sort((a,b)=> (b.date?.getTime()||0) - (a.date?.getTime()||0));
      return items;
    }
    function countWarnings(pseudo){ return getWarningEventsDetailed(pseudo).length; }
    function styleWarnCard(count){
      pf_warnCard.classList.remove('warn-ok','warn-mid','warn-high');
      if(count>5) pf_warnCard.classList.add('warn-high');
      else if(count>3) pf_warnCard.classList.add('warn-mid');
      else pf_warnCard.classList.add('warn-ok');
    }
    function applyWarningBorder(pseudo){
      document.body.classList.remove('warn-border-mid','warn-border-high');
      if(!pseudo) return;
      const c = countWarnings(pseudo);
      if(c>5) document.body.classList.add('warn-border-high');
      else if(c>3) document.body.classList.add('warn-border-mid');
    }

    function openWarnHistory(pseudo){
      const items = getWarningEventsDetailed(pseudo);
      warnHistoryState = { pseudo, items };
      wh_title.textContent = `üìí Historique ‚Äî ${pseudo}`;
      const box = document.getElementById('wh_list');
      box.innerHTML = "";
      if(items.length===0){
        box.innerHTML = `<div class="hint-sm" style="padding:8px;">Aucun avertissement.</div>`;
      } else {
        for(const it of items){
          const d = it.date ? it.date.toLocaleString() : "‚Äî";
          const wrap = document.createElement('div'); wrap.className = 'warn-item';
          const head = document.createElement('div'); head.className = 'wi-head';
          head.innerHTML = `<span>${d}</span><span>par <strong>${it.by}</strong></span>`;
          const reason = document.createElement('div'); reason.className = 'wi-reason';
          reason.textContent = it.reason || "(sans raison)";
          wrap.append(head, reason);
          if(isAdmin()){
            const actions = document.createElement('div'); actions.className = 'warn-actions';
            const btnDel = document.createElement('button'); btnDel.className = 'btn-sm danger'; btnDel.textContent = 'üóëÔ∏è Supprimer cet avertissement';
            btnDel.onclick = ()=> deleteWarningAtIndex(pseudo, it.index);
            actions.appendChild(btnDel);
            wrap.appendChild(actions);
          }
          box.appendChild(wrap);
        }
      }
      document.getElementById('wh_global').style.display = (isAdmin() && items.length>0) ? "flex" : "none";
      warnHistoryModal.style.display = "flex";
    }
    wh_closeBtn.onclick = ()=> warnHistoryModal.style.display = "none";

    function deleteWarningAtIndex(pseudo, sessionIndex){
      if(!isAdmin()) return;
      const sessions = getSessions(pseudo);
      if(!sessions[sessionIndex]) return;
      delete sessions[sessionIndex].warning;
      delete sessions[sessionIndex].endReason;
      delete sessions[sessionIndex].endedBy;
      localStorage.setItem(sessionsKey(pseudo), JSON.stringify(sessions));
      afterWarningsMutated(pseudo);
    }
    const wh_deleteAllBtn = document.getElementById('wh_deleteAllBtn');
    wh_deleteAllBtn.onclick = ()=>{
      if(!warnHistoryState) return;
      if(!isAdmin()) return;
      const pseudo = warnHistoryState.pseudo;
      if(!confirm(`Supprimer tous les avertissements de ${pseudo} ?`)) return;
      const sessions = getSessions(pseudo);
      sessions.forEach(s=>{
        if(s.warning === true){
          delete s.warning; delete s.endReason; delete s.endedBy;
        }
      });
      localStorage.setItem(sessionsKey(pseudo), JSON.stringify(sessions));
      afterWarningsMutated(pseudo);
    };
    function afterWarningsMutated(pseudo){
      refreshAdminTable?.();
      if(profileTarget === pseudo){
        const wCount = countWarnings(pseudo);
        pf_warnCount.textContent = String(wCount);
        styleWarnCard(wCount);
      }
      if(currentPseudo === pseudo){
        applyWarningBorder(pseudo);
        renderWarnToastsFor(pseudo); // üëâ recalcule les toasts restants
      }
      openWarnHistory(pseudo);
    }

    /* ====== Stats compte ====== */
    function renderAccountStats(){
      if(!currentPseudo) return;
      statPseudo.textContent = currentPseudo;
      const raw = localStorage.getItem(userKey(currentPseudo));
      const user = raw ? JSON.parse(raw) : {};
      const createdAt = user.createdAt || null;
      const role = user.role || ROLE_NEW;
      statRole.textContent = role;
      statCreated.textContent = createdAt ? new Date(createdAt).toLocaleString() : "-";
      let total = getTotalMs(currentPseudo);
      const runningStart = localStorage.getItem(startKey(currentPseudo));
      if (runningStart) total += Date.now() - parseInt(runningStart,10);
      statTotal.textContent = formatHM(...msToHM(total));
      const weekMs = calcWeekMs(currentPseudo);
      statWeek.textContent = formatHM(...msToHM(weekMs));
      homeBtn.disabled = false;
      if(role === ROLE_NEW && !runningStart){ startBtn.disabled = true; }
    }

    /* ====== Admin (inchang√©) ====== */
    const currentElapsedMsFor = p => { const s = localStorage.getItem(startKey(p)); return s ? (Date.now() - parseInt(s,10)) : 0; };
    function adminStatusText(p){
      const s = localStorage.getItem(startKey(p));
      if(!s) return '<span class="pill gray">Hors service</span>';
      const [h,m] = msToHM(Date.now() - parseInt(s,10));
      return `<span class="pill green">En service</span> &nbsp;<span class="subtle">depuis ${formatHM(h,m)}</span>`;
    }
    function roleSelectHTML(p, role){
      return `<select class="role-select" data-player="${p}">${ROLES.map(r=>`<option value="${r}" ${r===role?'selected':''}>${r}</option>`).join('')}</select>`;
    }
    function warnBadgeHTML(count){
      const cls = count>5 ? 'high' : (count>3 ? 'mid' : '');
      return `<span class="badge-warn ${cls}">${count}</span>`;
    }
    function buildAdminTable(){
      const tbody = document.querySelector("#adminTable tbody"); tbody.innerHTML = "";
      const sorted = [...pseudos].sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));
      for(const p of sorted){
        const inSvc = !!localStorage.getItem(startKey(p));
        const total = getTotalMs(p);
        const u = getUserData(p);
        const role = u.role || ROLE_NEW;
        const created = u.createdAt || "-";
        const warns = countWarnings(p);
        const tr = document.createElement("tr"); tr.dataset.player = p;
        const tdName = document.createElement("td"); tdName.textContent = p;
        const tdRole = document.createElement("td");
        tdRole.innerHTML = `<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
          <span class="role-pill ${roleClass(role)}">${role}</span> ${roleSelectHTML(p, role)}
        </div>`;
        const tdStat = document.createElement("td"); tdStat.className = "td-stat"; tdStat.innerHTML = adminStatusText(p);
        const tdTimer = document.createElement("td"); tdTimer.className = "td-timer"; tdTimer.textContent = inSvc ? formatHM(...msToHM(currentElapsedMsFor(p))) : "0h00";
        const tdTotal = document.createElement("td"); tdTotal.className = "td-total"; tdTotal.textContent = formatHM(...msToHM(total));
        const tdWarns = document.createElement("td"); tdWarns.className="td-warns"; tdWarns.innerHTML = warnBadgeHTML(warns);
        const tdCreated = document.createElement("td"); tdCreated.textContent = created === "-" ? "-" : new Date(created).toLocaleString();
        const tdActions = document.createElement("td"); tdActions.className = "td-actions";
        const btnDel = document.createElement("button"); btnDel.className = "btn-sm danger"; btnDel.textContent = "Supprimer"; btnDel.onclick = ()=> deleteUserFully(p);
        tdActions.appendChild(btnDel);
        tr.append(tdName, tdRole, tdStat, tdTimer, tdTotal, tdWarns, tdCreated, tdActions);
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('select.role-select').forEach(sel=>{
        sel.addEventListener('change', e=>{
          const p = e.target.getAttribute('data-player');
          const newRole = e.target.value;
          setUserRole(p, newRole);
          buildAdminTable(); renderOverlay();
          if(currentPseudo){ renderAccountStats(); showPatientPanel(true); }
          updateTopbar();
          // Changement de r√¥le => recalcul potentiel de l‚Äô√©ligibilit√© toast
          if (p === currentPseudo) renderWarnToastsFor(currentPseudo);
        });
      });
    }
    function updateAdminTimersOnly(){
      if (adminBox.style.display === "none") return;
      document.querySelectorAll("#adminTable tbody tr").forEach(tr=>{
        const p = tr.dataset.player;
        const inSvc = !!localStorage.getItem(startKey(p));
        const tdStat = tr.querySelector(".td-stat");
        const tdTimer = tr.querySelector(".td-timer");
        const tdTotal = tr.querySelector(".td-total");
        const tdWarns = tr.querySelector(".td-warns");
        tdStat.innerHTML = adminStatusText(p);
        tdTimer.textContent = inSvc ? formatHM(...msToHM(currentElapsedMsFor(p))) : "0h00";
        const total = getTotalMs(p); tdTotal.textContent = formatHM(...msToHM(total));
        tdWarns.innerHTML = warnBadgeHTML(countWarnings(p));
      });
    }
    function refreshAdminTable(){ if (adminBox.style.display !== "none") buildAdminTable(); }
    function openAdmin(){
      currentPseudo = ADMIN_NAME;
      localStorage.setItem(ACTIVE_PSEUDO_KEY, currentPseudo);
      showView("admin");
      buildAdminTable();
      renderOverlay();
      updateTopbar();
      if (adminTickHandle) clearInterval(adminTickHandle);
      adminTickHandle = setInterval(updateAdminTimersOnly, 1000);
    }

    /* ====== Suppressions (admin) ====== */
    function deleteAllUsers(){
      if (!isAdmin()) return;
      if (!confirm("Supprimer tous les joueurs (hors admin) ?")) return;
      for(const p of pseudos){
        localStorage.removeItem(userKey(p));
        localStorage.removeItem(startKey(p));
        localStorage.removeItem(totalKey(p));
        localStorage.removeItem(sessionsKey(p));
        localStorage.removeItem(warnDismissedKey(p)); // üëâ on nettoie aussi les dismiss m√©moris√©s
      }
      pseudos = [];
      localStorage.setItem(PSEUDOS_KEY, JSON.stringify(pseudos));
      buildAdminTable();
      renderOverlay();
      clearWarnToasts();
    }
    function deleteUserFully(p){
      if (!isAdmin()) return;
      if (!p) return;
      if (!confirm(`Supprimer le joueur "${p}" ?`)) return;
      localStorage.removeItem(userKey(p));
      localStorage.removeItem(startKey(p));
      localStorage.removeItem(totalKey(p));
      localStorage.removeItem(sessionsKey(p));
      localStorage.removeItem(warnDismissedKey(p)); // üëâ nettoie les dismiss
      pseudos = pseudos.filter(x => x !== p);
      localStorage.setItem(PSEUDOS_KEY, JSON.stringify(pseudos));
      if (profileTarget === p) { profileTarget = null; profileModal.style.display = "none"; }
      buildAdminTable();
      renderOverlay();
      if (p === currentPseudo) clearWarnToasts();
    }

    /* ====== Profil joueur ====== */
    function openPlayerProfile(p){
      if (!p) return;
      profileTarget = p;
      const u = getUserData(p) || {};
      const createdAt = u.createdAt ? new Date(u.createdAt).toLocaleString() : "‚Äî";
      const role = getUserRole(p);
      const started = localStorage.getItem(startKey(p));
      const [curH, curM] = msToHM(started ? (Date.now() - parseInt(started,10)) : 0);
      const totalMs = getTotalMs(p) + (started ? (Date.now() - parseInt(started,10)) : 0);
      const [totH, totM] = msToHM(totalMs);
      const [weekH, weekM] = msToHM(calcWeekMs(p));
      const createdCount = (patients || []).filter(x => x.createdBy === p).length;
      const modifiedCount = (patients || []).filter(x => x.lastModifiedBy === p).length;

      pf_title.textContent = `üë§ Profil ‚Äî ${p}`;
      pf_pseudo.textContent = p;
      pf_role.textContent = role;
      pf_roleEditor.style.display = (canEditRoles() && p !== ADMIN_NAME) ? "block" : "none";
      if (pf_roleEditor.style.display === "block") pf_roleSelect.value = role;
      pf_created.textContent = createdAt;
      pf_status.textContent = started ? "En service" : "Hors service";
      pf_current.textContent = formatHM(curH, curM);
      pf_total.textContent = formatHM(totH, totM);
      pf_week.textContent  = formatHM(weekH, weekM);
      pf_createdCount.textContent = String(createdCount);
      pf_modifiedCount.textContent = String(modifiedCount);

      const wCount = countWarnings(p);
      pf_warnCount.textContent = String(wCount);
      styleWarnCard(wCount);
      pf_warnHint.style.display = canViewWarnings() ? "block" : "none";
      pf_warnCard.classList.toggle('clickable', canViewWarnings());
      pf_warnCard.title = canViewWarnings() ? "Voir l'historique" : "";

      pf_forceEndBtn.disabled = !(canForceEndOther() && !!started);
      

      // Visibilit√© : cach√© pour CERTIFI√â et NEW
      pf_forceEndBtn.style.display = canSeeForceEndBtn() ? 'inline-block' : 'none';
pf_forceEndBtn.onclick = ()=>{
  if (!canForceEndOther()) return;
  if (!localStorage.getItem(startKey(p))) return;

  // Pr√©pare et ouvre la modale "Terminer le service"
  if (er_title)   er_title.textContent = `üìù Terminer le service ‚Äî ${p}`;
  if (er_reason)  er_reason.value = "";
  if (er_warning) er_warning.value = "no";
  if (er_msg){ er_msg.textContent = ""; er_msg.className = "msg"; }
  if (endReasonModal) endReasonModal.style.display = "flex";

  function cleanup(){
    if (er_confirmBtn) er_confirmBtn.removeEventListener('click', onConfirm);
    if (er_cancelBtn)  er_cancelBtn.removeEventListener('click', onCancel);
  }
  function onCancel(){
    if (endReasonModal) endReasonModal.style.display = "none";
    cleanup();
  }
  function onConfirm(){
    if (!canForceEndOther()) return;
    const reason = (er_reason?.value || "").trim();
    if (!reason){
      if (er_msg){ er_msg.textContent = "La raison est obligatoire."; er_msg.className = "msg error"; }
      return;
    }
    const warn = (er_warning?.value === "yes");
    forceEndService(p, { reason, warning: warn });
    if (warn && typeof issueWarning === "function"){
      issueWarning(p, reason);
    }
    if (endReasonModal) endReasonModal.style.display = "none";
    pf_forceEndBtn.disabled = true;
    cleanup();
  }

  if (er_confirmBtn) er_confirmBtn.addEventListener('click', onConfirm);
  if (er_cancelBtn)  er_cancelBtn.addEventListener('click', onCancel);
};

      pf_closeBtn.onclick = ()=>{ profileModal.style.display='none'; profileTarget=null; };
      pf_warnCard.onclick = ()=>{ if (canViewWarnings()) openWarnHistory(p); };

      profileModal.style.display = "flex";
      if (profileTickHandle) clearInterval(profileTickHandle);
      profileTickHandle = setInterval(()=> updateProfileLive(), 1000);
      updateProfileLive(true);
    }
    function updateProfileLive(force=false){
      if (!profileTarget || profileModal.style.display === "none") return;
      const p = profileTarget;
      const started = localStorage.getItem(startKey(p));
      const totalMs = getTotalMs(p) + (started ? (Date.now() - parseInt(started,10)) : 0);
      const [curH, curM] = msToHM(started ? (Date.now() - parseInt(started,10)) : 0);
      const [totH, totM] = msToHM(totalMs);
      const [weekH, weekM] = msToHM(calcWeekMs(p));
      pf_status.textContent = started ? "En service" : "Hors service";
      pf_current.textContent = formatHM(curH, curM);
      pf_total.textContent = formatHM(totH, totM);
      pf_week.textContent  = formatHM(weekH, weekM);
    }

    /* ====== Util ====== */
    function computeAgeFromDob(dob){
      if (!dob) return "";
      const d = new Date(dob);
      if (isNaN(+d)) return "";
      const today = new Date();
      let age = today.getFullYear() - d.getFullYear();
      const m = today.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
      return age;
    }

    /* ====== Boutons patient (si pas branch√©s) ====== */
    const btnNewPatient = document.getElementById('btnNewPatient');
    if (btnNewPatient && !btnNewPatient._wired){
      btnNewPatient._wired = true;
      btnNewPatient.addEventListener('click', ()=>{
        if (!canCreatePatients()) { alert("Droit insuffisant."); return; }
        document.getElementById('patientModal').style.display = 'flex';
        ['np_nom','np_prenom','np_sexe','np_dob','np_age','np_tel','np_taille','np_poid','np_groupe','np_allergies','np_commentaire','np_staff','np_nature','np_typeBlessure','np_gravite','np_soins','np_prise','np_irm','np_scanner','np_operation'].forEach(id=>{
          const el=document.getElementById(id); if(!el) return;
          if (el.tagName==='SELECT') el.value="";
          else el.value="";
        });
        refreshDatalists?.();
      });
    }
    const btnCancelPatient = document.getElementById('btnCancelPatient');
    if (btnCancelPatient) btnCancelPatient.onclick = ()=> document.getElementById('patientModal').style.display='none';

    document.getElementById('pf_closeBtn')?.addEventListener('click', ()=>{
      if (profileTickHandle) clearInterval(profileTickHandle);
      profileTickHandle = null;
    });

    /* ====== Chargement initial ====== */
    window.addEventListener('load', ()=>{
      ensureSeedInbox();
      const last = localStorage.getItem(ACTIVE_PSEUDO_KEY);
      renderOverlay();
      if (last) {
        if (last === ADMIN_NAME) { currentPseudo = ADMIN_NAME; openAdmin(); }
        else { currentPseudo = last; openServiceAfterAuth(); }
      } else {
        showView("pseudo");
      }
      // au cas o√π on arrive directement sur une vue service/admin avec un utilisateur actif
      renderWarnToastsFor(currentPseudo);
    });

    window.addEventListener('beforeunload', ()=>{
      if (profileTickHandle) clearInterval(profileTickHandle);
      if (adminTickHandle) clearInterval(adminTickHandle);
    });
  </script>

<script>
/* ================== Sticky Player Warning (persist until dismissed) ================== */
(function(){
  const WARN_PREFIX = 'WARN_USER_';
  // Ensure a single toast element exists
  function ensureToast(){
    let el = document.getElementById('warningToast');
    if (!el){
      el = document.createElement('div');
      el.id = 'warningToast';
      el.className = 'warning-toast';
      el.innerHTML = [
        '<div class="wt-header">',
          '<span>‚ö†Ô∏è Avertissement</span>',
          '<span class="wt-close" aria-label="Fermer" title="Fermer">√ó</span>',
        '</div>',
        '<div class="wt-body"></div>',
        '<div class="wt-meta"></div>'
      ].join('');
      document.body.appendChild(el);
      const close = el.querySelector('.wt-close');
      close.addEventListener('click', ()=>{
        const user = (typeof currentPseudo!=='undefined' && currentPseudo) ? String(currentPseudo) : null;
        if (user){
          const w = getWarningForUser(user);
          if (w){
            w.dismissed = true;
            saveWarning(user, w);
          }
        }
        hideToast();
      });
    }
    return el;
  }
  function showToast(text, meta){
    const el = ensureToast();
    el.querySelector('.wt-body').textContent = text || '';
    el.querySelector('.wt-meta').textContent = meta || '';
    el.classList.add('show');
  }
  function hideToast(){
    const el = document.getElementById('warningToast');
    if (el) el.classList.remove('show');
  }

  function warnKey(user){ return WARN_PREFIX + String(user); }
  function getWarningForUser(user){
    try { return JSON.parse(localStorage.getItem(warnKey(user))) || null; }
    catch { return null; }
  }
  function saveWarning(user, obj){
    localStorage.setItem(warnKey(user), JSON.stringify(obj));
  }
  // Public API to issue a warning to a target user
  window.issueWarning = function(toUser, reason){
    const giver = (typeof isAdmin==='function' && isAdmin()) ? 'admin' : (typeof currentPseudo!=='undefined' && currentPseudo ? String(currentPseudo) : '‚Äî');
    const payload = {
      giver,
      reason: String(reason||'').trim(),
      time: new Date().toISOString(),
      dismissed: false
    };
    saveWarning(String(toUser), payload);
    // If target is the currently logged-in user, show immediately
    if (typeof currentPseudo!=='undefined' && String(currentPseudo) === String(toUser)){
      renderWarningIfAny();
    }
  };

  function formatTime(iso){
    try {
      const d = new Date(iso);
      // Use locale with date & time
      return d.toLocaleString();
    } catch(e) { return iso; }
  }

  function renderWarningIfAny(){
    const user = (typeof currentPseudo!=='undefined' && currentPseudo) ? String(currentPseudo) : null;
    if (!user){ hideToast(); return; }
    const w = getWarningForUser(user);
    if (w && !w.dismissed){
      const giver = w.giver || '‚Äî';
      const msg = `Vous avez re√ßu un avertissement de "${giver}" √† ${formatTime(w.time)} pour "${w.reason || '‚Äî'}".`;
      showToast(msg, '');
    } else {
      hideToast();
    }
  }

  // Watch for user login/logout (currentPseudo change)
  let _lastUser = (typeof currentPseudo!=='undefined' && currentPseudo) ? String(currentPseudo) : null;
  setInterval(()=>{
    const nowUser = (typeof currentPseudo!=='undefined' && currentPseudo) ? String(currentPseudo) : null;
    if (nowUser !== _lastUser){
      _lastUser = nowUser;
      renderWarningIfAny();
    }
  }, 1000);

  // Also render on load
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', renderWarningIfAny);
  } else {
    renderWarningIfAny();
  }

  // React to cross-tab updates
  window.addEventListener('storage', (e)=>{
    if (!e.key) return;
    if (typeof currentPseudo==='undefined' || !currentPseudo) return;
    if (e.key === warnKey(currentPseudo)) renderWarningIfAny();
  });
})();
</script>
<script>

/* ================== Audit Logs (24h retention, live) ================== */
(function(){
  const LOG_KEY = 'auditLogs24h';
  const RET_MS  = 24*60*60*1000; // 24h
  const logsText  = document.getElementById('logsText');
  const logsTimes = document.getElementById('logsTimes');
  const logsModal = document.getElementById('logsModal');
  const logsCloseBtn = document.getElementById('logsCloseBtn');
  const logsBar  = document.getElementById('logsBar');
  const openLogsBtn = document.getElementById('openLogsBtn');

  function now(){ return Date.now(); }
  function load(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY) || '[]'); }catch{ return []; } }
  function save(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }
  function purge(){
    const lim = now() - RET_MS;
    const arr = load().filter(e => (e.t||0) >= lim);
    save(arr);
    return arr;
  }
  function pad(n){ return n<10 ? '0'+n : ''+n; }
  function fmt(ts){
    const d = new Date(ts);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function pushLine(actor, text, target){
    const arr = purge();
    arr.push({ t: now(), by: actor || (window.currentPseudo || '‚Äî'), text: String(text||''), target: target||null });
    save(arr);
    render(); // live update
  }
  function render(){
    if (!logsText || !logsTimes) return;
    const arr = purge();
    const left = [];
    const right = [];
    for(const e of arr){
      const who = String(e.by||'‚Äî');
      const what = String(e.text||'');
      left.push(`${who}  ${what}`);
      right.push(`${fmt(e.t)}`);
    }
    logsText.textContent = left.join('\n') || '‚Äî';
    logsTimes.textContent = right.join('\n') || '‚Äî';
  }

  // Expose small API
  window._logs24 = { pushLine, render, purge };

  // ===== Hooks =====

  // 0) "Nouveau pseudo" qui rejoint le serveur : au moment du login si pseudo inexistant
  const _enterPseudoFlow = window.enterPseudoFlow;
  if (typeof _enterPseudoFlow === 'function'){
    window.enterPseudoFlow = function(){
      const before = Array.isArray(window.pseudos) ? [...window.pseudos] : [];
      const r = _enterPseudoFlow.apply(this, arguments);
      try{
        const after = Array.isArray(window.pseudos) ? window.pseudos : [];
        // si pseudo courant n'√©tait pas dans la liste avant => nouveau joueur
        if (window.currentPseudo && !before.includes(window.currentPseudo) && after.includes(window.currentPseudo)){
          pushLine(window.currentPseudo, 'a rejoint le serveur');
        }
      }catch(e){}
      return r;
    };
  }

  // 1) D√©marrage service
  const _startService = window.startService;
  if (typeof _startService === 'function'){
    window.startService = function(){
      const r = _startService.apply(this, arguments);
      try{ if (window.currentPseudo) pushLine(window.currentPseudo, 'a commenc√© son service'); }catch(e){}
      return r;
    };
  }

  // 2) Arr√™t service (soi-m√™me)
  const _endService = window.endService;
  if (typeof _endService === 'function'){
    window.endService = function(){
      const r = _endService.apply(this, arguments);
      try{ if (window.currentPseudo) pushLine(window.currentPseudo, 'a arr√™t√© son service'); }catch(e){}
      return r;
    };
  }

  // 3) Fin de service d‚Äôun autre par technicien/admin (forceEndService)
  const _forceEndService = window.forceEndService;
  if (typeof _forceEndService === 'function'){
    window.forceEndService = function(pseudoCible, meta){
      const r = _forceEndService.apply(this, arguments);
      try{
        const actor = window.currentPseudo || '‚Äî';
        const warn = meta && !!meta.warning;
        if (warn){
          pushLine(actor, `a arr√™t√© le service de ${pseudoCible} (+ avertissement)`);
        }else{
          pushLine(actor, `a arr√™t√© le service de ${pseudoCible}`);
        }
      }catch(e){}
      return r;
    };
  }

  // 4) Cr√©ation d‚Äôune fiche patient (on rep√®re l‚Äôajout via savePatients)
  const _savePatients = window.savePatients;
  if (typeof _savePatients === 'function'){
    window.savePatients = function(arr){
      const before = (function(){ try{return JSON.parse(localStorage.getItem('patients')||'[]');}catch{return []} })();
      const r = _savePatients.apply(this, arguments);
      try{
        const after = (function(){ try{return JSON.parse(localStorage.getItem('patients')||'[]');}catch{return []} })();
        if (after.length > before.length){
          const diff = after.find(a => !before.some(b => String(b.id)===String(a.id)));
          if (diff){
            const who = window.currentPseudo || '‚Äî';
            const name = `${diff.nom||'‚Äî'} ${diff.prenom||''}`.trim();
            pushLine(who, `a cr√©√© une fiche patient ‚Äî ${name}`);
          }
        }
      }catch(e){}
      return r;
    };
  }

  // ===== UI Wiring =====
  function refreshLogsBarVisibility(){
    const visible = (typeof isAdmin==='function' && isAdmin());
    if (logsBar) logsBar.style.display = visible ? 'flex' : 'none';
  }
  refreshLogsBarVisibility();
  setInterval(refreshLogsBarVisibility, 1000);

  if (openLogsBtn){
    openLogsBtn.addEventListener('click', ()=>{
      if (logsModal) logsModal.style.display = 'flex';
      render();
    });
  }
  if (logsCloseBtn){
    logsCloseBtn.addEventListener('click', ()=>{
      if (logsModal) logsModal.style.display = 'none';
    });
  }

  // Live refresh while open
  setInterval(()=>{
    if (logsModal && logsModal.style.display === 'flex'){
      render();
    }
  }, 1500);

  // Initial purge/render
  render();
})();

</script>
<script>

/* ===== Hidden Admin Login on .logo-big: 5 clicks in 10s ‚Üí password modal ===== */
(function(){
  const ADMIN_NAME = (typeof window.ADMIN_NAME!=='undefined' ? window.ADMIN_NAME : 'admin');
  const logoLogin = document.querySelector('.logo-big');
  const adminGateModal = document.getElementById('adminGateModal');
  const adminPwd = document.getElementById('adminPwd');
  const adminGateOk = document.getElementById('adminGateOk');
  const adminGateCancel = document.getElementById('adminGateCancel');
  const adminGateMsg = document.getElementById('adminGateMsg');
  const pseudoInput = document.getElementById('pseudoInput');
  const pseudoBtn = document.getElementById('pseudoBtn');

  let clicks = [];
  function openGate(){
    if (adminGateModal) adminGateModal.style.display = 'flex';
    if (adminGateMsg){ adminGateMsg.textContent = ''; adminGateMsg.className = 'msg'; }
    if (adminPwd){ adminPwd.value=''; setTimeout(()=>adminPwd.focus(), 0); }
  }
  function closeGate(){ if (adminGateModal) adminGateModal.style.display='none'; }

  // Block direct use of 'admin' pseudo (any case) unless approved via gate
  if (pseudoBtn){
    pseudoBtn.addEventListener('click', (e)=>{
      const val = (pseudoInput?.value || '').trim().toLowerCase();
      if (val === String(ADMIN_NAME).toLowerCase()){
        if (!window.__adminGateApproved){
          e.preventDefault();
          if (pseudoInput){ pseudoInput.value = "indisponible"; pseudoInput.focus(); }
          const msg = document.getElementById('message') || adminGateMsg;
          if (msg){ msg.textContent = "Ce pseudo est indisponible."; msg.className = "msg error"; }
          return false;
        }
      }
    }, true);
  }

  // Bind 5-click detector on the login logo
  function bindLogoClicks(){
    const el = document.querySelector('.logo-big');
    if (!el || el._adminGateWired) return;
    el._adminGateWired = true;
    el.style.cursor = 'pointer'; // subtle hint; change/remove if undesired
    el.addEventListener('click', ()=>{
      const now = Date.now();
      clicks = clicks.filter(t => now - t < 10000);
      clicks.push(now);
      if (clicks.length >= 5){
        clicks = [];
        openGate();
      }
    });
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindLogoClicks);
  } else {
    bindLogoClicks();
  }

  // Password verification: use stored PBKDF2 hash if exists, otherwise fallback to "admin"
  async function verifyAdminPwd(pwd){
    try{
      const key = "admin:password";
      const raw = localStorage.getItem(key);
      if (raw){
        const data = JSON.parse(raw);
        if (data?.hash && data?.salt && window.pbkdf2Hash){
          const calc = await window.pbkdf2Hash(pwd, data.salt, 120000);
          return calc === data.hash;
        }
      }
    }catch(e){}
    return pwd === "admin"; // fallback default
  }

  async function doAdminLogin(){
    const pwd = (adminPwd?.value || '').trim();
    if (!pwd){
      if (adminGateMsg){ adminGateMsg.textContent = "Mot de passe requis."; adminGateMsg.className = "msg error"; }
      return;
    }
    const ok = await verifyAdminPwd(pwd);
    if (!ok){
      if (adminGateMsg){ adminGateMsg.textContent = "Mot de passe incorrect."; adminGateMsg.className = "msg error"; }
      return;
    }
    // Success: mark approval and trigger normal flow as 'admin'
    window.__adminGateApproved = true;
    if (pseudoInput) pseudoInput.value = ADMIN_NAME;
    if (pseudoBtn) pseudoBtn.click();
    // After normal flow, go to admin view
    setTimeout(()=>{
      try{
        if (typeof isAdmin==='function' && isAdmin()){
          if (typeof showView==='function') showView('admin');
          else {
            // fallback: manually toggle
            const pseudoBox = document.getElementById('pseudoBox');
            const adminBox = document.getElementById('adminBox');
            if (pseudoBox) pseudoBox.style.display = 'none';
            if (adminBox) adminBox.style.display = 'block';
            document.body.classList.remove('view-service');
            document.body.classList.add('view-admin');
          }
        }
      }catch(e){}
      window.__adminGateApproved = false; // reset
    }, 50);
    closeGate();
  }

  if (adminGateOk) adminGateOk.addEventListener('click', doAdminLogin);
  if (adminGateCancel) adminGateCancel.addEventListener('click', closeGate);
  if (adminPwd){
    adminPwd.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); doAdminLogin(); } });
  }

  // Extra guard inside enterPseudoFlow if it exists
  const _enterPseudoFlow = window.enterPseudoFlow;
  if (typeof _enterPseudoFlow === 'function'){
    window.enterPseudoFlow = function(){
      try{
        const val = (document.getElementById('pseudoInput')?.value || '').trim().toLowerCase();
        if (val === String(ADMIN_NAME).toLowerCase() && !window.__adminGateApproved){
          const inp = document.getElementById('pseudoInput');
          if (inp){ inp.value = 'indisponible'; inp.focus(); }
          const m = document.getElementById('message');
          if (m){ m.textContent = 'Ce pseudo est indisponible.'; m.className = 'msg error'; }
          return;
        }
      }catch(e){}
      return _enterPseudoFlow.apply(this, arguments);
    };
  }
})();

</script>
<script>

/* === Instant Admin Panel Refresh === */
(function(){
  function refreshAdminNow(){
    try{
      if (typeof updateTopbar==='function') updateTopbar();
      if (typeof buildAdminTable==='function') buildAdminTable();
      if (typeof renderAccountStats==='function') renderAccountStats();
      if (typeof renderPlayerList==='function') renderPlayerList();
      if (typeof refreshAdminPanel==='function') refreshAdminPanel();
      if (typeof renderAdmin==='function') renderAdmin();
    }catch(e){ /* silent */ }
  }
  // Refresh when body switches to admin view
  function observeView(){
    const body = document.body;
    const mo = new MutationObserver(()=>{
      if (body.classList.contains('view-admin')){
        // micro-burst to ensure DOM regions exist
        refreshAdminNow();
        setTimeout(refreshAdminNow, 50);
        setTimeout(refreshAdminNow, 150);
      }
    });
    mo.observe(body, { attributes:true, attributeFilter:['class'] });
  }
  // Refresh when localStorage changes (patients, pseudos, sessions, roles, etc)
  window.addEventListener('storage', (e)=>{
    if (!e) return;
    if (!document.body.classList.contains('view-admin')) return;
    const keys = ['patients','pseudos','sessions','roles','inbox','admin:password'];
    if (!e.key || keys.includes(e.key)){
      refreshAdminNow();
    }
  });
  // Initial hook
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=>{ observeView(); if (document.body.classList.contains('view-admin')) refreshAdminNow(); });
  } else {
    observeView();
    if (document.body.classList.contains('view-admin')) refreshAdminNow();
  }
  // Expose manual trigger
  window.forceAdminRefresh = refreshAdminNow;
})();

</script>
<script>

/* === Live Service Status Updater (1s) === */
(function(){
  let tick = 0;
  function safe(fn){ try{ fn && fn(); }catch(e){} }

  function lightRefresh(){
    // Lightweight, every second
    safe(window.updateTopbar);
    // If there's a dedicated lightweight renderer for timers, call it if present
    safe(window.updateServiceTimers);
    // Some apps expose a player list renderer that is cheap
    if (typeof renderPlayerList === 'function') safe(renderPlayerList);
  }
  function heavyRefresh(){
    // Heavier rebuild (tables, stats)
    if (typeof buildAdminTable === 'function') safe(buildAdminTable);
    if (typeof renderAccountStats === 'function') safe(renderAccountStats);
    if (typeof refreshAdminPanel === 'function') safe(refreshAdminPanel);
    if (typeof renderAdmin === 'function') safe(renderAdmin);
  }

  function onTick(){
    tick++;
    const body = document.body;
    const inAdmin = body.classList.contains('view-admin');
    const inService = body.classList.contains('view-service');
    // Run light refresh in both admin and service views
    if (inAdmin || inService) lightRefresh();
    // Heavier refresh less frequently to avoid jank
    if ((inAdmin || inService) && tick % 5 === 0) heavyRefresh();
  }

  // Start ticking once DOM is ready
  function startTicker(){
    if (window.__liveStatusTickerStarted) return;
    window.__liveStatusTickerStarted = true;
    setInterval(onTick, 1000);
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', startTicker);
  } else {
    startTicker();
  }
})();

</script>
<script>

/* ================== Admin Logs (24h retention, live) ================== */
(function(){
  const LOG_KEY = 'auditLogs24h';
  const RET_MS  = 24*60*60*1000; // 24h
  const logsBar = document.getElementById('logsBar');
  const openLogsBtn = document.getElementById('openLogsBtn');
  const logsModal = document.getElementById('logsModal');
  const logsText  = document.getElementById('logsText');
  const logsTimes = document.getElementById('logsTimes');
  const logsCloseBtn = document.getElementById('logsCloseBtn');

  function now(){ return Date.now(); }
  function load(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY) || '[]'); }catch{ return []; } }
  function save(arr){ localStorage.setItem(LOG_KEY, JSON.stringify(arr)); }
  function purge(){
    const lim = now() - RET_MS;
    const arr = load().filter(e => (e.t||0) >= lim);
    save(arr);
    return arr;
  }
  function pad(n){ return n<10 ? '0'+n : ''+n; }
  function time(ts){
    const d = new Date(ts);
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function pushLine(text){
    const actor = window.currentPseudo || '‚Äî';
    const arr = purge();
    arr.push({ t: now(), by: actor, text: text });
    save(arr);
    render();
  }
  function render(){
    if (!logsText || !logsTimes) return;
    const arr = purge();
    logsText.textContent = arr.map(e => `"${e.by}" ${e.text}`).join('
') || '‚Äî';
    logsTimes.textContent = arr.map(e => time(e.t)).join('
') || '‚Äî';
  }
  window._adminLogs = { pushLine, render, purge, load };

  // Hooks
  const _startService = window.startService;
  if (typeof _startService === 'function'){
    window.startService = function(){
      const r = _startService.apply(this, arguments);
      try{ pushLine('a commenc√© le service'); }catch(e){}
      return r;
    };
  }
  const _endService = window.endService;
  if (typeof _endService === 'function'){
    window.endService = function(){
      const r = _endService.apply(this, arguments);
      try{ pushLine('a fini son service'); }catch(e){}
      return r;
    };
  }
  const _forceEndService = window.forceEndService;
  if (typeof _forceEndService === 'function'){
    window.forceEndService = function(pseudoCible, meta){
      const r = _forceEndService.apply(this, arguments);
      try{
        const tech = window.currentPseudo || '‚Äî';
        const target = pseudoCible || '‚Äî';
        const arr = purge();
        arr.push({ t: now(), by: tech, text: `a arr√™t√© le service de "${target}"` });
        save(arr);
        render();
      }catch(e){}
      return r;
    };
  }
  const _savePatients = window.savePatients;
  if (typeof _savePatients === 'function'){
    window.savePatients = function(arr){
      const before = (function(){ try{return JSON.parse(localStorage.getItem('patients')||'[]');}catch{return []} })();
      const r = _savePatients.apply(this, arguments);
      try{
        const after = (function(){ try{return JSON.parse(localStorage.getItem('patients')||'[]');}catch{return []} })();
        if (after.length > before.length){
          const diff = after.find(a => !before.some(b => String(b.id)===String(a.id)));
          if (diff){
            const name = `${diff.nom||'‚Äî'} ${diff.prenom||''}`.trim();
            pushLine(`a cr√©√© une fiche "${name}"`);
          }
        } else if (after.length === before.length){
          const mod = after.find(a => {
            const b = before.find(x => String(x.id)===String(a.id));
            return b && JSON.stringify(a) !== JSON.stringify(b);
          });
          if (mod){
            const name = `${mod.nom||'‚Äî'} ${mod.prenom||''}`.trim();
            pushLine(`a modifi√© la fiche "${name}"`);
          }
        }
      }catch(e){}
      return r;
    };
  }

  // UI wiring
  function refreshLogsBarVisibility(){
    const visible = (typeof isAdmin==='function' && isAdmin());
    if (logsBar) logsBar.style.display = visible ? 'flex' : 'none';
  }
  refreshLogsBarVisibility();
  setInterval(refreshLogsBarVisibility, 1000);

  if (openLogsBtn){
    openLogsBtn.addEventListener('click', ()=>{
      if (logsModal) logsModal.style.display = 'flex';
      render();
    });
  }
  if (logsCloseBtn){
    logsCloseBtn.addEventListener('click', ()=>{
      if (logsModal) logsModal.style.display = 'none';
    });
  }
  setInterval(()=>{ if (logsModal && logsModal.style.display==='flex') render(); }, 1500);
  render();
})();

</script>







  

<!-- ================= Firebase Firestore Mirror (non-invasif) ================ -->
<script type="module">
/* Ce bloc ajoute la synchro Firestore **sans changer** l'UI existante.
   Il √©coute Firestore et met √† jour localStorage + d√©clenche les √©crans.
   Il intercepte aussi certaines fonctions (startService, forceEndService,
   savePatients, setUserRole) pour √©crire dans Firestore en parall√®le. */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy, serverTimestamp, writeBatch, getDocs
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {"apiKey": "AIzaSyDMGMkmVgl8h0WuknCA-AChlyoX95RufNs", "authDomain": "base-de-donnee-b5c8c.firebaseapp.com", "projectId": "base-de-donnee-b5c8c", "storageBucket": "base-de-donnee-b5c8c.firebasestorage.app", "messagingSenderId": "302677536354", "appId": "1:302677536354:web:54e0d4562bad5f06c3ab3b"};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// --- Collections ---
const colUsers    = collection(db, "users");     // docId = pseudo
const colPatients = collection(db, "patients");  // docId = String(id)
const colServices = collection(db, "services");  // docId = pseudo
const colInbox    = collection(db, "inbox");     // docId auto (optionnel)
const colLogs     = collection(db, "logs");      // docId auto (optionnel)

// --- Utils ---
let __syncing = false;
function noLoop(fn){ __syncing = true; try{ fn && fn(); } finally { __syncing=false; } }
function safe(fn, ...a){ try{ return fn && fn(...a); }catch(e){ /* silent */ } }
function nowMs(){ return Date.now(); }
function arrEq(a,b){ return JSON.stringify(a)===(JSON.stringify(b)); }

// Helpers pour cl√©s localStorage (copie de la logique existante)
function userKey(p){ return "user:"+p; }
function startKey(p){ return "start:"+p; }
function totalKey(p){ return "total:"+p; }
function sessionsKey(p){ return "sessions:"+p; }
const PSEUDOS_KEY  = "pseudos";
const PATIENTS_KEY = "patients";

// Renders si dispo
function lightRefresh(){
  safe(window.updateTopbar);
  safe(window.updateServiceTimers);
  if (typeof window.renderPlayerList==='function') safe(window.renderPlayerList);
}
function heavyRefresh(){
  safe(window.buildAdminTable);
  safe(window.renderAccountStats);
  safe(window.refreshAdminPanel);
  safe(window.renderAdmin);
  safe(window.renderOverlay);
}

// ================== LIVE READS (Firestore -> localStorage) ==================

// Users (pseudos + roles)
onSnapshot(colUsers, (snap)=>{
  if (__syncing) return;
  const pseudos = [];
  snap.forEach(d=>{
    const p = d.id;
    pseudos.push(p);
    const data = d.data() || {};
    const role = data.role || "new";
    const createdAt = data.createdAt || data.created_at || null;
    const local = { role, createdAt };
    localStorage.setItem(userKey(p), JSON.stringify(local));
  });
  localStorage.setItem(PSEUDOS_KEY, JSON.stringify(pseudos));
  lightRefresh(); heavyRefresh();
});

// Patients (liste enti√®re √† plat dans localStorage)
onSnapshot(colPatients, async (snap)=>{
  if (__syncing) return;
  const arr = [];
  snap.forEach(d=>{
    const data = d.data() || {};
    if (typeof data.id==='undefined') data.id = parseInt(d.id,10);
    arr.push(data);
  });
  arr.sort((a,b)=> (parseInt(a.id||0,10) - parseInt(b.id||0,10)));
  localStorage.setItem(PATIENTS_KEY, JSON.stringify(arr));
  heavyRefresh();
});

// Services (start/total/sessions par pseudo)
onSnapshot(colServices, (snap)=>{
  if (__syncing) return;
  snap.forEach(d=>{
    const p = d.id;
    const s = d.data() || {};
    const start = s.start || null;
    const total = s.totalMs || 0;
    const sessions = Array.isArray(s.sessions) ? s.sessions : [];
    if (start) localStorage.setItem(startKey(p), String(start));
    else localStorage.removeItem(startKey(p));
    localStorage.setItem(totalKey(p), String(total));
    localStorage.setItem(sessionsKey(p), JSON.stringify(sessions));
  });
  lightRefresh(); heavyRefresh();
});

// ================== WRITES (local actions -> Firestore) ==================

// setUserRole
const _setUserRole = window.setUserRole;
if (typeof _setUserRole === "function"){
  window.setUserRole = async function(pseudo, role){
    const r = _setUserRole.apply(this, arguments);
    try{
      await setDoc(doc(colUsers, String(pseudo)), {
        role: String(role),
        updatedAt: nowMs()
      }, { merge: true });
    }catch(e){ /* silent */ }
    return r;
  };
}

// (Optionnel) lorsqu'un nouveau pseudo arrive, s'assurer qu'il existe c√¥t√© DB
function ensureUserDoc(pseudo){
  return setDoc(doc(colUsers, String(pseudo)), {
    role: (safe(window.getUserRole, pseudo) || "new"),
    createdAt: nowMs()
  }, { merge: true });
}

// Interception login/creation si la fonction existe
const _enterPseudoFlow = window.enterPseudoFlow;
if (typeof _enterPseudoFlow === "function"){
  window.enterPseudoFlow = async function(){
    const before = JSON.parse(localStorage.getItem(PSEUDOS_KEY)||"[]");
    const result = _enterPseudoFlow.apply(this, arguments);
    try{
      const after = JSON.parse(localStorage.getItem(PSEUDOS_KEY)||"[]");
      const added = after.find(p=>!before.includes(p));
      if (added) await ensureUserDoc(added);
    }catch(e){}
    return result;
  };
}

// Patients: patch savePatients (diff -> Firestore)
const _savePatients = window.savePatients;
if (typeof _savePatients === "function"){
  window.savePatients = async function(arr){
    const before = JSON.parse(localStorage.getItem(PATIENTS_KEY)||"[]");
    const r = _savePatients.apply(this, arguments);
    try{
      const after = JSON.parse(localStorage.getItem(PATIENTS_KEY)||"[]");
      const mapBefore = new Map(before.map(x=>[String(x.id), x]));
      const mapAfter  = new Map(after.map(x=>[String(x.id), x]));
      const batch = writeBatch(db);
      for (const [id, obj] of mapAfter){
        const prev = mapBefore.get(id);
        if (!prev || JSON.stringify(prev) !== JSON.stringify(obj)){
          batch.set(doc(colPatients, id), obj, { merge: true });
        }
      }
      for (const [id, obj] of mapBefore){
        if (!mapAfter.has(id)){
          batch.delete(doc(colPatients, id));
        }
      }
      await batch.commit();
    }catch(e){ /* silent */ }
    return r;
  };
}

// Service start/stop (startService, forceEndService)
const _startService = window.startService;
if (typeof _startService === "function"){
  window.startService = async function(pseudo){
    const r = _startService.apply(this, arguments);
    try{
      const start = parseInt(localStorage.getItem(startKey(pseudo))||"0",10) || nowMs();
      const total = parseInt(localStorage.getItem(totalKey(pseudo))||"0",10) || 0;
      const sessions = JSON.parse(localStorage.getItem(sessionsKey(pseudo))||"[]");
      await setDoc(doc(colServices, String(pseudo)), {
        start, totalMs: total, sessions
      }, { merge: true });
      await addDoc(colLogs, { t: nowMs(), by: window.currentPseudo||"‚Äî", text: '"' + String(pseudo) + '" a commenc√© son service' });
    }catch(e){}
    return r;
  };
}

const _forceEndService = window.forceEndService;
if (typeof _forceEndService === "function"){
  window.forceEndService = async function(target, meta){
    const r = _forceEndService.apply(this, arguments);
    try{
      const total = parseInt(localStorage.getItem(totalKey(target))||"0",10) || 0;
      const sessions = JSON.parse(localStorage.getItem(sessionsKey(target))||"[]");
      await setDoc(doc(colServices, String(target)), {
        start: null, totalMs: total, sessions
      }, { merge: true });
      const giver = window.currentPseudo || "‚Äî";
      const reason = meta && meta.reason ? " (raison: " + meta.reason + ")" : "";
      const warn   = meta && meta.warning ? " avec avertissement" : "";
      await addDoc(colLogs, { t: nowMs(), by: giver, text: '"' + String(target) + '" a fini le service' + warn + reason });
    }catch(e){}
    return r;
  };
}

// Warnings (historique int√©gr√© dans sessions). Logging d√©di√©:
if (!window._auditLog){
  window._auditLog = { push: (type, data)=> addDoc(colLogs, { t: nowMs(), by: window.currentPseudo||"‚Äî", type, ...data }) };
}

// Inbox (facultatif)
const _createMessage = window.createMessage;
if (typeof _createMessage === "function"){
  window.createMessage = async function(obj){
    const r = _createMessage.apply(this, arguments);
    try{ await addDoc(colInbox, {...obj, createdAt: nowMs()}); }catch(e){}
    return r;
  };
}


// ===== Robust sync of local pseudos -> Firestore users =====
function readPseudosLocal(){ try { return JSON.parse(localStorage.getItem(PSEUDOS_KEY)||"[]"); } catch { return []; } }
async function upsertUserFromLocal(p){
  if(!p) return;
  let role = "new";
  try {
    const obj = JSON.parse(localStorage.getItem(userKey(p))||"{}");
    role = obj.role || role;
  } catch(e){}
  try {
    await setDoc(doc(colUsers, String(p)), { role, updatedAt: nowMs() }, { merge:true });
  } catch(e){}
}
async function syncAllUsersOnce(){
  const arr = readPseudosLocal().filter(Boolean);
  for (const p of arr) { await upsertUserFromLocal(p); }
  // Also scan user:* keys
  for (let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if (k && k.startsWith('user:')){
      const pseudo = k.slice(5);
      await upsertUserFromLocal(pseudo);
    }
  }
}
syncAllUsersOnce();
window.addEventListener('storage', (e)=>{
  if(!e.key) return;
  if (e.key === PSEUDOS_KEY){
    syncAllUsersOnce();
  }
  if (e.key.startsWith && e.key.startsWith('user:')){
    const pseudo = e.key.slice(5);
    (async()=>{ await upsertUserFromLocal(pseudo); })();
  }
});
setInterval(syncAllUsersOnce, 3000);

console.log("%cFirebase connect√© (mirror Firestore actif).", "color:#9BE59B; font-weight:700");
</script>

</body>
</html>