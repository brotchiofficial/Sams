<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Service + Comptes + Patients (Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <style>
/* ‚Äî‚Äî‚Äî Styles d‚Äôorigine conserv√©s (extraits essentiels) ‚Äî‚Äî‚Äî */
/* === Logs modal boxes === */
.logbox{background: var(--card-soft);border: 1px solid var(--border);border-radius: 10px;padding: 10px;max-height: 76vh;overflow-y: auto; overflow-x: auto;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size: 12.5px;line-height: 1.4;white-space: pre;}
#pf_forceEndBtn{display:none;}
.warning-toast {position: fixed;top: 16px;right: 16px;max-width: 360px;background: #ef7d13;color: #21242B;border: 1px solid rgba(0,0,0,0.2);border-radius: 12px;padding: 12px 16px 12px 14px;box-shadow: 0 8px 28px rgba(0,0,0,0.35);z-index: 9999;display: none;font-family: inherit;}
.warning-toast.show { display: block; }
.warning-toast .wt-header {font-weight: 700;font-size: 14px;margin-bottom: 6px;display:flex; align-items:center; gap:8px;}
.warning-toast .wt-body {font-size: 13px;line-height: 1.35;color: #1a1d23;}
.warning-toast .wt-meta {margin-top: 6px;font-size: 12px;opacity: 0.8;}
.warning-toast .wt-close {margin-left: auto;font-weight: 700;cursor: pointer;user-select: none;padding: 2px 6px;border-radius: 6px;}
.warning-toast .wt-close:hover { background: rgba(0,0,0,0.1); }
:root{--bg:#21242B; --surf:#262A33; --card:#2B3039; --card-soft:#2F3540; --border:#3A404C;--text:#E8ECF3; --muted:#A6AEBB; --primary:#4F8CFF; --primary-weak:#3A68C7;--green:#2ECC71; --red:#E25555; --orange:#F39C12; --shadow:0 8px 30px rgba(0,0,0,.35);--gray:#8B93A2;--glass-bg: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.04));--glass-br: rgba(255,255,255,.18);--glass-hl: rgba(255,255,255,.35);--role-new:#9da3af; --role-certifie:#4F8CFF; --role-technicien:#2ECC71;}
*{ box-sizing:border-box; } body{margin:0; min-height:100vh; background:var(--bg); color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;display:flex; align-items:center; justify-content:center;padding-left: 280px; padding-right: 340px;}
body.warn-border-mid::after, body.warn-border-high::after{content:""; position:fixed; inset:0; pointer-events:none; z-index:100; border-radius:8px;}
body.warn-border-mid::after{ border:4px solid var(--orange); } body.warn-border-high::after{ border:4px solid var(--red); }
.site-logo{ position:fixed; top:10px; left:50%; transform:translateX(-50%); z-index:6; display:none; opacity:.9; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
.site-logo img{ height:32px; }
body.view-service .site-logo, body.view-admin .site-logo{ display:block; }
.glass{background: var(--glass-bg);backdrop-filter: blur(18px) saturate(160%);-webkit-backdrop-filter: blur(18px) saturate(160%);border:1px solid var(--glass-br);box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 var(--glass-hl);}
.overlay.glass, .panel-right.glass{background: rgba(33,36,43,.50);border: 1px solid rgba(255,255,255,.18);box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.35);}
.panel-right.glass input, .panel-right.glass select, .panel-right.glass textarea{background: rgba(20,22,27,.65); border-color: rgba(255,255,255,.20); color:var(--text);}
.overlay{position:fixed; inset:0 auto 0 0; width:260px; padding:14px;border-right:1px solid var(--border);overflow:hidden; display:flex; flex-direction:column; gap:10px;border-top-right-radius:14px; border-bottom-right-radius:14px;z-index:5;}
.overlay h3{ margin:2px 0 6px; font-size:14px; font-weight:700; }
.overlay .list{ overflow:auto; flex:1; padding-right:4px; border-top:1px solid var(--border); margin-top:6px; padding-top:6px; }
.player{ display:flex; flex-direction:column; gap:4px; padding:10px 12px; border-radius:12px; cursor:pointer; transition:background .18s ease; }
.player:hover{ background:rgba(255,255,255,.06); } .player.active{ outline:2px solid rgba(79,140,255,.35); background:rgba(79,140,255,.12); }
.player .head{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
.player .name{ font-weight:700; font-size:13.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.player .status{ font-size:11.5px; color:var(--muted); }
.player .status.green{ color:var(--green); font-weight:700; }
.role-pill{ padding:2px 8px; border-radius:999px; font-size:11px; font-weight:800; line-height:1.6; background:#ddd; color:#111; text-transform:capitalize; }
.role-new{ background:var(--role-new); color:#111; } .role-certifie{ background:var(--role-certifie); color:#fff; } .role-technicien{ background:var(--role-technicien); color:#0f1a12; }
.hint-sm{ font-size:11px; color:var(--muted); text-align:center; margin-top:-2px; }
.panel-right{position:fixed; inset:0 0 0 auto; width:320px; padding:12px;border-left:1px solid var(--border);display:flex; flex-direction:column; gap:8px;border-top-left-radius:14px; border-bottom-left-radius:14px;z-index:5;}
.panel-right h3{ margin:2px 0 2px; font-size:14px; font-weight:800; }
.panel-right .actions{ display:flex; gap:8px; }
.panel-right .btn-lite{ flex:1; padding:9px 10px; border-radius:10px; background:rgba(79,140,255,.14); border:1px solid var(--glass-br); cursor:pointer; font-weight:700; }
.panel-right .btn-lite:hover{ background:rgba(79,140,255,.2); }
.panel-right .search{ display:flex; }
.panel-right input, .panel-right select, .panel-right textarea{ width:100%; padding:8px 10px; border:1px solid var(--glass-br); border-radius:10px; font-size:13px; }
.panel-right .list{ overflow:auto; flex:1; border-top:1px solid var(--border); padding-top:6px; }
.patient-row{ padding:8px 10px; border-radius:10px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background .18s ease; }
.patient-row:hover{ background:rgba(255,255,255,.06); }
.patient-name{ font-weight:600; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.patient-meta{ font-size:11px; color:var(--muted); }
.box{ background:var(--card); padding:2rem; border-radius:14px; box-shadow:var(--shadow); width:min(92vw, 520px); text-align:center; border:1px solid var(--border); }
input.main, button.main, select.main, textarea.main{width:100%; padding:10px 12px; margin:.5rem 0; border-radius:10px; border:1px solid var(--border); font-size:1rem; background:#252A33; color:var(--text);}
button.main{ border:1px solid transparent; background:var(--primary); color:#fff; cursor:pointer; font-weight:700; transition:filter .18s ease, background .18s ease; }
button.main:hover{ background:var(--primary-weak); }
.btn{ flex:1; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:700;}
.start{ background: var(--green); color:#0f1a12;} .end{ background: var(--red); color:#fff;}
.home{ background:#6c757d; color:#fff;} .btn:disabled{ opacity:.6; cursor:not-allowed;}
.msg{ margin-top:.4rem; font-size:.9em;} .ok{ color:var(--green);} .error{ color:#FF8A8A;}
.timer{ margin-top:.75rem; font-weight:800; font-size:1.35rem; letter-spacing:.5px;}
.subtle{ color:var(--muted); font-size:.9rem; margin-top:.2rem;}
.grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:14px; text-align:left; }
.card{ background:var(--card-soft); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
.label{ font-size:.85rem; color:var(--muted); } .value{ font-weight:800; font-size:1.05rem; margin-top:2px; color:var(--text); }
.admin-box{ background:var(--card); padding:1.2rem; border-radius:14px; box-shadow:var(--shadow); width:min(96vw, 1200px); border:1px solid var(--border); }
.admin-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;}
.admin-title{ font-size:1.2rem; font-weight:800;} .admin-actions{ display:flex; gap:10px; }
.btn-sm{ padding:.55rem .8rem; border-radius:10px; border:1px solid var(--border); cursor:pointer; color:#fff; background:#3B4250; }
.btn-sm:hover{ filter:brightness(1.05); } .btn-sm.danger{ background:#B24B4B;}
table{ width:100%; border-collapse:separate; border-spacing:0; color:var(--text); } th, td{ text-align:left; padding:.6rem .7rem; font-size:.95rem; }
thead th{ position:sticky; top:0; background:#2C3240; border-bottom:1px solid var(--border); z-index:1;}
tbody tr:nth-child(odd){ background:#292F3A;} tbody tr:nth-child(even){ background:#262C36;} tbody tr:hover{ background:#313846;}
.td-actions{ display:flex; gap:8px; flex-wrap:wrap; } .pill{ font-size:.8rem; padding:.25rem .5rem; border-radius:999px; color:#fff; }
.pill.green{ background:var(--green);} .pill.gray{ background:#6B7382;}
.role-select{ background:#2E3442; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:.35rem .5rem; font-size:.9rem; }
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:16px; z-index:50;}
#patientHistoryModal { z-index: 55; } #patientDetailsModal { z-index: 60; }
.modal{ width:min(92vw, 760px); background:var(--card); border-radius:14px; box-shadow:0 12px 40px rgba(0,0,0,.45); padding:18px; border:1px solid var(--border); }
.modal h3{ margin:0 0 8px; font-size:1.2rem; }
.modal .row2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.modal .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
.modal .actions{ display:flex; gap:10px; margin-top:12px; }
.logo-big{ width:140px; display:block; margin:0 auto 8px; filter: drop-shadow(0 8px 24px rgba(0,0,0,.35)); }
.warn-card{ cursor:default; transition:box-shadow .18s ease, transform .08s ease; }
.warn-card.clickable{ cursor:pointer; } .warn-ok{ border-color:#2c3e50; } .warn-mid{ border-color:var(--orange); box-shadow:0 0 0 2px rgba(243,156,18,.25) inset; }
.warn-high{ border-color:var(--red); box-shadow:0 0 0 2px rgba(226,85,85,.25) inset; }
.warn-item{ padding:10px 12px; border-radius:10px; background:#2b313c; border:1px solid var(--border); margin-top:8px; }
.warn-item .wi-head{ display:flex; justify-content:space-between; gap:8px; font-size:.9rem; color:var(--muted); }
.warn-item .wi-reason{ margin-top:6px; white-space:pre-wrap; } .warn-actions{ display:flex; gap:8px; align-items:center; }
.warn-global-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
.badge-warn{ padding:2px 8px; border-radius:999px; font-size:11px; font-weight:900; line-height:1.6; background:#2E3442; color:#fff; display:inline-block; }
.badge-warn.mid{ background:var(--orange); color:#111; } .badge-warn.high{ background:var(--red); color:#fff; }
.topbar{position:fixed; top:8px; left:50%; transform:translateX(110px);z-index:7; display:none; align-items:center; gap:10px;}
.mail-btn{position:relative;display:inline-flex; align-items:center; justify-content:center;width:38px; height:38px; border-radius:999px; border:1px solid var(--glass-br);background: rgba(33,36,43,.50); box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.35);cursor:pointer; font-size:20px; line-height:1; transition:transform .06s ease, filter .18s ease;}
.mail-btn:active{ transform:scale(.98); }
.mail-badge{position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; padding:0 5px;border-radius:999px; background:var(--red); color:#fff; font-size:11px; font-weight:900;display:none; align-items:center; justify-content:center; border:2px solid rgba(33,36,43,.85);}
#inboxModal{ z-index:65; } .inbox-list{ max-height:52vh; overflow:auto; border-top:1px solid var(--border); padding-top:8px; margin-top:6px; }
.msg-card{ padding:10px 12px; border-radius:10px; background:#2b313c; border:1px solid var(--border); margin-top:8px; }
.msg-head{ display:flex; justify-content:space-between; gap:10px; font-size:.9rem; color:var(--muted); }
.msg-title{ font-weight:800; color:var(--text); }
.msg-actions{ display:flex; gap:8px; align-items:center; margin-top:8px; }
.badge-unread{ padding:2px 6px; border-radius:999px; background:var(--primary); color:#fff; font-size:11px; font-weight:900; }
.compose-area{ margin-top:10px; border-top:1px solid var(--border); padding-top:8px; }
.toast-container{position:fixed; top:12px; right:12px; display:flex; flex-direction:column; gap:10px;z-index:90; pointer-events:none;}
.toast{pointer-events:auto;min-width:280px; max-width:380px;background:rgba(243,156,18,.18); border:1px solid rgba(243,156,18,.55);color:#fff; border-radius:12px; padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.25);backdrop-filter:blur(12px) saturate(140%); -webkit-backdrop-filter:blur(12px) saturate(140%);}
.toast .t-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.toast .t-title{ font-weight:900; color:#F39C12; font-size:14px; letter-spacing:.2px; }
.toast .t-close{ cursor:pointer; border:none; background:transparent; color:#fff; font-size:18px; line-height:1; }
.toast .t-body{ margin-top:6px; font-size:13.2px; white-space:pre-wrap; }
@media (max-width: 1080px){
  body{ padding-left:0; padding-right:0; }
  .overlay{ width:100%; height:46%; inset:auto 0 0 0; border-right:none; border-top:1px solid var(--border); border-radius:0; }
  .panel-right{ width:100%; height:48%; inset:0 0 auto 0; border-left:none; border-bottom:1px solid var(--border); border-radius:0; }
  .site-logo img{ height:28px; } .logo-big{ width:120px; } .topbar{ left:auto; right:12px; transform:none; top:8px; }
}
/* Banni√®re Firestore indisponible */
#fsUnavailable{ position:fixed; top:8px; right:8px; background:#ef7d13; color:#1a1d23; border:1px solid rgba(0,0,0,.2); border-radius:10px; padding:8px 12px; z-index:9999; display:none; font-weight:700; }
  </style>
</head>
<body>
  <div class="site-logo" aria-hidden="true" id="siteLogo"><img src="logo.png" alt="Logo"></div>
  <div id="fsUnavailable">‚ö†Ô∏è Firestore inaccessible</div>

  <!-- TOPBAR (ic√¥ne courrier visible pour admin/technicien) -->
  <div class="topbar" id="topbar">
    <button class="mail-btn" id="mailBtn" title="Bo√Æte de r√©ception">üì¨
      <span class="mail-badge" id="mailBadge"></span>
    </button>
  </div>

  <!-- OVERLAY gauche -->
  <aside class="overlay glass" id="overlay">
    <h3>Joueurs</h3>
    <div class="list" id="playersList"></div>
    <div class="hint-sm">Clique un pseudo pour voir son profil</div>
  </aside>

  <!-- PANNEAU DROIT patients -->
  <aside class="panel-right glass" id="panelRight" style="display:none;">
    <h3>Patients</h3>
    <div class="actions" id="panelRightActions" style="display:none;">
      <button class="btn-lite" id="btnNewPatient">‚ûï Nouvelle fiche patient</button>
    </div>
    <div class="search"><input id="patientSearch" placeholder="Rechercher (nom, pr√©nom)‚Ä¶"></div>
    <div class="list" id="patientList"></div>
  </aside>

  <!-- ACCUEIL / LOGIN -->
  <div class="box" id="pseudoBox">
    <img class="logo-big" src="logo.png" alt="Logo">
    <h2>Identification</h2>
    <input class="main" id="pseudoInput" placeholder="Entrez un pseudo" required>
    <button class="main" id="pseudoBtn">Continuer</button>
    <div id="passwordArea" style="display:none; margin-top:.5rem;">
      <label id="pwdLabel" for="passwordInput" style="display:block; text-align:left; font-size:.95rem; margin:.25rem 0;">Mot de passe</label>
      <input class="main" id="passwordInput" type="password" placeholder="Mot de passe">
      <button class="main" id="passwordBtn">Valider</button>
      <button class="mutelink" id="changePseudoBtn" type="button">Changer de pseudo</button>
    </div>
    <p id="message" class="msg"></p>
  </div>

  <!-- SERVICE -->
  <div class="box" id="serviceBox" style="display:none;">
    <h2 id="welcome"></h2>
    <div id="timer" class="timer">0h00</div>
    <div class="subtle">(heures et minutes, persistant au rechargement)</div>
    <div class="row" style="margin-top:10px;">
      <button class="btn start" id="startBtn">üöÄ D√©but</button>
      <button class="btn end" id="endBtn">‚èπÔ∏è Fin</button>
    </div>
    <div class="grid">
      <div class="card"><div class="label">Pseudo</div><div class="value" id="statPseudo">-</div></div>
      <div class="card"><div class="label">R√¥le</div><div class="value" id="statRole">-</div></div>
      <div class="card"><div class="label">Compte cr√©√© le</div><div class="value" id="statCreated">-</div></div>
      <div class="card"><div class="label">Temps total</div><div class="value" id="statTotal">0h00</div></div>
      <div class="card"><div class="label">Temps semaine (lun-dim)</div><div class="value" id="statWeek">0h00</div></div>
    </div>
    <button class="btn home" style="margin-top:12px;" id="homeBtn">üè† Accueil</button>
    <p id="status" class="msg"></p>
  </div>

  <!-- ADMIN -->
  <div class="admin-box" id="adminBox" style="display:none;">
    <div class="admin-header">
      <div class="admin-title">üëë Panneau d‚Äôadministration</div>
      <div class="admin-actions">
        <button class="btn-sm" id="adminHomeBtn">üè† Accueil</button>
        <button class="btn-sm danger" id="deleteAllUsersBtn">üóëÔ∏è Supprimer tous les joueurs</button>
      </div>
    </div>
    <div style="overflow:auto; max-height:70vh;">
      <table id="adminTable">
        <thead><tr>
          <th>Pseudo</th><th>R√¥le</th><th>Statut</th><th>Timer actuel</th><th>Total cumul√©</th><th>Avertissements</th><th>Cr√©√© le</th><th>Actions</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div class="admin-actions" id="logsBar" style="margin-top:10px; display:none;">
    <button class="btn-sm" id="openLogsBtn">üìú Logs</button>
    <span class="subtle" style="font-size:12px;">Historique des 24 derni√®res heures</span>
  </div>

  <!-- PROFIL JOUEUR -->
  <div class="modal-backdrop" id="profileModal">
    <div class="modal">
      <h3 id="pf_title">üë§ Profil joueur</h3>
      <div class="grid" style="margin-top:6px;">
        <div class="card"><div class="label">Pseudo</div><div class="value" id="pf_pseudo">-</div></div>
        <div class="card"><div class="label">R√¥le</div><div class="value" id="pf_role">-</div></div>
        <div class="card" id="pf_roleEditor" style="display:none;">
          <div class="label">Changer le r√¥le</div>
          <select class="main" id="pf_roleSelect">
            <option value="NEW">new</option>
            <option value="CERTIFI√â">certifi√©</option>
            <option value="TECH">technicien</option>
          </select>
          <div class="subtle">üí° Visible pour ADMIN uniquement (conform√©ment aux r√®gles).</div>
        </div>
        <div class="card"><div class="label">Cr√©√© le</div><div class="value" id="pf_created">-</div></div>
        <div class="card"><div class="label">Statut</div><div class="value" id="pf_status">-</div></div>
        <div class="card"><div class="label">Timer actuel</div><div class="value" id="pf_current">0h00</div></div>
        <div class="card"><div class="label">Semaine</div><div class="value" id="pf_week">0h00</div></div>
        <div class="card"><div class="label">Total cumul√©</div><div class="value" id="pf_total">0h00</div></div>
        <div class="card warn-card" id="pf_warnCard" title="">
          <div class="label" id="pf_warnLabel">Avertissements</div>
          <div class="value" id="pf_warnCount">0</div>
          <div class="subtle" id="pf_warnHint" style="display:none;">Cliquer pour voir l‚Äôhistorique</div>
        </div>
      </div>
      <div class="actions">
        <button class="main end" id="pf_forceEndBtn">‚èπÔ∏è Finir son service</button>
        <button class="main" style="background:#3B4250" id="pf_closeBtn">Fermer</button>
      </div>
      <div id="pf_msg" class="msg"></div>
    </div>
  </div>

  <!-- MODALE fin de service -->
  <div class="modal-backdrop" id="endReasonModal">
    <div class="modal">
      <h3 id="er_title">üìù Terminer le service</h3>
      <div class="row2">
        <textarea class="main" id="er_reason" rows="4" placeholder="Raison (obligatoire)"></textarea>
        <div>
          <label class="label" for="er_warning">Avertissement</label>
          <select class="main" id="er_warning">
            <option value="no">Non</option>
            <option value="yes">Oui</option>
          </select>
          <div class="subtle">Enregistr√© avec la session.</div>
        </div>
      </div>
      <div class="actions">
        <button class="main end" id="er_confirmBtn">Valider et terminer</button>
        <button class="main" style="background:#3B4250" id="er_cancelBtn">Annuler</button>
      </div>
      <div id="er_msg" class="msg"></div>
    </div>
  </div>

  <!-- Historique avertissements -->
  <div class="modal-backdrop" id="warnHistoryModal">
    <div class="modal">
      <h3 id="wh_title">üìí Historique des avertissements</h3>
      <div id="wh_list"></div>
      <div class="warn-global-actions" id="wh_global" style="display:none;">
        <button class="main end" id="wh_deleteAllBtn">üóëÔ∏è Supprimer tous</button>
      </div>
      <div class="actions">
        <button class="main" style="background:#3B4250" id="wh_closeBtn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Nouvelle fiche patient -->
  <div class="modal-backdrop" id="patientModal">
    <div class="modal">
      <h3>‚ûï Nouvelle fiche patient</h3>
      <h4 style="margin:.4rem 0 .2rem">Informations patient</h4>
      <div class="row3">
        <input class="main" id="np_nom" placeholder="Nom *">
        <input class="main" id="np_prenom" placeholder="Pr√©nom *">
        <select class="main" id="np_sexe">
          <option value="">Sexe</option>
          <option>H</option>
          <option>F</option>
          <option>Autre</option>
        </select>
      </div>
      <div class="row3">
        <input class="main" id="np_dob" type="date" placeholder="Date de naissance">
        <input class="main" id="np_age" type="number" min="0" placeholder="√Çge" disabled>
        <input class="main" id="np_tel" placeholder="T√©l√©phone">
      </div>
      <div class="row3">
        <input class="main" id="np_taille" type="number" step="0.1" placeholder="Taille (cm)">
        <input class="main" id="np_poid" type="number" step="0.1" placeholder="Poids (kg)">
        <select class="main" id="np_groupe">
          <option value="">Groupe sanguin</option>
          <option>O+</option><option>O-</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </div>
      <textarea class="main" id="np_allergies" rows="2" placeholder="Allergies"></textarea>

      <h4 style="margin:.8rem 0 .2rem">Commentaire</h4>
      <textarea class="main" id="np_commentaire" rows="5" placeholder="Commentaire (libre)‚Ä¶"></textarea>

      <h4 style="margin:.8rem 0 .2rem">Fiche bilan</h4>
      <div class="row3">
        <input class="main" id="np_staff" placeholder="Personnel en charge">
        <input class="main" id="np_nature" placeholder="Nature de la blessure">
        <input class="main" id="np_typeBlessure" placeholder="Type de blessure">
      </div>
      <div class="row3">
        <select class="main" id="np_gravite">
          <option value="">Gravit√©</option>
          <option>Faible</option><option>Moyenne</option><option>√âlev√©e</option><option>Critique</option>
        </select>
        <input class="main" id="np_soins" placeholder="Soins prodigu√©s (court)">
        <input class="main" id="np_prise" placeholder="Type de prise en charge">
      </div>
      <div class="row3">
        <select class="main" id="np_irm"><option value="">IRM</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="np_scanner"><option value="">Scanner</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="np_operation"><option value="">Op√©ration</option><option>Non</option><option>Oui</option></select>
      </div>

      <div class="actions">
        <button class="main" id="btnSavePatient">Enregistrer</button>
        <button class="main" style="background:#3B4250" id="btnCancelPatient">Annuler</button>
      </div>
      <div id="patientMsg" class="msg"></div>
    </div>
  </div>

  <!-- D√©tails / modif patient -->
  <div class="modal-backdrop" id="patientDetailsModal">
    <div class="modal">
      <h3 id="pd_title">üë§ D√©tails du patient</h3>

      <h4 style="margin:.4rem 0 .2rem">Informations patient</h4>
      <div class="row3">
        <input class="main" id="pd_nom" placeholder="Nom *" disabled>
        <input class="main" id="pd_prenom" placeholder="Pr√©nom *" disabled>
        <select class="main" id="pd_sexe" disabled>
          <option value="">Sexe</option>
          <option>H</option><option>F</option><option>Autre</option>
        </select>
      </div>
      <div class="row3">
        <input class="main" id="pd_dob" type="date" placeholder="Date de naissance" disabled>
        <input class="main" id="pd_age" type="number" min="0" placeholder="√Çge" disabled>
        <input class="main" id="pd_tel" placeholder="T√©l√©phone" disabled>
      </div>
      <div class="row3">
        <input class="main" id="pd_taille" type="number" step="0.1" placeholder="Taille (cm)" disabled>
        <input class="main" id="pd_poid" type="number" step="0.1" placeholder="Poids (kg)" disabled>
        <select class="main" id="pd_groupe" disabled>
          <option value="">Groupe sanguin</option>
          <option>O+</option><option>O-</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option>
        </select>
      </div>
      <textarea class="main" id="pd_allergies" rows="2" placeholder="Allergies" disabled></textarea>

      <h4 style="margin:.8rem 0 .2rem">Commentaire</h4>
      <textarea class="main" id="pd_commentaire" rows="5" placeholder="Commentaire (libre)‚Ä¶" disabled></textarea>

      <h4 style="margin:.8rem 0 .2rem">Fiche bilan</h4>
      <div class="row3">
        <input class="main" id="pd_staff" placeholder="Personnel en charge" disabled>
        <input class="main" id="pd_nature" placeholder="Nature de la blessure" disabled>
        <input class="main" id="pd_typeBlessure" placeholder="Type de blessure" disabled>
      </div>
      <div class="row3">
        <select class="main" id="pd_gravite" disabled>
          <option value="">Gravit√©</option>
          <option>Faible</option><option>Moyenne</option><option>√âlev√©e</option><option>Critique</option>
        </select>
        <input class="main" id="pd_soins" placeholder="Soins prodigu√©s (court)" disabled>
        <input class="main" id="pd_prise" placeholder="Type de prise en charge" disabled>
      </div>
      <div class="row3">
        <select class="main" id="pd_irm" disabled><option value="">IRM</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="pd_scanner" disabled><option value="">Scanner</option><option>Non</option><option>Oui</option></select>
        <select class="main" id="pd_operation" disabled><option value="">Op√©ration</option><option>Non</option><option>Oui</option></select>
      </div>

      <h4 style="margin:.8rem 0 .2rem">M√©tadonn√©es</h4>
      <div class="row3">
        <div class="card"><div class="label">Cr√©√©e par</div><div class="value" id="pd_metaCreatedBy">‚Äî</div></div>
        <div class="card"><div class="label">Cr√©√©e le</div><div class="value" id="pd_metaCreatedAt">‚Äî</div></div>
        <div class="card"><div class="label">Derni√®re modification</div><div class="value"><span id="pd_metaModifiedBy">‚Äî</span><span class="subtle"> ¬∑ </span><span id="pd_metaModifiedAt">‚Äî</span></div></div>
      </div>

      <div class="actions">
        <button class="main" id="pd_editBtn">‚úèÔ∏è Modifier</button>
        <button class="main" id="pd_saveBtn" style="display:none;">üíæ Enregistrer</button>
        <button class="main end" id="pd_deleteBtn" style="display:none;">üóëÔ∏è Supprimer</button>
        <button class="main" style="background:#3B4250" id="pd_closeBtn">Fermer</button>
      </div>
      <div id="pd_msg" class="msg"></div>
    </div>
  </div>

  <!-- Modale LOGS -->
  <div class="modal-backdrop" id="logsModal">
    <div class="modal" style="width:min(92vw, 820px); max-height:92vh; display:flex; flex-direction:column;">
      <h3>üìú Logs (24h)</h3>
      <div class="subtle" style="margin-bottom:8px;">Mise √† jour en continu ‚Ä¢ purge automatique au-del√† de 24h</div>
      <div class="row2" style="grid-template-columns: 2fr 1fr; gap:12px;">
        <div id="logsText" class="logbox"></div>
        <div id="logsTimes" class="logbox"></div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="main" style="background:#3B4250" id="logsCloseBtn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Acc√®s ADMIN (5 clics logo) -->
  <div class="modal-backdrop" id="adminGateModal">
    <div class="modal" style="width:min(92vw, 520px)">
      <h3>üîê Acc√®s administrateur</h3>
      <label for="adminPwd" style="display:block; text-align:left; font-size:.95rem; margin:.25rem 0;">Mot de passe</label>
      <input class="main" id="adminPwd" type="password" placeholder="Mot de passe admin">
      <div id="adminGateMsg" class="msg" style="margin-top:.5rem;"></div>
      <div class="actions">
        <button class="main" style="background:#3B4250" id="adminGateCancel">Annuler</button>
        <button class="main" id="adminGateOk">Se connecter</button>
      </div>
    </div>
  </div>

  <!-- Boite de r√©ception commune -->
  <div class="modal-backdrop" id="inboxModal">
    <div class="modal" style="width:min(92vw, 820px); max-height:84vh; display:flex; flex-direction:column;">
      <h3>üì¨ Bo√Æte de r√©ception</h3>
      <div class="inbox-list" id="inboxList"></div>

      <div class="compose-area" id="composeArea" style="display:none;">
        <h4 style="margin:.6rem 0 .2rem">Nouveau message</h4>
        <input class="main" id="in_subject" placeholder="Sujet *">
        <textarea class="main" id="in_body" rows="4" placeholder="Message *"></textarea>
        <div class="actions">
          <button class="main" id="in_sendBtn">Envoyer</button>
          <button class="main" style="background:#3B4250" id="in_cancelBtn">Annuler</button>
        </div>
      </div>

      <div class="actions" style="margin-top:12px;">
        <button class="main" id="in_newBtn" style="display:none;">‚úâÔ∏è Nouveau</button>
        <button class="main" style="background:#3B4250" id="in_closeBtn">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Conteneur de toasts -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

<script type="module">
/* ===== Firebase (SDK modulaire) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, connectFirestoreEmulator, doc, getDoc, setDoc, updateDoc, addDoc, collection, onSnapshot, query, where, orderBy, limit, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ‚Äî‚Äî‚Äî CONFIG A REMPLIR ‚Äî‚Äî‚Äî */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ====== R√¥les & helpers ====== */
const ROLES = ["NEW","CERTIFI√â","TECH","ADMIN"];
const roleLabel = r => (r==="ADMIN"?"admin":r==="TECH"?"technicien":r==="CERTIFI√â"?"certifi√©":"new");
const roleClass = r => r==="TECH"?"role-technicien":(r==="CERTIFI√â"?"role-certifie":"role-new");

let ctx = {
  me: null,           // Firebase user
  mePseudo: null,     // pseudo courant
  meRole: "NEW",      // r√¥le courant (depuis usersByUid)
  unsub: {},          // gestion des abonnements
  services: {},       // cache services (admin)
  users: [],          // cache users
  patients: [],       // cache patients (limit√©s)
  inbox: [],          // cache inbox
  viewing: { profile: null, patient: null }
};

/* ====== S√©lecteurs ====== */
const pseudoBox   = document.getElementById('pseudoBox');
const pseudoInput = document.getElementById('pseudoInput');
const pseudoBtn   = document.getElementById('pseudoBtn');
const passwordArea= document.getElementById('passwordArea');
const passwordInput = document.getElementById('passwordInput');
const passwordBtn = document.getElementById('passwordBtn');
const changePseudoBtn = document.getElementById('changePseudoBtn');
const message     = document.getElementById('message');

const serviceBox  = document.getElementById('serviceBox');
const welcome     = document.getElementById('welcome');
const timerEl     = document.getElementById('timer');
const statPseudo  = document.getElementById('statPseudo');
const statRole    = document.getElementById('statRole');
const statCreated = document.getElementById('statCreated');
const statTotal   = document.getElementById('statTotal');
const statWeek    = document.getElementById('statWeek');
const startBtn    = document.getElementById('startBtn');
const endBtn      = document.getElementById('endBtn');
const homeBtn     = document.getElementById('homeBtn');
const statusMsg   = document.getElementById('status');

const overlayEl   = document.getElementById('playersList');
const panelRight  = document.getElementById('panelRight');
const panelRightActions = document.getElementById('panelRightActions');
const patientList = document.getElementById('patientList');
const patientSearch = document.getElementById('patientSearch');
const btnNewPatient = document.getElementById('btnNewPatient');

const adminBox    = document.getElementById('adminBox');
const adminHomeBtn= document.getElementById('adminHomeBtn');
const adminTable  = document.querySelector('#adminTable tbody');
const deleteAllUsersBtn = document.getElementById('deleteAllUsersBtn');
const logsBar     = document.getElementById('logsBar');
const openLogsBtn = document.getElementById('openLogsBtn');

const topbar      = document.getElementById('topbar');
const mailBtn     = document.getElementById('mailBtn');
const mailBadge   = document.getElementById('mailBadge');

const siteLogo    = document.getElementById('siteLogo');
const adminGateModal = document.getElementById('adminGateModal');
const adminPwd    = document.getElementById('adminPwd');
const adminGateMsg= document.getElementById('adminGateMsg');
const adminGateCancel = document.getElementById('adminGateCancel');
const adminGateOk = document.getElementById('adminGateOk');

const fsBanner    = document.getElementById('fsUnavailable');

/* Patient modales */
const patientModal= document.getElementById('patientModal');
const btnSavePatient = document.getElementById('btnSavePatient');
const btnCancelPatient = document.getElementById('btnCancelPatient');
const patientMsg  = document.getElementById('patientMsg');
const np = (id)=>document.getElementById(id);
const np_nom = np('np_nom'), np_prenom=np('np_prenom'), np_sexe=np('np_sexe'), np_dob=np('np_dob'), np_age=np('np_age'),
      np_tel=np('np_tel'), np_taille=np('np_taille'), np_poid=np('np_poid'), np_groupe=np('np_groupe'),
      np_allergies=np('np_allergies'), np_commentaire=np('np_commentaire'), np_staff=np('np_staff'),
      np_nature=np('np_nature'), np_typeBlessure=np('np_typeBlessure'), np_gravite=np('np_gravite'),
      np_soins=np('np_soins'), np_prise=np('np_prise'), np_irm=np('np_irm'), np_scanner=np('np_scanner'), np_operation=np('np_operation');

/* Patient d√©tails */
const pdModal   = document.getElementById('patientDetailsModal');
const pd = (id)=>document.getElementById(id);
const pd_nom = pd('pd_nom'), pd_prenom=pd('pd_prenom'), pd_sexe=pd('pd_sexe'), pd_dob=pd('pd_dob'), pd_age=pd('pd_age'),
      pd_tel=pd('pd_tel'), pd_taille=pd('pd_taille'), pd_poid=pd('pd_poid'), pd_groupe=pd('pd_groupe'),
      pd_allergies=pd('pd_allergies'), pd_commentaire=pd('pd_commentaire'), pd_staff=pd('pd_staff'),
      pd_nature=pd('pd_nature'), pd_typeBlessure=pd('pd_typeBlessure'), pd_gravite=pd('pd_gravite'),
      pd_soins=pd('pd_soins'), pd_prise=pd('pd_prise'), pd_irm=pd('pd_irm'), pd_scanner=pd('pd_scanner'), pd_operation=pd('pd_operation'),
      pd_editBtn=pd('pd_editBtn'), pd_saveBtn=pd('pd_saveBtn'), pd_deleteBtn=pd('pd_deleteBtn'),
      pd_closeBtn=pd('pd_closeBtn'), pd_msg=pd('pd_msg'),
      pd_title=pd('pd_title'), pd_metaCreatedBy=pd('pd_metaCreatedBy'), pd_metaCreatedAt=pd('pd_metaCreatedAt'),
      pd_metaModifiedBy=pd('pd_metaModifiedBy'), pd_metaModifiedAt=pd('pd_metaModifiedAt');

/* Profil joueur / avertissements */
const profileModal = document.getElementById('profileModal');
const pf = (id)=>document.getElementById(id);
const pf_pseudo = pf('pf_pseudo'), pf_role = pf('pf_role'), pf_roleEditor = pf('pf_roleEditor'), pf_roleSelect = pf('pf_roleSelect'),
      pf_created = pf('pf_created'), pf_status = pf('pf_status'), pf_current = pf('pf_current'), pf_week = pf('pf_week'), pf_total = pf('pf_total'),
      pf_warnCard = pf('pf_warnCard'), pf_warnLabel = pf('pf_warnLabel'), pf_warnCount = pf('pf_warnCount'),
      pf_forceEndBtn = pf('pf_forceEndBtn'), pf_closeBtn = pf('pf_closeBtn');

const endReasonModal = document.getElementById('endReasonModal');
const er_reason = document.getElementById('er_reason'), er_warning=document.getElementById('er_warning'),
      er_confirmBtn=document.getElementById('er_confirmBtn'), er_cancelBtn=document.getElementById('er_cancelBtn'),
      er_msg=document.getElementById('er_msg');

const warnHistoryModal = document.getElementById('warnHistoryModal');
const wh_list = document.getElementById('wh_list'), wh_closeBtn = document.getElementById('wh_closeBtn'), wh_deleteAllBtn = document.getElementById('wh_deleteAllBtn');

/* Inbox */
const inboxModal = document.getElementById('inboxModal');
const inboxList  = document.getElementById('inboxList');
const composeArea= document.getElementById('composeArea');
const in_newBtn  = document.getElementById('in_newBtn');
const in_closeBtn= document.getElementById('in_closeBtn');
const in_subject = document.getElementById('in_subject');
const in_body    = document.getElementById('in_body');
const in_sendBtn = document.getElementById('in_sendBtn');
const in_cancelBtn=document.getElementById('in_cancelBtn');

/* ====== Utils UI ====== */
const show = (el, v=true)=>{ if(!el) return; el.style.display = v? "flex":"none"; };
const showBlock = (el, v=true)=>{ if(!el) return; el.style.display = v? "block":"none"; };
const showInline = (el, v=true)=>{ if(!el) return; el.style.display = v? "inline-block":"none"; };
const fmtDate = ts=>ts? new Date(ts).toLocaleString() : "‚Äî";
const msToHM = ms => { const t=Math.floor(ms/60000), h=Math.floor(t/60), m=t%60; return `${h}h${String(m).padStart(2,"0")}`; };

/* ====== Connexion & banni√®re Firestore ====== */
function setFsBanner(on){ showBlock(fsBanner, !!on); }
window.addEventListener('online', ()=>setFsBanner(false));
window.addEventListener('offline', ()=>setFsBanner(true));

/* ====== Auth flow ====== */
pseudoBtn?.addEventListener('click', ()=>{
  const p = (pseudoInput.value||"").trim().toLowerCase();
  if(!p){ message.textContent="Saisis un pseudo."; message.className="msg error"; return; }
  passwordArea.style.display = "block";
  message.textContent="";
});
changePseudoBtn?.addEventListener('click', ()=>{
  passwordArea.style.display="none";
  message.textContent="";
});
passwordBtn?.addEventListener('click', async ()=>{
  const p = (pseudoInput.value||"").trim().toLowerCase();
  const pwd = passwordInput.value;
  if(!p || !pwd){ message.textContent="Pseudo + mot de passe requis."; message.className="msg error"; return; }
  const email = `${p}@monjeu.local`;
  try{
    await signInWithEmailAndPassword(auth, email, pwd);
  }catch(e){
    if(e.code === "auth/user-not-found"){
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pwd);
        await setDoc(doc(db,"usersByUid", cred.user.uid), { pseudo:p, role:"NEW" });
        await setDoc(doc(db,"users", p), { pseudo:p, role:"NEW" });
      }catch(e2){
        message.textContent = "Cr√©ation impossible: "+(e2.message||e2.code);
        message.className = "msg error";
        return;
      }
    }else{
      message.textContent = "Mot de passe incorrect ou compte invalide.";
      message.className = "msg error";
      return;
    }
  }
});

onAuthStateChanged(auth, async (user)=>{
  ctx.me = user;
  if(!user){
    ctx.mePseudo = null; ctx.meRole = "NEW";
    showBlock(pseudoBox, true);
    showBlock(serviceBox, false);
    showBlock(adminBox, false);
    document.body.classList.remove("view-service","view-admin");
    unsubscribeAll();
    return;
  }
  // fetch usersByUid for role + pseudo
  try{
    const udoc = await getDoc(doc(db,"usersByUid", user.uid));
    if(udoc.exists()){
      ctx.mePseudo = udoc.data().pseudo;
      ctx.meRole   = udoc.data().role || "NEW";
    }else{
      // bootstrap si manquant
      const guessPseudo = (user.email||"").split("@")[0];
      ctx.mePseudo = guessPseudo;
      ctx.meRole = "NEW";
      await setDoc(doc(db,"usersByUid", user.uid), { pseudo: ctx.mePseudo, role: "NEW" });
      await setDoc(doc(db,"users", ctx.mePseudo),   { pseudo: ctx.mePseudo, role: "NEW" });
    }
    postLoginSetup();
  }catch(err){
    console.error(err);
    setFsBanner(true);
  }
});

function unsubscribeAll(){
  for(const k of Object.keys(ctx.unsub)){ try{ ctx.unsub[k](); }catch{} }
  ctx.unsub = {};
}

function postLoginSetup(){
  showBlock(pseudoBox, false);
  showBlock(serviceBox, true);
  document.body.classList.add("view-service"); document.body.classList.remove("view-admin");
  welcome.textContent = `Bienvenue ${ctx.mePseudo}`;
  statPseudo.textContent = ctx.mePseudo;
  statRole.textContent = roleLabel(ctx.meRole);
  topbar.style.display = (ctx.meRole === "TECH" || ctx.meRole === "ADMIN") ? "flex" : "none";
  panelRightActions.style.display = (ctx.meRole === "TECH" || ctx.meRole === "ADMIN" || ctx.meRole === "CERTIFI√â") ? "flex" : "none";

  // overlay users
  if(ctx.unsub.users) ctx.unsub.users();
  ctx.unsub.users = onSnapshot(collection(db,"users"), (snap)=>{
    ctx.users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderOverlay();
  }, (err)=>{
    console.warn("users onSnapshot error", err);
    if(err.code === "unavailable") setFsBanner(true);
  });

  // current service
  if(ctx.unsub.myService) ctx.unsub.myService();
  ctx.unsub.myService = onSnapshot(doc(db,"services", ctx.mePseudo), (docSnap)=>{
    const sv = docSnap.data()||{ status:"out", totalMs:0, startAt:null, sessions:[], warnings:[] };
    updateServiceUI(sv);
  }, (err)=>{
    console.warn("service onSnapshot error", err);
  });

  // patients (limit 500)
  if(ctx.unsub.patients) ctx.unsub.patients();
  const qPatients = query(collection(db,"patients"), orderBy("createdAt","desc"), limit(500));
  ctx.unsub.patients = onSnapshot(qPatients, (snap)=>{
    ctx.patients = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderPatientList();
  });

  // inbox
  if(ctx.unsub.inbox) ctx.unsub.inbox();
  ctx.unsub.inbox = onSnapshot(collection(db,"inbox"), (snap)=>{
    ctx.inbox = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    updateMailBadge();
  });
}

/* ====== Overlay rendering ====== */
function renderOverlay(){
  overlayEl.innerHTML = "";
  const sorted = [...ctx.users].sort((a,b)=>a.id.localeCompare(b.id,"fr",{sensitivity:"base"}));
  if(!sorted.length){ overlayEl.innerHTML = "<div class='hint-sm' style='padding:12px;'>Aucun joueur</div>"; return; }
  for(const u of sorted){
    const role = u.role||"NEW";
    const row = document.createElement("div");
    row.className = "player";
    row.dataset.player = u.id;
    const statusText = "‚Äî"; // statut pr√©cis via services (optionnel: on demand)
    row.innerHTML = `<div class="head"><div class="name">${u.id}</div><div class="role-pill ${roleClass(role)}">${roleLabel(role)}</div></div><div class="status">${statusText}</div>`;
    row.onclick = ()=>openPlayerProfile(u.id);
    overlayEl.appendChild(row);
  }
}

/* ====== Service / timer ====== */
let tickTimer = null;
function updateServiceUI(sv){
  const inService = sv.status === "in" && sv.startAt;
  let total = sv.totalMs||0;
  if(inService){
    const started = typeof sv.startAt === "number"? sv.startAt : (sv.startAt?.toMillis ? sv.startAt.toMillis() : Date.parse(sv.startAt));
    const now = Date.now();
    const cur = Math.max(0, now - started);
    timerEl.textContent = msToHM(cur);
  }else{
    timerEl.textContent = "0h00";
  }
  statTotal.textContent = msToHM(total);
  // semaine: approximation via sessions sur 7 jours
  statWeek.textContent = calcWeekFromSessions(sv.sessions||[]);
  startBtn.disabled = inService;
  endBtn.disabled   = !inService;
}
function calcWeekFromSessions(sessions){
  const now = new Date();
  const day = (d=>d===0?6:d-1)(now.getDay());
  const monday = new Date(now); monday.setDate(now.getDate()-day); monday.setHours(0,0,0,0);
  const weekStart = monday.getTime(), weekEnd = weekStart + 7*864e5 - 1;
  let sum = 0;
  for(const s of sessions||[]){
    const st = s.startAt?.toMillis ? s.startAt.toMillis() : (typeof s.startAt==="number"?s.startAt:Date.parse(s.startAt||0));
    const en = s.endAt?.toMillis ? s.endAt.toMillis() : (typeof s.endAt==="number"?s.endAt:Date.parse(s.endAt||Date.now()));
    if(!st) continue;
    const a1 = Math.max(st, weekStart);
    const a2 = Math.min(en||Date.now(), weekEnd);
    if(a2>a1) sum += (a2-a1);
  }
  return msToHM(sum);
}
startBtn?.addEventListener('click', async ()=>{
  try{
    const ref = doc(db,"services", ctx.mePseudo);
    await setDoc(ref, { status:"in", startAt: serverTimestamp() }, { merge:true });
    await addLog("service:start",{ by:ctx.mePseudo });
  }catch(e){ statusMsg.textContent = "Impossible de d√©marrer."; statusMsg.className="msg error"; }
});
endBtn?.addEventListener('click', ()=>{ show(endReasonModal, true); });
er_cancelBtn?.addEventListener('click', ()=> show(endReasonModal, false));
er_confirmBtn?.addEventListener('click', async ()=>{
  const reason = (er_reason.value||"").trim(); const warn = er_warning.value==="yes";
  if(!reason){ er_msg.textContent="Raison obligatoire."; er_msg.className="msg error"; return; }
  try{
    const ref = doc(db,"services", ctx.mePseudo);
    const snap = await getDoc(ref);
    const sv = snap.data()||{};
    const started = sv.startAt?.toMillis ? sv.startAt.toMillis() : (typeof sv.startAt==="number"?sv.startAt:Date.parse(sv.startAt||0));
    const now = Date.now();
    const dur = started? (now - started) : 0;
    const sessions = (sv.sessions||[]).concat([{ startAt: sv.startAt||serverTimestamp(), endAt: serverTimestamp(), reason, warning: warn }]);
    const warnings = sv.warnings||[];
    if(warn) warnings.push({ by: ctx.mePseudo, at: serverTimestamp(), reason });
    await updateDoc(ref, { status:"out", startAt: null, totalMs: (sv.totalMs||0)+dur, sessions, warnings });
    await addLog("service:end",{ by:ctx.mePseudo, reason, warning: warn });
    show(endReasonModal,false);
    er_reason.value = ""; er_warning.value="no"; er_msg.textContent="";
  }catch(e){
    er_msg.textContent = "Erreur: "+(e.message||e.code);
    er_msg.className="msg error";
  }
});

/* ====== Patients ====== */
btnNewPatient?.addEventListener('click', ()=> show(patientModal,true));
btnCancelPatient?.addEventListener('click', ()=> show(patientModal,false));
np_dob?.addEventListener('input', ()=> np_age.value = computeAgeFromDob(np_dob.value) || "");
np_dob?.addEventListener('change', ()=> np_age.value = computeAgeFromDob(np_dob.value) || "");

btnSavePatient?.addEventListener('click', async ()=>{
  if(!["CERTIFI√â","TECH","ADMIN"].includes(ctx.meRole)){ patientMsg.textContent="Droit insuffisant."; patientMsg.className="msg error"; return; }
  const nom = (np_nom.value||"").trim(); const prenom=(np_prenom.value||"").trim();
  if(!nom || !prenom){ patientMsg.textContent="Nom + pr√©nom obligatoires."; patientMsg.className="msg error"; return; }
  try{
    await addDoc(collection(db,"patients"), {
      nom, prenom, sexe:np_sexe.value||"", dob: np_dob.value||"", age: np_age.value? +np_age.value : null,
      tel: np_tel.value||"", taille: np_taille.value? +np_taille.value : null, poid: np_poid.value? +np_poid.value : null,
      groupe: np_groupe.value||"", allergies: np_allergies.value||"", commentaire: np_commentaire.value||"",
      staff: np_staff.value||"", nature: np_nature.value||"", typeBlessure: np_typeBlessure.value||"",
      gravite: np_gravite.value||"", soins: np_soins.value||"", prise: np_prise.value||"",
      irm: np_irm.value||"", scanner: np_scanner.value||"", operation: np_operation.value||"",
      createdBy: ctx.mePseudo, createdAt: serverTimestamp(), lastModifiedBy: ctx.mePseudo, lastModifiedAt: serverTimestamp()
    });
    addLog("patient:create", { by:ctx.mePseudo, nom, prenom });
    show(patientModal,false);
    patientMsg.textContent="";
    clearPatientForm();
  }catch(e){ patientMsg.textContent="Erreur: "+(e.message||e.code); patientMsg.className="msg error"; }
});

function renderPatientList(){
  const q = (patientSearch.value||"").trim().toLowerCase();
  const arr = q? ctx.patients.filter(p => (`${p.nom||""} ${p.prenom||""}`).toLowerCase().includes(q)) : ctx.patients;
  patientList.innerHTML = arr.map(p=>`<div class="patient-row" data-id="${p.id}"><div><div class="patient-name">${p.nom||"‚Äî"} ${p.prenom||""}</div><div class="patient-meta">${p.sexe||""} ${(p.age||"")} ans</div></div><div class="patient-meta">${fmtDate(p.createdAt?.toMillis? p.createdAt.toMillis(): (typeof p.createdAt==="number"?p.createdAt:Date.parse(p.createdAt||0)))}</div></div>`).join("");
  [...patientList.querySelectorAll(".patient-row")].forEach(row=> row.addEventListener('click', ()=> openPatient(row.dataset.id)));
}
patientSearch?.addEventListener('input', renderPatientList);

async function openPatient(id){
  const p = ctx.patients.find(x=>x.id===id);
  if(!p) return;
  ctx.viewing.patient = id;
  fillPatientDetails(p);
  show(pdModal, true);
}
function fillPatientDetails(p){
  pd_nom.value=p.nom||""; pd_prenom.value=p.prenom||""; pd_sexe.value=p.sexe||""; pd_dob.value=p.dob||""; pd_age.value=p.age||""; pd_tel.value=p.tel||"";
  pd_taille.value=p.taille??""; pd_poid.value=p.poid??""; pd_groupe.value=p.groupe||""; pd_allergies.value=p.allergies||""; pd_commentaire.value=p.commentaire||"";
  pd_staff.value=p.staff||""; pd_nature.value=p.nature||""; pd_typeBlessure.value=p.typeBlessure||""; pd_gravite.value=p.gravite||""; pd_soins.value=p.soins||""; pd_prise.value=p.prise||""; pd_irm.value=p.irm||""; pd_scanner.value=p.scanner||""; pd_operation.value=p.operation||"";
  pd_metaCreatedBy.textContent=p.createdBy||"‚Äî"; pd_metaCreatedAt.textContent=fmtDate(p.createdAt?.toMillis? p.createdAt.toMillis() : Date.parse(p.createdAt||0));
  pd_metaModifiedBy.textContent=p.lastModifiedBy||"‚Äî"; pd_metaModifiedAt.textContent=fmtDate(p.lastModifiedAt?.toMillis? p.lastModifiedAt.toMillis() : Date.parse(p.lastModifiedAt||0));
  const canEdit = (ctx.meRole==="TECH"||ctx.meRole==="ADMIN");
  pd_editBtn.style.display = canEdit? "inline-block":"none";
  pd_deleteBtn.style.display = (ctx.meRole==="ADMIN")? "inline-block":"none";
  pd_saveBtn.style.display = "none";
  setPatientDetailsDisabled(true);
  pd_msg.textContent="";
}
function setPatientDetailsDisabled(dis=true){
  [pd_nom,pd_prenom,pd_sexe,pd_dob,pd_age,pd_tel,pd_taille,pd_poid,pd_groupe,pd_allergies,pd_commentaire,pd_staff,pd_nature,pd_typeBlessure,pd_gravite,pd_soins,pd_prise,pd_irm,pd_scanner,pd_operation].forEach(el=> el.disabled = dis);
}
pd_editBtn?.addEventListener('click', ()=>{
  setPatientDetailsDisabled(false);
  pd_saveBtn.style.display="inline-block";
});
pd_saveBtn?.addEventListener('click', async ()=>{
  if(!ctx.viewing.patient) return;
  try{
    await updateDoc(doc(db,"patients", ctx.viewing.patient), {
      nom: pd_nom.value||"", prenom: pd_prenom.value||"", sexe: pd_sexe.value||"", dob: pd_dob.value||"", age: pd_age.value? +pd_age.value:null,
      tel: pd_tel.value||"", taille: pd_taille.value? +pd_taille.value:null, poid: pd_poid.value? +pd_poid.value:null, groupe: pd_groupe.value||"",
      allergies: pd_allergies.value||"", commentaire: pd_commentaire.value||"", staff: pd_staff.value||"", nature: pd_nature.value||"", typeBlessure: pd_typeBlessure.value||"",
      gravite: pd_gravite.value||"", soins: pd_soins.value||"", prise: pd_prise.value||"", irm: pd_irm.value||"", scanner: pd_scanner.value||"", operation: pd_operation.value||"",
      lastModifiedBy: ctx.mePseudo, lastModifiedAt: serverTimestamp()
    });
    addLog("patient:update",{ by:ctx.mePseudo, id: ctx.viewing.patient });
    setPatientDetailsDisabled(true);
    pd_saveBtn.style.display="none";
  }catch(e){ pd_msg.textContent="Erreur: "+(e.message||e.code); pd_msg.className="msg error"; }
});
pd_deleteBtn?.addEventListener('click', async ()=>{
  if(!ctx.viewing.patient) return;
  if(!confirm("Supprimer cette fiche ?")) return;
  try{
    const ref = doc(db,"patients", ctx.viewing.patient);
    await updateDoc(ref, { deletedAt: serverTimestamp(), deletedBy: ctx.mePseudo });
    addLog("patient:delete",{ by:ctx.mePseudo, id:ctx.viewing.patient });
    show(pdModal,false);
  }catch(e){ pd_msg.textContent="Erreur: "+(e.message||e.code); }
});
pd_closeBtn?.addEventListener('click', ()=> show(pdModal,false));

function clearPatientForm(){
  [np_nom,np_prenom,np_sexe,np_dob,np_age,np_tel,np_taille,np_poid,np_groupe,np_allergies,np_commentaire,np_staff,np_nature,np_typeBlessure,np_gravite,np_soins,np_prise,np_irm,np_scanner,np_operation].forEach(el=>{ if(!el) return; if(el.tagName==="SELECT") el.value=""; else el.value=""; });
}
function computeAgeFromDob(d){
  if(!d) return "";
  const birth = new Date(d); const now = new Date();
  let age = now.getFullYear() - birth.getFullYear();
  const m = now.getMonth() - birth.getMonth();
  if(m<0 || (m===0 && now.getDate()<birth.getDate())) age--;
  return Math.max(0, age);
}

/* ====== Profil joueur ====== */
async function openPlayerProfile(pseudo){
  try{
    const udoc = await getDoc(doc(db,"users", pseudo));
    const sdoc = await getDoc(doc(db,"services", pseudo));
    const u = udoc.data()||{ role:"NEW" }; const s = sdoc.data()||{ totalMs:0, status:"out", sessions:[], warnings:[] };
    pf_pseudo.textContent = pseudo;
    pf_role.textContent = roleLabel(u.role||"NEW");
    pf_roleEditor.style.display = (ctx.meRole==="ADMIN" && pseudo!=="admin") ? "block" : "none";
    pf_roleSelect.value = (u.role||"NEW");
    pf_created.textContent = "‚Äî";
    pf_status.textContent  = (s.status==="in")?"En service":"Hors service";
    pf_current.textContent = (s.status==="in" && s.startAt) ? msToHM(Date.now() - (s.startAt?.toMillis? s.startAt.toMillis(): Date.parse(s.startAt||0))) : "0h00";
    pf_total.textContent   = msToHM(s.totalMs||0);
    pf_week.textContent    = calcWeekFromSessions(s.sessions||[]);
    const warnCount = (s.warnings||[]).length;
    pf_warnCount.textContent = String(warnCount);
    pf_forceEndBtn.style.display = (ctx.meRole==="ADMIN" || ctx.meRole==="TECH")? "inline-block":"none";
    show(profileModal, true);
    pf_forceEndBtn.onclick = async ()=>{
      if(!confirm("Forcer la fin de service ?")) return;
      if(s.status!=="in"){ alert("Pas en service."); return; }
      const ref = doc(db,"services", pseudo);
      const snap = await getDoc(ref);
      const cur = snap.data()||{};
      const started = cur.startAt?.toMillis? cur.startAt.toMillis(): Date.parse(cur.startAt||0);
      const dur = started? (Date.now()-started): 0;
      await updateDoc(ref, { status:"out", startAt:null, totalMs:(cur.totalMs||0)+dur, sessions:(cur.sessions||[]).concat([{startAt:cur.startAt||serverTimestamp(), endAt: serverTimestamp(), forcedBy: ctx.mePseudo}]) });
      addLog("service:forceEnd",{ by:ctx.mePseudo, target:pseudo });
      alert("Service termin√©.");
    };
  }catch(e){ console.error(e); }
}
pf_closeBtn?.addEventListener('click', ()=> show(profileModal,false));
pf_roleSelect?.addEventListener('change', async ()=>{
  if(ctx.meRole!=="ADMIN") return;
  const target = pf_pseudo.textContent;
  const newRole = pf_roleSelect.value;
  try{
    // update usersByUid (need uid). We search by usersByUid pseudo (client side: not ideal, but demo)
    // In production: store uid on users doc.
    const uid = await uidByPseudo(target);
    if(uid){
      await updateDoc(doc(db,"usersByUid", uid), { role:newRole });
    }
    await setDoc(doc(db,"users", target), { pseudo:target, role:newRole }, { merge:true });
    pf_role.textContent = roleLabel(newRole);
    addLog("role:update",{ by:ctx.mePseudo, target, to:newRole });
  }catch(e){ alert("Impossible de changer le r√¥le (droits ?)."); }
});
async function uidByPseudo(pseudo){
  // Na√Øf: t√©l√©charge tous usersByUid visibles (admin only can read others)
  if(ctx.meRole!=="ADMIN") return null;
  // We cannot list all via rules unless admin; here assume admin
  // There's no query by nested field eq, Firestore supports where("pseudo","==",pseudo)
  const qs = query(collection(db,"usersByUid"), where("pseudo","==",pseudo), limit(1));
  return new Promise((resolve)=>{
    onSnapshot(qs, (snap)=>{
      const d = snap.docs[0];
      resolve(d? d.id : null);
    }, ()=>resolve(null));
  });
}

/* ====== Admin panel ====== */
function openAdmin(){
  document.body.classList.add("view-admin"); document.body.classList.remove("view-service");
  showBlock(adminBox, true);
  logsBar.style.display = "flex";
  // subscribe all services only in admin view
  if(ctx.unsub.allServices) ctx.unsub.allServices();
  ctx.unsub.allServices = onSnapshot(collection(db,"services"), (snap)=>{
    ctx.services = {};
    snap.forEach(d=> ctx.services[d.id] = d.data());
    buildAdminTable();
  });
}
function closeAdmin(){
  showBlock(adminBox,false);
  logsBar.style.display = "none";
  if(ctx.unsub.allServices){ ctx.unsub.allServices(); delete ctx.unsub.allServices; }
  document.body.classList.add("view-service"); document.body.classList.remove("view-admin");
}
adminHomeBtn?.addEventListener('click', closeAdmin);

function buildAdminTable(){
  const rows = [];
  for(const u of ctx.users){
    const s = ctx.services[u.id] || {};
    const status = s.status==="in" ? "<span class='pill green'>En service</span>" : "<span class='pill gray'>Hors service</span>";
    const current = (s.status==="in" && s.startAt)? msToHM(Date.now() - (s.startAt?.toMillis? s.startAt.toMillis(): Date.parse(s.startAt||0))) : "0h00";
    const total = msToHM(s.totalMs||0);
    const warns = (s.warnings||[]).length || 0;
    rows.push(`<tr><td>${u.id}</td><td>${roleLabel(u.role||"NEW")}</td><td>${status}</td><td>${current}</td><td>${total}</td><td>${warns}</td><td>‚Äî</td><td class="td-actions"><button class="btn-sm" data-act="profile" data-user="${u.id}">Profil</button>${ctx.meRole==="ADMIN"?`<button class="btn-sm" data-act="makeAdmin" data-user="${u.id}">R√¥le‚Ä¶</button>`:""}</td></tr>`);
  }
  adminTable.innerHTML = rows.join("");
  [...adminTable.querySelectorAll("button[data-act='profile']")].forEach(b=> b.addEventListener('click',()=> openPlayerProfile(b.dataset.user)));
  [...adminTable.querySelectorAll("button[data-act='makeAdmin']")].forEach(b=> b.addEventListener('click',()=> { openPlayerProfile(b.dataset.user); }));
}
deleteAllUsersBtn?.addEventListener('click', async ()=>{
  alert("Op√©ration volontairement d√©sactiv√©e c√¥t√© client (danger). Supprime via console si besoin.");
});

/* ====== Logs ====== */
openLogsBtn?.addEventListener('click', ()=>{
  if(ctx.meRole!=="ADMIN"){ alert("R√©serv√© √† l'admin."); return; }
  openLogsModal();
});
const logsModal = document.getElementById('logsModal');
const logsText  = document.getElementById('logsText');
const logsTimes = document.getElementById('logsTimes');
const logsCloseBtn = document.getElementById('logsCloseBtn');
logsCloseBtn?.addEventListener('click', ()=> show(logsModal,false));

function openLogsModal(){
  show(logsModal,true);
  if(ctx.unsub.logs) ctx.unsub.logs();
  const since = new Date(Date.now()-24*3600e3);
  const qLogs = query(collection(db,"logs"), orderBy("at","desc"), limit(200));
  ctx.unsub.logs = onSnapshot(qLogs, (snap)=>{
    const lines=[], times=[];
    snap.forEach(d=>{
      const x=d.data();
      lines.push(`[${(x.byPseudo||x.by||"‚Äî").padEnd(12)}] ${x.action}${x.target?`(${x.target})`:""} ${x.details||""}`);
      times.push(new Date(x.at?.toMillis? x.at.toMillis() : Date.parse(x.at||Date.now())).toLocaleString());
    });
    logsText.textContent = lines.join("\n");
    logsTimes.textContent= times.join("\n");
  });
}
async function addLog(action, extra={}){
  try{
    await addDoc(collection(db,"logs"), {
      at: serverTimestamp(), action, byPseudo: ctx.mePseudo, ...extra
    });
  }catch(e){ /* lecture seule si non admin, mais create autoris√© */ }
}

/* ====== Inbox ====== */
mailBtn?.addEventListener('click', ()=> openInbox());
in_closeBtn?.addEventListener('click', ()=> show(inboxModal,false));
in_newBtn?.addEventListener('click', ()=> show(composeArea,true));
in_cancelBtn?.addEventListener('click', ()=> show(composeArea,false));
in_sendBtn?.addEventListener('click', async ()=>{
  const subject=(in_subject.value||"").trim(); const body=(in_body.value||"").trim();
  if(!subject || !body) return;
  try{
    await addDoc(collection(db,"inbox"), { subject, body, fromPseudo: ctx.mePseudo, createdAt: serverTimestamp(), readBy: [] });
    show(composeArea,false); in_subject.value=""; in_body.value="";
  }catch(e){ alert("Envoi impossible."); }
});
function openInbox(){
  show(inboxModal,true);
  renderInbox();
  in_newBtn.style.display = (ctx.meRole==="TECH" || ctx.meRole==="ADMIN")? "inline-block":"none";
}
function renderInbox(){
  const me = ctx.mePseudo;
  inboxList.innerHTML = ctx.inbox.map(m=>{
    const unread = !(m.readBy||[]).includes(me);
    return `<div class="msg-card"><div class="msg-head"><div class="msg-title">${m.subject||"(sans sujet)"}</div><div>${unread?'<span class="badge-unread">non lu</span>':''}</div></div><div class="msg-body" style="margin-top:6px; white-space:pre-wrap;">${(m.body||"")}</div><div class="msg-actions"><button class="btn-sm" data-id="${m.id}" data-act="mark">${unread?'Marquer lu':'Marquer non lu'}</button>${(ctx.meRole==='TECH'||ctx.meRole==='ADMIN')?`<button class="btn-sm danger" data-id="${m.id}" data-act="del">Supprimer</button>`:""}</div></div>`;
  }).join("");
  [...inboxList.querySelectorAll("button")].forEach(b=> b.addEventListener('click', async ()=>{
    const id=b.dataset.id, act=b.dataset.act;
    if(act==="mark"){
      const m = ctx.inbox.find(x=>x.id===id); if(!m) return;
      const rb = new Set(m.readBy||[]);
      if(rb.has(ctx.mePseudo)) rb.delete(ctx.mePseudo); else rb.add(ctx.mePseudo);
      await updateDoc(doc(db,"inbox", id), { readBy: Array.from(rb) });
    }else if(act==="del"){
      if(!confirm("Supprimer le message ?")) return;
      await updateDoc(doc(db,"inbox", id), { deletedAt: serverTimestamp(), deletedBy: ctx.mePseudo });
    }
  }));
}
function updateMailBadge(){
  const me = ctx.mePseudo;
  const unread = ctx.inbox.filter(m=> !(m.readBy||[]).includes(me)).length;
  mailBadge.style.display = unread? "flex":"none";
  mailBadge.textContent = String(unread||0);
  topbar.style.display = (ctx.meRole==="TECH" || ctx.meRole==="ADMIN")? "flex":"none";
}

/* ====== Admin gate (5 clics logo) ====== */
let clickCount = 0, firstClickAt = 0;
siteLogo?.addEventListener('click', ()=>{
  const now = Date.now();
  if(now - firstClickAt > 10000){ clickCount=0; firstClickAt=now; }
  clickCount++;
  if(clickCount>=5){
    clickCount=0;
    openAdminGate();
  }
});
function openAdminGate(){
  adminPwd.value=""; adminGateMsg.textContent="";
  show(adminGateModal,true);
}
adminGateCancel?.addEventListener('click', ()=> show(adminGateModal,false));
adminGateOk?.addEventListener('click', async ()=>{
  const pwd = adminPwd.value;
  try{
    await signInWithEmailAndPassword(auth, "admin@monjeu.local", pwd);
    // ensure role ADMIN
    const u = auth.currentUser;
    await setDoc(doc(db,"usersByUid", u.uid), { pseudo: "admin", role: "ADMIN" }, { merge:true });
    await setDoc(doc(db,"users", "admin"), { pseudo:"admin", role:"ADMIN" }, { merge:true });
    show(adminGateModal,false);
    openAdmin();
  }catch(e){
    adminGateMsg.textContent = "Mot de passe admin incorrect.";
    adminGateMsg.className="msg error";
  }
});

/* ====== Divers ====== */
homeBtn?.addEventListener('click', async ()=>{ await signOut(auth); });
document.getElementById('pf_closeBtn')?.addEventListener('click', ()=> show(profileModal,false));
document.getElementById('logsCloseBtn')?.addEventListener('click', ()=> show(logsModal,false));

</script>
</body>
</html>
