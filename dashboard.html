<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; height:100vh; background:#2B2B3D; color:#f0f0f0; }
    #sidebar-left { width:250px; background:#1e1e2a; color:white; overflow-y:auto; padding:10px; }
    #sidebar-left h2 { margin:0 0 10px; text-align:center; }
    #userList { list-style:none; padding:0; }
    #userList li { display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #333; font-size:14px; }
    .status { display:flex; align-items:center; gap:6px; }
    .circle { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .off { border:2px solid white; background:transparent; }
    .on { background:#28a745; }
    #content { flex:1; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .service-box { background:#3a3a50; padding:30px; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.4); text-align:center; width:420px; margin-bottom:20px; }
    button { display:block; margin:10px auto; padding:10px 20px; border:none; color:white; font-size:16px; border-radius:6px; cursor:pointer; width:80%; }
    #startService { background:#28a745; } #stopService { background:#dc3545; } #changePwd { background:#007BFF; } #logoutBtn { background:#6c757d; }
    #sidebar-right { width:320px; background:#1e1e2a; color:white; overflow-y:auto; padding:10px; }
    #sidebar-right h2 { margin:0 0 10px; text-align:center; }
    #patientList { list-style:none; padding:0; }
    #patientList li { padding:6px; border-bottom:1px solid #333; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
    input, select { margin:4px; padding:6px; border-radius:6px; border:none; }
    .actions button { margin-left:5px; padding:3px 8px; font-size:12px; }
    #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; }
    #modal { background:#3a3a50; padding:20px; border-radius:10px; width:600px; max-height:90%; overflow-y:auto; }
    #modal h2 { text-align:center; }
    #modal label { display:block; margin-top:10px; }
    #modal input, #modal select { width:95%; padding:8px; margin-top:4px; }
    #modal button { margin-top:15px; width:100%; }
  </style>
</head>
<body>
  <div id="sidebar-left">
    <h2>Joueurs</h2>
    <ul id="userList"></ul>
  </div>
  <div id="content">
    <div class="service-box">
      <h1 id="welcome">Bienvenue üéâ</h1>
      <p id="gradeInfo"></p>
      <p>Total heures de service : <span id="totalHours">0</span> h</p>
      <p>Heures cette semaine : <span id="weeklyHours">0</span> h</p>
      <p>Timer service : <span id="timer">00:00</span> <span id="statusIcon"></span></p>
      <button id="startService">Commencer le service</button>
      <button id="stopService">Finir le service</button>
      <button id="changePwd">Changer le mot de passe</button>
      <button id="logoutBtn" onclick="logout()">‚¨Ö D√©connexion</button>
    </div>
    <div id="adminPanel" style="display:none;">
      <h2>Panel Administrateur</h2>
      <button class="deleteAllBtn" id="deleteAllUsers">Supprimer tous les joueurs</button>
      <table>
        <thead>
          <tr><th>Pseudo</th><th>Date de cr√©ation</th><th>Grade</th><th>Action</th></tr>
        </thead>
        <tbody id="adminUserList"></tbody>
      </table>
    </div>
  </div>
  <div id="sidebar-right" style="display:none;">
    <h2>Patients</h2>
    <button id="createPatientBtn">Cr√©er une fiche patient</button>
    <input type="text" id="searchPatient" placeholder="Rechercher...">
    <ul id="patientList"></ul>
  </div>

  <div id="modalOverlay">
    <div id="modal">
      <h2>Nouvelle fiche patient</h2>
      <form id="patientForm">
        <label>Nom<input type="text" id="nom" required></label>
        <label>Pr√©nom<input type="text" id="prenom" required></label>
        <label>Date de naissance<input type="date" id="dateNaissance" required></label>
        <label>√Çge<input type="number" id="age" readonly></label>
        <label>Allergies<input type="text" id="allergies"></label>
        <label>Poids<input type="number" id="poids"></label>
        <label>Taille<input type="number" id="taille"></label>
        <label>Groupe sanguin<input type="text" id="groupeSanguin"></label>
        <label>T√©l√©phone<input type="text" id="telephone"></label>
        <h3>Fiche bilan</h3>
        <label>Personnel(s) en charge<input type="text" id="personnelsEnCharge"></label>
        <label>Nature de la blessure<input type="text" id="natureBlessure"></label>
        <label>Type de blessure<input type="text" id="typeBlessure"></label>
        <label>Gravit√© de la blessure<input type="text" id="graviteBlessure"></label>
        <label>Soins prodigu√©s<input type="text" id="soinsProdigues"></label>
        <label>IRM<select id="irm"><option value="false">Non</option><option value="true">Oui</option></select></label>
        <label>Scanner<select id="scanner"><option value="false">Non</option><option value="true">Oui</option></select></label>
        <label>Op√©ration<select id="operation"><option value="false">Non</option><option value="true">Oui</option></select></label>
        <label>Soins<select id="soins"><option value="false">Non</option><option value="true">Oui</option></select></label>
        <label>Prise en charge<select id="priseEnCharge"><option value="false">Non</option><option value="true">Oui</option></select></label>
        <button type="submit">Enregistrer</button>
        <button type="button" id="closeModal">Annuler</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMGMkmVgl8h0WuknCA-AChlyoX95RufNs",
      authDomain: "base-de-donnee-b5c8c.firebaseapp.com",
      projectId: "base-de-donnee-b5c8c",
      storageBucket: "base-de-donnee-b5c8c.firebasestorage.app",
      messagingSenderId: "302677536354",
      appId: "1:302677536354:web:54e0d4562bad5f06c3ab3b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const savedUser = localStorage.getItem("currentUser");
    if (!savedUser) window.location.href = "index.html";
    const user = JSON.parse(savedUser);
    document.getElementById("welcome").textContent = "Bienvenue " + user.pseudo + " üéâ";
    document.getElementById("gradeInfo").textContent = "Ton grade : " + user.grade;

    // Sidebar patients visible si grade != new
    if(user.grade !== "new"){ document.getElementById("sidebar-right").style.display="block"; }
    if(user.grade === "new"){ document.getElementById("createPatientBtn").style.display="none"; }

    // Modal patient
    const modalOverlay=document.getElementById("modalOverlay");
    document.getElementById("createPatientBtn").addEventListener("click",()=>{ modalOverlay.style.display="flex"; });
    document.getElementById("closeModal").addEventListener("click",()=>{ modalOverlay.style.display="none"; });

    // Calcul auto de l'√¢ge
    document.getElementById("dateNaissance").addEventListener("change",(e)=>{
      const birth=new Date(e.target.value); const ageDifMs=Date.now()-birth.getTime(); const ageDate=new Date(ageDifMs);
      document.getElementById("age").value=Math.abs(ageDate.getUTCFullYear()-1970);
    });

    // Enregistrer patient
    document.getElementById("patientForm").addEventListener("submit",async(e)=>{
      e.preventDefault();
      if(user.grade==="new"){ alert("Acc√®s refus√©"); return; }
      const data={
        nom:document.getElementById("nom").value,
        prenom:document.getElementById("prenom").value,
        dateNaissance:document.getElementById("dateNaissance").value,
        age:document.getElementById("age").value,
        allergies:document.getElementById("allergies").value,
        poids:document.getElementById("poids").value,
        taille:document.getElementById("taille").value,
        groupeSanguin:document.getElementById("groupeSanguin").value,
        telephone:document.getElementById("telephone").value,
        personnelsEnCharge:document.getElementById("personnelsEnCharge").value,
        natureBlessure:document.getElementById("natureBlessure").value,
        typeBlessure:document.getElementById("typeBlessure").value,
        graviteBlessure:document.getElementById("graviteBlessure").value,
        soinsProdigues:document.getElementById("soinsProdigues").value,
        irm:document.getElementById("irm").value==="true",
        scanner:document.getElementById("scanner").value==="true",
        operation:document.getElementById("operation").value==="true",
        soins:document.getElementById("soins").value==="true",
        priseEnCharge:document.getElementById("priseEnCharge").value==="true",
        createdBy:user.pseudo,
        createdAt:new Date().toISOString()
      };
      await addDoc(collection(db,"patients"),data);
      modalOverlay.style.display="none";
    });

    // Liste patients
    function loadPatients(){
      if(user.grade==="new")return;
      onSnapshot(collection(db,"patients"),(snapshot)=>{
        const list=document.getElementById("patientList"); list.innerHTML="";
        snapshot.forEach(docSnap=>{
          const p=docSnap.data();
          const li=document.createElement("li");
          li.textContent=p.nom+" "+p.prenom;
          const actions=document.createElement("div"); actions.className="actions";
          if(user.grade==="technicien"||user.grade==="admin"){
            const editBtn=document.createElement("button"); editBtn.textContent="Modifier"; actions.appendChild(editBtn);
          }
          if(user.grade==="admin"){
            const delBtn=document.createElement("button"); delBtn.textContent="Supprimer"; actions.appendChild(delBtn);
            delBtn.addEventListener("click",async()=>{ await deleteDoc(doc(db,"patients",docSnap.id)); });
          }
          li.appendChild(actions);
          list.appendChild(li);
        });
      });
    }
    loadPatients();

    window.logout=function(){ localStorage.removeItem("currentUser"); window.location.href="index.html"; }
  </script>
</body>
</html>