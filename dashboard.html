
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard v18.6 (v8.8 mailbox header)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#2B2B3D; --panel: rgba(43,43,61,0.92); --muted: rgba(255,255,255,0.06); --text:#f0f0f0; --accent:#4f7cff; --ok:#2ecc71; --danger:#e74c3c; --info:#17a2b8; --outline:#6c757d; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; justify-content:center; align-items:center; }
    #sidebarLeft, #sidebarRight { position:fixed; top:0; bottom:0; width:280px; padding:16px 14px; overflow-y:auto; background:var(--panel); backdrop-filter:blur(10px); box-shadow:0 0 15px rgba(0,0,0,0.4); }
    #sidebarLeft { left:0; } #sidebarRight { right:0; }
    #sidebarLeft h2, #sidebarRight h2 { text-align:center; margin:8px 0 14px; font-weight:700; letter-spacing:.3px; }
    ul { list-style:none; padding:0; margin:0; }
    li.item { background:var(--muted); margin:6px 0; padding:10px 12px; border-radius:12px; display:flex; align-items:center; gap:10px; cursor:default; }
    .statusDot { width:10px; height:10px; border-radius:50%; display:inline-block; flex:0 0 10px; border:2px solid #fff; background:transparent; }
    .statusDot.on { border:none; background:#2ecc71; }
    .badge { display:inline-block; padding:2px 6px; border-radius:999px; font-size:.75rem; font-weight:700; margin-left:8px; background:rgba(255,255,255,0.12); border:1px solid #4c4c62; }
    .small { opacity:.8; font-size:.9em; }
    .centerCard { position:relative; margin:0 auto; background:var(--panel); backdrop-filter:blur(10px); padding:28px; border-radius:20px; box-shadow:0 8px 30px rgba(0,0,0,0.5); text-align:center; width:68%; max-width:1100px; z-index:1; }
    button { padding:9px 13px; margin:6px 5px; border:none; border-radius:8px; font-weight:700; cursor:pointer; transition:transform .15s ease, opacity .15s ease; }
    button:hover { transform:translateY(-1px); opacity:.95; }
    #startService{background:var(--ok);color:white;} #stopService{background:var(--danger);color:white;} #changePwd{background:var(--accent);color:white;} #logoutBtn,#logoutBtn2{background:var(--outline);color:white;}
    #deleteAllBtn{background:var(--danger);color:white;margin-bottom:10px;} #logsBtn{background:var(--info);color:white;margin-top:10px;}
    table { width:100%; border-collapse:collapse; background:transparent; } th, td { padding:10px; border-bottom:1px solid #4c4c62; text-align:center; }
    select { background:var(--bg); color:white; border:1px solid #4c4c62; padding:6px; border-radius:6px; }
    .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); backdrop-filter:blur(12px); justify-content:center; align-items:center; z-index:20; }
    .modal { background:rgba(43,43,61,0.95); backdrop-filter:blur(12px); padding:20px; border-radius:18px; width:680px; max-height:90%; overflow-y:auto; box-shadow:0 8px 30px rgba(0,0,0,0.5); }
    .modal h2 { text-align:center; margin-top:0; }
    .modal form label { display:block; margin-top:10px; }
    .modal input, .modal select, .modal textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #4c4c62; background:var(--bg); color:var(--text); margin-top:6px; }
    .modal button { margin-top:10px; }
    #logsList { list-style:none; padding:0; margin:0; } #logsList li { padding:6px 0; border-bottom:1px solid #4c4c62; text-align:left; }
    .accordion { background:var(--muted); border-radius:12px; margin:12px 0; overflow:hidden; }
    .accordion-header { padding:12px; font-weight:700; cursor:pointer; background:rgba(255,255,255,0.08); }
    .accordion-content { display:none; padding:12px 12px 6px; animation:fadeIn .25s ease; }
    .accordion.active .accordion-content { display:block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-4px);} to{opacity:1; transform:translateY(0);} }
    #searchPatient { width:100%; padding:9px 11px; border-radius:10px; border:1px solid #4c4c62; background:var(--bg); color:var(--text); margin:10px 0 12px; }
    #toast { display:none; position:fixed; top:16px; left:50%; transform:translateX(-50%); background:rgba(43,43,61,0.95); color:#fff; padding:10px 16px; border-radius:999px; border:1px solid #4c4c62; box-shadow:0 6px 20px rgba(0,0,0,0.4); z-index:100; }
    .clickable { cursor:pointer; }
    /* Header with centered logo + mailbox */
    #headerBar{
      position:fixed; top:8px; left:50%; transform:translateX(-50%);
      display:flex; align-items:center; gap:10px;
      background:rgba(43,43,61,0.85); backdrop-filter:blur(10px);
      border:1px solid #4c4c62; border-radius:999px; padding:6px 12px;
      z-index:30;
    }
    #headerLogo{ height:28px; width:auto; display:block; }
    #mailBtn{ background:transparent; color:#fff; border:1px solid #4c4c62; border-radius:999px; padding:6px 10px; cursor:pointer; }
    #mailBtn:hover{ transform:none; opacity:1; background:rgba(255,255,255,0.08); }
  
    /* Admin table fixed height (7 rows) with sticky header and internal scroll */
    #adminDashboard { display:flex; flex-direction:column; align-items:stretch; }
    .adminTableWrap { border:1px solid #4c4c62; border-radius:12px; overflow:auto; background:rgba(255,255,255,0.03); max-height: calc(48px * 7 + 44px); }
    #adminDashboard table { margin:0; }
    #adminDashboard thead th { position: sticky; top: 0; background: rgba(43,43,61,0.98); z-index: 5; }
    #adminDashboard tbody tr { height:48px; }

  
    /* Mailbox notification badge */
    .notifBadge{
      display:none;
      min-width:18px;
      height:18px;
      line-height:18px;
      font-size:12px;
      border-radius:999px;
      background:var(--danger);
      color:#fff;
      text-align:center;
      padding:0 6px;
      font-weight:800;
      margin-left:4px;
      box-shadow:0 0 0 2px rgba(43,43,61,0.85);
    }

  
    /* Add-on: profile modal card grid + glass cards */
    .cardGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin:12px 0;}
    .glassCard{background:rgba(255,255,255,0.06);border:1px solid #4c4c62;border-radius:14px;padding:12px 14px;backdrop-filter:blur(8px);}
    .glassCard h4{margin:0 0 6px 0;font-size:.95rem;opacity:.8}
    .glassCard .val{font-weight:800;font-size:1.05rem}
    @media (max-width: 900px){ .cardGrid{grid-template-columns:1fr;} }
    .cardActions{display:flex;gap:8px;margin-top:8px;}
    .glassCard.clickable{cursor:pointer;transition:transform .12s ease, opacity .12s ease;}
    .glassCard.clickable:hover{transform:translateY(-1px);opacity:.95;}
    input[type="checkbox"]{accent-color:#2ecc71;}
    /* Mailbox notification badge */
    .notifBadge{display:none;min-width:18px;height:18px;line-height:18px;font-size:12px;border-radius:999px;background:var(--danger);color:#fff;text-align:center;padding:0 6px;font-weight:800;margin-left:4px;box-shadow:0 0 0 2px rgba(43,43,61,0.85);}

  
    /* Badge color overrides */
    .badge.role-technicien{ background:#3b82f6 !important; color:#fff !important; }
    .badge.role-certifi√©{ background:#f59e0b !important; color:#fff !important; }
    /* Keep .badge role-new as existing/default */

    /* Stop-service form layout */
    .formRow{display:flex;align-items:center;gap:6px;margin-top:10px;}
    .formRow label{margin:0;}

    /* Cleaner warning card */
    .inlineBtn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer;}

  
    .glassCard.disabled{opacity:.5;pointer-events:none;filter:saturate(.7);}

  </style>
</head>
<body>

  <div id="headerBar">
    <img id="headerLogo" src="Logo.png" alt="Logo">
    <button id="mailBtn" title="Bo√Æte aux lettres">üì¨</button><span id="mailBadge" class="notifBadge">0</span>
  </div>

  <aside id="sidebarLeft"><h2>Joueurs</h2><ul id="userList"></ul></aside>

  <main class="centerCard" id="normalDashboard">
    <h1 id="welcome"></h1>
    <p id="gradeInfo"></p>
    <p>Total heures : <span id="totalHours">0</span> h</p>
    <p>Cette semaine : <span id="weeklyHours">0</span> h</p>
    <p>Timer : <span id="timer">00:00</span> <span id="statusIcon">‚èπÔ∏è</span></p>
    <div>
      <button id="startService">Commencer le service</button>
      <button id="stopService">Finir le service</button>
      <button id="changePwd">Changer le mot de passe</button>
      <button id="logoutBtn">‚¨Ö D√©connexion</button>
    </div>
  </main>

  <section class="centerCard" id="adminDashboard" style="display:none;">
    <h1>Panel Admin</h1>
    <button id="deleteAllBtn">‚ùå Supprimer tous les joueurs</button>
    <div class="adminTableWrap"><table><thead><tr><th>Pseudo</th><th>Date de cr√©ation</th><th>Heures totales</th><th>Grade</th><th>Action</th></tr></thead><tbody id="adminTableBody"></tbody></table></div>
    <button id="logsBtn">üìú Logs</button>
    <button id="logoutBtn2">‚¨Ö D√©connexion</button>
  </section>

  <aside id="sidebarRight">
    <h2>Patients</h2>
    <button id="createPatientBtn" style="background:var(--accent);color:#fff;width:100%;margin-bottom:8px;">Cr√©er une fiche patient</button>
    <input type="text" id="searchPatient" placeholder="Rechercher..." />
    <ul id="patientList"></ul>
  </aside>

  <!-- Create patient modal -->
  <div class="overlay" id="modalOverlay">
    <div class="modal" id="modal">
      <h2>Nouvelle fiche patient</h2>
      <form id="patientForm">
        <div class="accordion active">
          <div class="accordion-header">Informations patient</div>
          <div class="accordion-content">
            <label>Nom<input type="text" id="nom" required></label>
            <label>Pr√©nom<input type="text" id="prenom" required></label>
            <label>Sexe
              <select id="sexe">
                <option value="H">H</option>
                <option value="F">F</option>
                <option value="A">A</option>
              </select>
            </label>
            <label>Date de naissance<input type="date" id="dateNaissance" required></label>
            <label>√Çge<input type="number" id="age" readonly></label>
            <label>Allergies<input type="text" id="allergies"></label>
            <label>Poids (kg)<input type="number" id="poids"></label>
            <label>Taille (cm)<input type="number" id="taille"></label>
            <label>Groupe sanguin
              <select id="groupeSanguin">
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
              </select>
            </label>
            <label>T√©l√©phone<input type="tel" id="telephone" pattern="[0-9]{10}" maxlength="10" placeholder="10 chiffres"></label>
          </div>
        </div>
        <div class="accordion">
          <div class="accordion-header">Fiche bilan</div>
          <div class="accordion-content">
            <label>Personnelles en charge<input type="text" id="personnels"></label>
            <label>Nature de la blessure<input type="text" id="natureBlessure"></label>
            <label>Type de blessure<input type="text" id="typeBlessure"></label>
            <label>Gravit√© de la blessure<input type="text" id="graviteBlessure"></label>
            <label>Soins prodigu√©s<input type="text" id="soinsProdigues"></label>
            <label>IRM<select id="irm"><option>oui</option><option>non</option></select></label>
            <label>Scanner<select id="scanner"><option>oui</option><option>non</option></select></label>
            <label>Op√©ration<select id="operation"><option>oui</option><option>non</option></select></label>
            <label>Soins<select id="soins"><option>oui</option><option>non</option></select></label>
            <label>Type de prise en charge<select id="priseEnCharge"><option>oui</option><option>non</option></select></label>
          </div>
        </div>
        <div class="accordion">
          <div class="accordion-header">Commentaire</div>
          <div class="accordion-content">
            <label>Commentaire<textarea id="commentaire" rows="4"></textarea></label>
          </div>
        </div>
        <button type="submit">Enregistrer</button>
        <button type="button" id="closeModal">Annuler</button>
      </form>
    </div>
  </div>

  <!-- Logs modal -->
  <div class="overlay" id="logsOverlay">
    <div class="modal" id="logsModal">
      <h2>Logs</h2>
      <ul id="logsList"></ul>
      <button id="closeLogs">Fermer</button>
    </div>
  </div>

  <!-- Change password modal -->
  <div class="overlay" id="pwdOverlay">
    <div class="modal" id="pwdModal">
      <h2>Changer de mot de passe</h2>
      <label>Nouveau mot de passe<input type="password" id="newPassword" required></label>
      <button id="savePwdBtn">Enregistrer</button>
      <button id="closePwd">Annuler</button>
    </div>
  </div>

  <!-- Patient view modal -->
  <div class="overlay" id="patientViewOverlay">
    <div class="modal" id="patientViewModal">
      <h2>Fiche patient</h2>
      <div id="patientViewContent"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
        <button id="editPatientBtn" style="display:none;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Modifier</button>
        <button id="deletePatientBtn" style="display:none;background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Supprimer</button>
        <button id="closePatientView" style="background:var(--outline);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Mailbox modal -->
  <div class="overlay" id="mailOverlay">
    <div class="modal">
      <h2>Bo√Æte aux lettres</h2>
      <div id="mailboxContent">
        <p style="opacity:.85;margin:6px 0 0">Aucun message pour le moment.</p>
      </div>
      <button id="closeMail" style="background:var(--outline);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Fermer</button>
    </div>
  </div>

  
  <!-- Profile modal (add-on) -->
  <div class="overlay" id="profileOverlay" style="display:none">
    <div class="modal" id="profileModal">
      <h2>Profil joueur</h2>
      <div id="profileGrid" class="cardGrid"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px;">
        <button id="closeProfile" style="background:var(--outline);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Fermer</button>
      </div>
    </div>
  </div>


  <!-- Stop Service modal (add-on) -->
  <div class="overlay" id="stopServiceOverlay" style="display:none">
    <div class="modal" id="stopServiceModal">
      <h2>Arr√™t du service</h2>
      <label>Raison
        <input type="text" id="stopReason" placeholder="Expliquez la raison de l'arr√™t">
      </label>
      <div class="formRow"><input type="checkbox" id="stopWarn"><label for="stopWarn" style="margin:0;">Avertissement</label></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:14px;">
        <button id="stopConfirm" style="background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Valider</button>
        <button id="stopCancel" style="background:var(--outline);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Annuler</button>
      </div>
    </div>
  </div>

  
  <!-- Warnings History modal -->
  <div class="overlay" id="warningsOverlay" style="display:none">
    <div class="modal" id="warningsModal">
      <h2>Historique des avertissements</h2>
      <div id="warningsList" style="margin-top:10px;max-height:50vh;overflow:auto;border:1px solid #4c4c62;border-radius:12px;padding:10px;background:rgba(255,255,255,0.04)">
        <p style="opacity:.8;margin:0">Chargement‚Ä¶</p>
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;">
        <button id="closeWarnings" style="background:var(--outline);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Fermer</button>
      </div>
    </div>
  </div>

  <div id="toast">Notification</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, setDoc, addDoc, doc, onSnapshot, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMGMkmVgl8h0WuknCA-AChlyoX95RufNs",
      authDomain: "base-de-donnee-b5c8c.firebaseapp.com",
      projectId: "base-de-donnee-b5c8c",
      storageBucket: "base-de-donnee-b5c8c.firebasestorage.app",
      messagingSenderId: "302677536354",
      appId: "1:302677536354:web:54e0d4562bad5f06c3ab3b"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Utils =====
    function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(window._toastTimer); window._toastTimer=setTimeout(()=>{ t.style.display='none'; },2500); }
    function fmt2(n){ return n.toString().padStart(2,"0"); }
    function fmtHM(ms){ const h=Math.floor(ms/1000/3600), m=Math.floor((ms/1000/60)%60); return `${fmt2(h)}:${fmt2(m)}`; }
    function formatDateFr(iso){ const d=new Date(iso); return `cr√©√© le ${fmt2(d.getDate())}/${fmt2(d.getMonth()+1)}/${d.getFullYear()} √† ${fmt2(d.getHours())}h${fmt2(d.getMinutes())}`; }
    function fmtBool(v){ return (String(v).toLowerCase()==="oui") ? "Oui" : (String(v).toLowerCase()==="non" ? "Non" : (v||"-")); }
    async function addLog(message){ const id=`${Date.now()}_${Math.random().toString(36).slice(2,8)}`; await setDoc(doc(db,"logs", id), { message, user: current ? current.pseudo : "syst√®me", createdAt:new Date().toISOString() }); }

    // ===== Session & header visibility =====
    const savedUser = localStorage.getItem("currentUser");
    let current = savedUser ? JSON.parse(savedUser) : null;

    const welcomeEl = document.getElementById("welcome");
    const gradeInfoEl = document.getElementById("gradeInfo");
    const mailBtn = document.getElementById("mailBtn");
    const mailOverlay = document.getElementById("mailOverlay");
    const closeMail = document.getElementById("closeMail");

    if(current){
      if(current.grade === "new"){
        welcomeEl.textContent = "Bienvenue " + current.pseudo + " ‚Äî tu es nouveau, attends qu'un admin ou un technicien valide ton profil pour profiter du site web.";
        gradeInfoEl.textContent = "Ton grade : new";
        const cpb = document.getElementById("createPatientBtn"); if(cpb) cpb.style.display="none";
      } else {
        welcomeEl.textContent = "Bonjour " + current.pseudo;
        gradeInfoEl.textContent = "Ton grade : " + current.grade;
      }

      // Mail visibility: only admin/technicien
      if(current.grade === "admin" || current.grade === "technicien"){
        if(mailBtn) mailBtn.style.display = "inline-block";
      } else {
        if(mailBtn) mailBtn.style.display = "none";
      }
    }

    // Admin dashboard toggle
    if (current && current.grade === "admin") {
      document.getElementById("normalDashboard").style.display = "none";
      document.getElementById("adminDashboard").style.display  = "block";
    }

    // Mail open/close
    mailBtn?.addEventListener("click", ()=> { if(mailOverlay) mailOverlay.style.display = "flex"; });
    closeMail?.addEventListener("click", ()=> { if(mailOverlay) mailOverlay.style.display = "none"; });

    // ===== Mailbox approvals (admin/technicien) =====
    const mailboxContent = document.getElementById("mailboxContent");
    if(current && (current.grade === "admin" || current.grade === "technicien")){
      onSnapshot(query(collection(db, "mailbox")), (snap)=>{
        const items = [];
        snap.forEach(d => {
          const m = { id: d.id, ...d.data() };
          if(m.to === 'staff' && m.status === 'pending' && m.type === 'new_user'){
            items.push(m);
          }
        });
        mailboxContent.innerHTML = "";
        if(items.length === 0){
          const p = document.createElement('p'); p.style.opacity = ".85"; p.textContent = "Aucun message pour le moment."; mailboxContent.appendChild(p);
        } else {
          items.sort((a,b)=> (a.createdAt||'').localeCompare(b.createdAt||''));
          items.forEach(m => {
            const wrap = document.createElement('div'); wrap.style.padding = "10px 12px"; wrap.style.border = "1px solid #4c4c62"; wrap.style.borderRadius = "12px"; wrap.style.margin = "8px 0"; wrap.style.background = "rgba(255,255,255,0.06)";
            const txt = document.createElement('div'); txt.textContent = `${m.pseudo} a rejoint le serveur. L'acceptez-vous ?`; txt.style.marginBottom = "8px";
            const row = document.createElement('div'); row.style.display = "flex"; row.style.gap = "8px";
            const yes = document.createElement('button'); yes.textContent = "Oui"; yes.style.background = "var(--ok)"; yes.style.color = "#fff"; yes.style.borderRadius = "10px"; yes.style.padding = "8px 12px"; yes.style.cursor="pointer";
            const no  = document.createElement('button'); no.textContent = "Non"; no.style.background = "var(--danger)"; no.style.color = "#fff"; no.style.borderRadius = "10px"; no.style.padding = "8px 12px"; no.style.cursor="pointer";
            yes.addEventListener('click', async()=>{
              try{
                await updateDoc(doc(db, "users", m.pseudo), { grade: "certifi√©" });
                await deleteDoc(doc(db, "mailbox", m.id));
                showToast(`Profil ${m.pseudo} valid√© ‚úÖ`);
                addLog(`${current.pseudo} a valid√© ${m.pseudo} (‚Üí certifi√©)`);
              }catch(err){ console.error(err); alert("Erreur de validation"); }
            });
            no.addEventListener('click', async()=>{
              try{
                await deleteDoc(doc(db, "mailbox", m.id));
                showToast(`Demande ${m.pseudo} ignor√©e`);
                addLog(`${current.pseudo} a refus√© la demande de ${m.pseudo}`);
              }catch(err){ console.error(err); alert("Erreur de suppression"); }
            });
            row.appendChild(yes); row.appendChild(no);
            wrap.appendChild(txt); wrap.appendChild(row);
            mailboxContent.appendChild(wrap);
          });
        }
      });
    }


    // ===== D√©connexion & MDP =====
    function goLogout(){ window.location.href = "index.html"; }
    document.getElementById("logoutBtn")?.addEventListener("click", goLogout);
    document.getElementById("logoutBtn2")?.addEventListener("click", goLogout);

    const pwdOverlay = document.getElementById("pwdOverlay");
    document.getElementById("changePwd")?.addEventListener("click", ()=> pwdOverlay.style.display="flex" );
    document.getElementById("closePwd")?.addEventListener("click", ()=> pwdOverlay.style.display="none" );
    document.getElementById("savePwdBtn")?.addEventListener("click", async()=>{
      const newPwd = document.getElementById("newPassword").value.trim(); if(!newPwd){ alert("Mot de passe vide"); return; }
      if(!current){ alert("Session manquante"); return; }
      await updateDoc(doc(db,"users", current.pseudo), { password:newPwd }); pwdOverlay.style.display="none"; showToast("Mot de passe chang√© ‚úÖ"); addLog(`${current.pseudo} a chang√© son mot de passe`);
    });

    // ===== Timer / Service (user) =====
    const startBtn = document.getElementById("startService");
    const stopBtn  = document.getElementById("stopService");
    const timerDisplay = document.getElementById("timer");
    const statusIcon   = document.getElementById("statusIcon");
    let timerInterval=null;
    function startLocalTimer(startIso){ if(timerInterval) clearInterval(timerInterval); timerInterval=setInterval(()=>{ const diff=Date.now()-new Date(startIso).getTime(); timerDisplay.textContent=fmtHM(diff); statusIcon.textContent="‚ñ∂Ô∏è"; },1000); }
    function stopLocalTimer(){ if(timerInterval) clearInterval(timerInterval); timerInterval=null; timerDisplay.textContent="00:00"; statusIcon.textContent="‚èπÔ∏è"; }
    if(current && current.grade!=="admin" && current.grade!=="new"){
      startBtn?.addEventListener("click", async()=>{ await updateDoc(doc(db,"users", current.pseudo), { serviceActive:true, serviceStart:new Date().toISOString() }); addLog(`${current.pseudo} a commenc√© son service`); });
      stopBtn?.addEventListener("click", async()=>{
        const meRef=doc(db,"users", current.pseudo); const meSnap=await getDoc(meRef);
        if(meSnap.exists()){ const u=meSnap.data(); if(u.serviceActive && u.serviceStart){ const diff=Date.now()-new Date(u.serviceStart).getTime(); const addH=diff/1000/3600; await updateDoc(meRef, { serviceActive:false, totalHours:(u.totalHours||0)+addH, weeklyHours:(u.weeklyHours||0)+addH }); addLog(`${current.pseudo} a termin√© son service apr√®s ${addH.toFixed(2)}h`); } }
      });
      onSnapshot(doc(db,"users", current.pseudo), (d)=>{ if(!d.exists()) return; const u=d.data(); document.getElementById("totalHours").textContent=(u.totalHours||0).toFixed(1); document.getElementById("weeklyHours").textContent=(u.weeklyHours||0).toFixed(1); if(u.serviceActive && u.serviceStart){ startLocalTimer(u.serviceStart); } else { stopLocalTimer(); } });
    } else {
      // Hide buttons for NEW explicitly
      if(current && current.grade === "new"){ if(startBtn) startBtn.style.display="none"; if(stopBtn) stopBtn.style.display="none"; }
    }

    // ===== Sidebar gauche: USERS (temps r√©el) =====
    const userListEl=document.getElementById("userList");
    function renderUsers(snapshot){
      const rows=[]; snapshot.forEach(d=> rows.push({ id:d.id, ...d.data() }));
      rows.sort((a,b)=> (a.id||"").localeCompare(b.id||"","fr",{sensitivity:"base"}));
      userListEl.innerHTML="";
      rows.forEach(u=>{
        const li=document.createElement("li"); li.className="item";
        const dot=document.createElement("span"); dot.className="statusDot"+(u.serviceActive?" on":"");
        const div=document.createElement("div");
        const strongEl=document.createElement("strong"); strongEl.textContent=u.id;
        const badgeEl=document.createElement("span"); badgeEl.className="badge"; badgeEl.textContent=(u.grade||"new");
        const extra=(u.serviceActive && u.serviceStart)?` ‚Äì en service depuis ${fmtHM(Date.now()-new Date(u.serviceStart).getTime())}`:"";
        const small=document.createElement("div"); small.className="small"; small.textContent=extra;
        div.appendChild(strongEl); div.appendChild(badgeEl); div.appendChild(small);
        li.appendChild(dot); li.appendChild(div); userListEl.appendChild(li);
      });
    }
    onSnapshot(collection(db,"users"), (snap)=>{
      renderUsers(snap);
      if(window._usersRefresh) clearInterval(window._usersRefresh);
      window._usersRefresh=setInterval(()=>renderUsers(snap),5000);
    });

    // ===== Panel Admin =====
    const logsOverlay = document.getElementById("logsOverlay");
    document.getElementById("logsBtn")?.addEventListener("click", ()=> logsOverlay.style.display="flex" );
    document.getElementById("closeLogs")?.addEventListener("click", ()=> logsOverlay.style.display="none" );
    onSnapshot(query(collection(db,"logs"), orderBy("createdAt","desc")), (snap)=>{
      const ul = document.getElementById("logsList"); if(!ul) return;
      ul.innerHTML="";
      snap.forEach(d=>{ const l=d.data(); const t=new Date(l.createdAt); const line = `${fmt2(t.getDate())}/${fmt2(t.getMonth()+1)}/${t.getFullYear()} ${fmt2(t.getHours())}:${fmt2(t.getMinutes())} - [${l.user}] ${l.message}`; const li=document.createElement("li"); li.textContent=line; ul.appendChild(li); });
    });

    
function renderAdminTable(snapshot){
  const tbody=document.getElementById("adminTableBody"); if(!tbody) return; tbody.innerHTML="";
  const rows = [];
  snapshot.forEach(d => rows.push({ id: d.id, u: d.data() }));
  rows.sort((a,b)=> (a.id||"").localeCompare(b.id||"","fr",{sensitivity:"base"}));
  rows.forEach(({id, u})=>{
    const tr=document.createElement("tr");
    const tdPseudo=document.createElement("td"); tdPseudo.textContent=id; tr.appendChild(tdPseudo);
    const tdDate=document.createElement("td"); tdDate.textContent=u.createdAt?formatDateFr(u.createdAt):"-"; tr.appendChild(tdDate);
    const tdHours=document.createElement("td"); tdHours.textContent=(u.totalHours||0).toFixed(1); tr.appendChild(tdHours);
    const tdGrade=document.createElement("td"); const sel=document.createElement("select");
    ["new","certifi√©","technicien","admin"].forEach(g=>{ const opt=document.createElement("option"); opt.value=g; opt.textContent=g; if(u.grade===g) opt.selected=true; sel.appendChild(opt); });
    sel.addEventListener("change", async()=>{ await updateDoc(doc(db,"users", id), { grade: sel.value }); addLog(`Grade de ${id} ‚Üí ${sel.value}`); });
    tdGrade.appendChild(sel); tr.appendChild(tdGrade);
    const tdAct=document.createElement("td"); const btnDel=document.createElement("button"); btnDel.textContent="Supprimer"; btnDel.style.background="var(--danger)"; btnDel.style.color="#fff";
    btnDel.addEventListener("click", async()=>{ await deleteDoc(doc(db,"users", id)); addLog(`${current?.pseudo||"admin"} a supprim√© l'utilisateur ${id}`); });
    tdAct.appendChild(btnDel); tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
}

    onSnapshot(collection(db,"users"), (snap)=>{ if(current?.grade==="admin"){ renderAdminTable(snap); } });
    document.getElementById("deleteAllBtn")?.addEventListener("click", async()=>{
      const all=await getDocs(collection(db,"users"));
      for(const d of all.docs){ await deleteDoc(doc(db,"users", d.id)); }
      addLog(`${current?.pseudo||"admin"} a supprim√© tous les utilisateurs`);
    });

    // ===== PATIENTS ("Fiche") =====
    const modalOverlay = document.getElementById("modalOverlay");
    document.getElementById("createPatientBtn")?.addEventListener("click", ()=> { modalOverlay.style.display="flex"; document.querySelectorAll(".accordion").forEach(a=>a.classList.add("active")); });
    document.getElementById("closeModal")?.addEventListener("click", ()=> modalOverlay.style.display="none" );

    document.getElementById("dateNaissance")?.addEventListener("change", (e)=>{
      const birth = new Date(e.target.value); if(isNaN(birth)) { document.getElementById("age").value=""; return; }
      const diff=Date.now()-birth.getTime(); const a=new Date(diff); document.getElementById("age").value=Math.abs(a.getUTCFullYear()-1970);
    });

    document.getElementById("patientForm")?.addEventListener("submit", async(e)=>{
      e.preventDefault();
      const nom = document.getElementById("nom").value.trim();
      const prenom = document.getElementById("prenom").value.trim();
      const tel = document.getElementById("telephone").value.trim();
      if(tel && !/^[0-9]{10}$/.test(tel)){ alert("T√©l√©phone: 10 chiffres requis"); return; }
      const data = {
        nom, prenom,
        sexe:document.getElementById("sexe").value,
        dateNaissance:document.getElementById("dateNaissance").value,
        age:document.getElementById("age").value,
        allergies:document.getElementById("allergies").value.trim(),
        poids:document.getElementById("poids").value,
        taille:document.getElementById("taille").value,
        groupeSanguin:document.getElementById("groupeSanguin").value,
        telephone:tel,
        personnels:document.getElementById("personnels").value.trim(),
        natureBlessure:document.getElementById("natureBlessure").value.trim(),
        typeBlessure:document.getElementById("typeBlessure").value.trim(),
        graviteBlessure:document.getElementById("graviteBlessure").value.trim(),
        soinsProdigues:document.getElementById("soinsProdigues").value.trim(),
        irm:document.getElementById("irm").value,
        scanner:document.getElementById("scanner").value,
        operation:document.getElementById("operation").value,
        soins:document.getElementById("soins").value,
        priseEnCharge:document.getElementById("priseEnCharge").value,
        commentaire:document.getElementById("commentaire").value.trim(),
        createdBy: current ? current.pseudo : "inconnu",
        createdAt: new Date().toISOString()
      };
      const rawId = `${nom} ${prenom}`.replace(/\//g,"-").replace(/\s+/g," ").trim();
      try{
        await setDoc(doc(db,"Fiche", rawId), data);
        addLog(`Fiche patient cr√©√©e: ${data.nom} ${data.prenom} (${data.sexe})`);
        modalOverlay.style.display="none";
        (document.getElementById("patientForm")).reset();
        document.getElementById("age").value="";
        showToast("Fiche patient bien enregistr√©e");
      }catch(err){
        console.error("Erreur setDoc Fiche:", err);
        alert("Erreur d‚Äôenregistrement de la fiche patient");
      }
    });

    const patientList = document.getElementById("patientList");
    let lastPatients = [];
    function renderPatients(list){
      patientList.innerHTML="";
      list.sort((a,b)=> (`${(a.nom||"").trim()} ${(a.prenom||"").trim()}`).localeCompare(`${(b.nom||"").trim()} ${(b.prenom||"").trim()}`,"fr",{sensitivity:"base"}));
      list.forEach(p=>{
        const li=document.createElement("li"); li.className="item clickable";
        const tag = (p.sexe||"A").toUpperCase();
        const line = `${(p.nom||"").trim()} ${(p.prenom||"").trim()} ‚Äî ${tag}`.trim();
        const div=document.createElement("div"); div.textContent=line;
        li.appendChild(div);
        li.addEventListener("click", ()=> openPatientView(p));
        patientList.appendChild(li);
      });
    }
    onSnapshot(collection(db,"Fiche"), (snap)=>{
      lastPatients = [];
      snap.forEach(d => lastPatients.push({ id:d.id, ...d.data() }));
      renderPatients(lastPatients);
    });
    document.getElementById("searchPatient")?.addEventListener("input", (e)=>{
      const q=e.target.value.trim().toLowerCase();
      const list = q ? lastPatients.filter(p => (`${(p.nom||"")} ${(p.prenom||"")}`).toLowerCase().includes(q)) : lastPatients;
      renderPatients(list);
    });

    // ===== Patient details & edit/delete =====
    const patientViewOverlay = document.getElementById('patientViewOverlay');
    const patientViewContent = document.getElementById('patientViewContent');
    document.getElementById('closePatientView')?.addEventListener('click', ()=> patientViewOverlay.style.display='none');
    const editPatientBtn = document.getElementById('editPatientBtn');
    const deletePatientBtn = document.getElementById('deletePatientBtn');
    let _currentPatient = null;

    function buildPatientDetailsDL(p){
      const fields = [
        ["Nom", p.nom], ["Pr√©nom", p.prenom], ["Sexe", (p.sexe||"A").toUpperCase()],
        ["Date de naissance", p.dateNaissance||"-"], ["√Çge", p.age||"-"],
        ["Groupe sanguin", p.groupeSanguin||"-"], ["T√©l√©phone", p.telephone||"-"],
        ["Allergies", p.allergies||"-"], ["Poids (kg)", p.poids||"-"], ["Taille (cm)", p.taille||"-"],
        ["Personnelles en charge", p.personnels||"-"],
        ["Nature de la blessure", p.natureBlessure||"-"], ["Type de blessure", p.typeBlessure||"-"], ["Gravit√©", p.graviteBlessure||"-"],
        ["Soins prodigu√©s", p.soinsProdigues||"-"],
        ["IRM", fmtBool(p.irm)], ["Scanner", fmtBool(p.scanner)], ["Op√©ration", fmtBool(p.operation)], ["Soins", fmtBool(p.soins)], ["Prise en charge", fmtBool(p.priseEnCharge)],
        ["Commentaire", p.commentaire||"-"],
        ["Cr√©√© par", p.createdBy||"-"], ["Cr√©√© le", (p.createdAt ? (new Date(p.createdAt)).toLocaleString('fr-FR') : "-")]
      ];
      const dl = document.createElement('dl');
      dl.style.display = "grid"; dl.style.gridTemplateColumns = "1fr 2fr"; dl.style.gap = "6px 12px";
      fields.forEach(([k,v])=>{
        const dt=document.createElement('dt'); dt.textContent=k; dt.style.opacity=".8";
        const dd=document.createElement('dd'); dd.textContent = (v===""? "-" : v); dd.style.margin="0 0 6px 0"; dd.style.fontWeight="600";
        dl.appendChild(dt); dl.appendChild(dd);
      });
      return dl;
    }

    function openPatientView(p){
      _currentPatient = p;
      patientViewContent.innerHTML = "";
      patientViewContent.appendChild(buildPatientDetailsDL(p));
      const canEdit = !!(current && (current.grade === 'admin' || current.grade === 'technicien'));
      const canDelete = !!(current && (current.grade === 'admin'));
      if(editPatientBtn){ editPatientBtn.style.display = canEdit ? 'inline-block' : 'none'; editPatientBtn.onclick = ()=> openPatientEdit(p); }
      if(deletePatientBtn){
        deletePatientBtn.style.display = canDelete ? 'inline-block' : 'none';
        deletePatientBtn.onclick = async ()=>{
          if(!confirm(`Supprimer la fiche de ${p.nom||''} ${p.prenom||''} ?`)) return;
          try{
            await deleteDoc(doc(db, "Fiche", p.id));
            showToast("Fiche patient supprim√©e ‚úÖ");
            addLog(`${current?.pseudo||'admin'} a supprim√© la fiche patient: ${p.nom||''} ${p.prenom||''}`);
            patientViewOverlay.style.display='none';
          }catch(err){
            console.error("Erreur deleteDoc Fiche:", err);
            alert("Erreur lors de la suppression");
          }
        };
      }
      patientViewOverlay.style.display='flex';
    }

    function openPatientEdit(p){
      _currentPatient = p;
      const c = patientViewContent;
      const form = document.createElement('form');
      form.id = "patientEditForm";
      form.innerHTML = `
        <div class="accordion active">
          <div class="accordion-header">√âditer la fiche patient</div>
          <div class="accordion-content" style="display:block;padding:0;margin:0;">
            <label>Nom<input type="text" id="e_nom" value="${(p.nom||'').replace(/"/g,'&quot;')}" required></label>
            <label>Pr√©nom<input type="text" id="e_prenom" value="${(p.prenom||'').replace(/"/g,'&quot;')}" required></label>
            <label>Sexe
              <select id="e_sexe">
                <option value="H" ${p.sexe==='H'?'selected':''}>H</option>
                <option value="F" ${p.sexe==='F'?'selected':''}>F</option>
                <option value="A" ${(p.sexe||'A')==='A'?'selected':''}>A</option>
              </select>
            </label>
            <label>Date de naissance<input type="date" id="e_dateNaissance" value="${p.dateNaissance||''}"></label>
            <label>√Çge<input type="number" id="e_age" value="${p.age||''}"></label>
            <label>Allergies<input type="text" id="e_allergies" value="${(p.allergies||'').replace(/"/g,'&quot;')}"></label>
            <label>Poids (kg)<input type="number" id="e_poids" value="${p.poids||''}"></label>
            <label>Taille (cm)<input type="number" id="e_taille" value="${p.taille||''}"></label>
            <label>Groupe sanguin
              <select id="e_groupeSanguin">
                ${["A+","A-","B+","B-","AB+","AB-","O+","O-"].map(gs => `<option value="${gs}" ${(p.groupeSanguin===gs)?'selected':''}>${gs}</option>`).join('')}
              </select>
            </label>
            <label>T√©l√©phone<input type="tel" id="e_telephone" value="${p.telephone||''}" maxlength="10" placeholder="10 chiffres"></label>
            <label>Personnelles en charge<input type="text" id="e_personnels" value="${(p.personnels||'').replace(/"/g,'&quot;')}"></label>
            <label>Nature de la blessure<input type="text" id="e_natureBlessure" value="${(p.natureBlessure||'').replace(/"/g,'&quot;')}"></label>
            <label>Type de blessure<input type="text" id="e_typeBlessure" value="${(p.typeBlessure||'').replace(/"/g,'&quot;')}"></label>
            <label>Gravit√© de la blessure<input type="text" id="e_graviteBlessure" value="${(p.graviteBlessure||'').replace(/"/g,'&quot;')}"></label>
            <label>Soins prodigu√©s<input type="text" id="e_soinsProdigues" value="${(p.soinsProdigues||'').replace(/"/g,'&quot;')}"></label>
            <label>IRM<select id="e_irm"><option ${String(p.irm).toLowerCase()==='oui'?'selected':''}>oui</option><option ${String(p.irm).toLowerCase()==='non'?'selected':''}>non</option></select></label>
            <label>Scanner<select id="e_scanner"><option ${String(p.scanner).toLowerCase()==='oui'?'selected':''}>oui</option><option ${String(p.scanner).toLowerCase()==='non'?'selected':''}>non</option></select></label>
            <label>Op√©ration<select id="e_operation"><option ${String(p.operation).toLowerCase()==='oui'?'selected':''}>oui</option><option ${String(p.operation).toLowerCase()==='non'?'selected':''}>non</option></select></label>
            <label>Soins<select id="e_soins"><option ${String(p.soins).toLowerCase()==='oui'?'selected':''}>oui</option><option ${String(p.soins).toLowerCase()==='non'?'selected':''}>non</option></select></label>
            <label>Type de prise en charge<select id="e_priseEnCharge"><option ${String(p.priseEnCharge).toLowerCase()==='oui'?'selected':''}>oui</option><option ${String(p.priseEnCharge).toLowerCase()==='non'?'selected':''}>non</option></select></label>
            <label>Commentaire<textarea id="e_commentaire" rows="4">${(p.commentaire||'').replace(/</g,'&lt;')}</textarea></label>
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
          <button type="button" id="savePatientEditBtn" style="background:var(--ok);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Enregistrer</button>
          <button type="button" id="cancelPatientEditBtn" style="background:var(--danger);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;">Annuler</button>
        </div>
      `;
      c.innerHTML = "";
      c.appendChild(form);

      const dob = form.querySelector('#e_dateNaissance');
      const age = form.querySelector('#e_age');
      dob?.addEventListener('change', (e)=>{
        const birth = new Date(e.target.value);
        if(!isNaN(birth)){
          const diff=Date.now()-birth.getTime();
          const a=new Date(diff);
          age.value=Math.abs(a.getUTCFullYear()-1970);
        }
      });

      form.querySelector('#cancelPatientEditBtn')?.addEventListener('click', ()=>{
        patientViewContent.innerHTML = "";
        patientViewContent.appendChild(buildPatientDetailsDL(_currentPatient));
      });

      form.querySelector('#savePatientEditBtn')?.addEventListener('click', async()=>{
        const tel = (form.querySelector('#e_telephone').value||'').trim();
        if(tel && !/^[0-9]{10}$/.test(tel)){ alert('T√©l√©phone: 10 chiffres requis'); return; }
        const updated = {
          nom: form.querySelector('#e_nom').value.trim(),
          prenom: form.querySelector('#e_prenom').value.trim(),
          sexe: form.querySelector('#e_sexe').value,
          dateNaissance: form.querySelector('#e_dateNaissance').value,
          age: form.querySelector('#e_age').value,
          allergies: form.querySelector('#e_allergies').value.trim(),
          poids: form.querySelector('#e_poids').value,
          taille: form.querySelector('#e_taille').value,
          groupeSanguin: form.querySelector('#e_groupeSanguin').value,
          telephone: tel,
          personnels: form.querySelector('#e_personnels').value.trim(),
          natureBlessure: form.querySelector('#e_natureBlessure').value.trim(),
          typeBlessure: form.querySelector('#e_typeBlessure').value.trim(),
          graviteBlessure: form.querySelector('#e_graviteBlessure').value.trim(),
          soinsProdigues: form.querySelector('#e_soinsProdigues').value.trim(),
          irm: form.querySelector('#e_irm').value,
          scanner: form.querySelector('#e_scanner').value,
          operation: form.querySelector('#e_operation').value,
          soins: form.querySelector('#e_soins').value,
          priseEnCharge: form.querySelector('#e_priseEnCharge').value,
          commentaire: form.querySelector('#e_commentaire').value.trim()
        };
        try{
          await updateDoc(doc(db, "Fiche", _currentPatient.id), updated);
          showToast("Fiche patient mise √† jour ‚úÖ");
          addLog(`Fiche patient modifi√©e: ${updated.nom} ${updated.prenom}`);
          document.getElementById('patientViewOverlay').style.display='none';
        }catch(err){
          console.error("Erreur updateDoc Fiche:", err);
          alert("Erreur lors de la mise √† jour");
        }
      });
    }

    // ===== Logs overlay stream =====
    const logsBtn = document.getElementById("logsBtn");
    const closeLogs = document.getElementById("closeLogs");
    logsBtn?.addEventListener("click", ()=> document.getElementById("logsOverlay").style.display="flex");
    closeLogs?.addEventListener("click", ()=> document.getElementById("logsOverlay").style.display="none");

    // ===== ESC closes overlays =====
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        const overlays = [
          document.getElementById('patientViewOverlay'),
          document.getElementById('modalOverlay'),
          document.getElementById('logsOverlay'),
          document.getElementById('pwdOverlay'),
          document.getElementById('mailOverlay')
        ];
        overlays.forEach(ov => { if(ov && ov.style.display && ov.style.display !== 'none'){ ov.style.display = 'none'; } });
      }
    });
  
    // === Minimal add-ons: mailbox badge + logs cleanup (isolated) ===
    (function(){
      try{
        const mailBadge = document.getElementById('mailBadge');
        if(current && (current.grade==='admin' || current.grade==='technicien')){
          onSnapshot(query(collection(db,'mailbox')), (snap)=>{
            let count = 0;
            snap.forEach(d=>{
              const m = d.data();
              if(m && m.to==='staff' && m.status==='pending' && m.type==='new_user'){ count++; }
            });
            if(mailBadge){
              if(count>0){ mailBadge.style.display='inline-block'; mailBadge.textContent=String(count); }
              else { mailBadge.style.display='none'; }
            }
          });
        }else{
          if(mailBadge) mailBadge.style.display='none';
        }
      }catch(e){ console.warn('mail badge add-on skipped', e); }

      // Logs cleanup >48h (every 30min)
      try{
        async function cleanOldLogs(){
          const thresholdISO = new Date(Date.now() - 48*60*60*1000).toISOString();
          const q = query(collection(db,'logs'), where('createdAt','<=', thresholdISO));
          const snap = await getDocs(q);
          for(const d of snap.docs){ await deleteDoc(d.ref); }
        }
        cleanOldLogs();
        setInterval(cleanOldLogs, 30*60*1000);
      }catch(e){ console.warn('logs cleanup add-on skipped', e); }

      // Warnings history modal logic
      const warningsOverlay = document.getElementById('warningsOverlay');
      const closeWarnings = document.getElementById('closeWarnings');
      const warningsList = document.getElementById('warningsList');
      let _warnUnsub = null;
      function closeWarningsLive(){ if(_warnUnsub){ try{ _warnUnsub(); }catch(_e){} _warnUnsub=null; } }
      closeWarnings?.addEventListener('click', ()=>{ closeWarningsLive(); warningsOverlay.style.display='none'; });

      function openWarningsHistory(pseudo){
        warningsOverlay.style.display='flex';
        warningsList.innerHTML = '<p style="opacity:.8;margin:0">Chargement‚Ä¶</p>';
        try{
          const q = query(collection(db, 'users', pseudo, 'warnings'), orderBy('createdAt','desc'));
          closeWarningsLive();
          _warnUnsub = onSnapshot(q, (snap)=>{
            if(snap.empty){ warningsList.innerHTML = '<p style="opacity:.8;margin:0">Aucun avertissement.</p>'; return; }
            const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
            snap.forEach(d=>{
              const w=d.data(); const t=new Date(w.createdAt||Date.now());
              const li=document.createElement('li'); li.style.borderBottom='1px solid #4c4c62'; li.style.padding='8px 6px';
              const dateTxt = `${('0'+t.getDate()).slice(-2)}/${('0'+(t.getMonth()+1)).slice(-2)}/${t.getFullYear()} √† ${('0'+t.getHours()).slice(-2)}h${('0'+t.getMinutes()).slice(-2)}`;
              li.innerHTML = `<div style="font-weight:700;opacity:.95">${dateTxt}</div><div style="opacity:.9">Par <strong>${w.by||'‚Äî'}</strong></div><div style="opacity:.85;margin-top:4px">Raison : ${w.reason||'‚Äî'}</div>`;
              ul.appendChild(li);
            });
            warningsList.innerHTML=''; warningsList.appendChild(ul);
          });
        }catch(e){ console.warn('openWarningsHistory failed', e); }
      }

    })();

  
    // === Add-ons: mailbox badge, logs cleanup, profile modal, stop service ===
    (function(){
      // Helpers from base script assumed: db, current, showToast, addLog, formatDateFr
      // 1) Mailbox badge (admin/technicien only)
      try{
        const mailBadge = document.getElementById('mailBadge');
        if(current && (current.grade==='admin' || current.grade==='technicien')){
          onSnapshot(query(collection(db,'mailbox')), (snap)=>{
            let count = 0;
            snap.forEach(d=>{ const m=d.data(); if(m && m.to==='staff' && m.status==='pending' && m.type==='new_user'){ count++; } });
            if(mailBadge){ mailBadge.style.display = count>0 ? 'inline-block' : 'none'; if(count>0) mailBadge.textContent = String(count); }
          });
        } else {
          if(mailBadge) mailBadge.style.display='none';
        }
      }catch(e){ console.warn('mail badge add-on skipped', e); }

      // 2) Logs cleanup (>48h) every 30 min + remove limit(50) from stream (already removed in base if present)
      try{
        async function cleanOldLogs(){
          const thresholdISO = new Date(Date.now()-48*60*60*1000).toISOString();
          const qOld = query(collection(db,'logs'), where('createdAt','<=', thresholdISO));
          const snapOld = await getDocs(qOld);
          for(const d of snapOld.docs){ await deleteDoc(d.ref); }
        }
        cleanOldLogs();
        setInterval(cleanOldLogs, 30*60*1000);
      }catch(e){ console.warn('logs cleanup add-on skipped', e); }

      // 3) Profile modal (cards) + grade/ warnings
      const profileOverlay = document.getElementById('profileOverlay');
      const profileGrid = document.getElementById('profileGrid');
      document.getElementById('closeProfile')?.addEventListener('click', ()=> profileOverlay.style.display='none');

      function makeCard(title, value){
        const d=document.createElement('div'); d.className='glassCard';
        const h=document.createElement('h4'); h.textContent=title;
        const v=document.createElement('div'); v.className='val'; v.textContent=(value??'-');
        d.appendChild(h); d.appendChild(v); return d;
      }
      function makeGradeCard(pseudo, currentGrade){
        const d=document.createElement('div'); d.className='glassCard'; const h=document.createElement('h4'); h.textContent='Grade'; d.appendChild(h);
        const canChange = !!(current && (current.grade==='admin' || current.grade==='technicien'));
        if(!canChange){ d.appendChild(makeCard('', currentGrade).querySelector('.val')); return d; }
        const allowed = (current.grade==='admin')? ['new','certifi√©','technicien','admin'] : ['new','certifi√©','technicien'];
        const sel=document.createElement('select'); sel.style.background='var(--bg)'; sel.style.color='var(--text)'; sel.style.border='1px solid #4c4c62'; sel.style.padding='6px'; sel.style.borderRadius='8px';
        allowed.forEach(g=>{ const op=document.createElement('option'); op.value=g; op.textContent=g; if(g===currentGrade) op.selected=true; sel.appendChild(op); });
        sel.addEventListener('change', async()=>{
          try{
            const newGrade = sel.value;
            await updateDoc(doc(db,'users', pseudo), { grade: newGrade });
            // optimistic badge update
            try{ document.querySelectorAll('#userList li').forEach(li=>{ const st=li.querySelector('strong'); if(st && st.textContent.trim()===pseudo){ const b=li.querySelector('.badge'); if(b) b.textContent=newGrade; } }); }catch(_e){}
            addLog(`${current?.pseudo||'syst√®me'} a chang√© le grade de ${pseudo} ‚Üí ${newGrade}`); showToast('Grade mis √† jour ‚úÖ');
          }catch(e){ console.error(e); alert('Erreur de mise √† jour du grade'); }
        });
        d.appendChild(sel); return d;
      }
      

function makeWarningsCard(pseudo, count){
  const d=document.createElement('div'); d.className='glassCard';
  const h=document.createElement('h4'); h.textContent='Avertissements';
  const v=document.createElement('div'); v.className='val'; v.textContent=String(count??0);
  d.appendChild(h); d.appendChild(v);
  return d;
}



      // 4) Stop service card + reason modal (writes to Firestore + logs)
      const stopServiceOverlay = document.getElementById('stopServiceOverlay');
      const stopReason = document.getElementById('stopReason');
      const stopWarn = document.getElementById('stopWarn');
      const stopConfirm = document.getElementById('stopConfirm');
      const stopCancel = document.getElementById('stopCancel');
      let _stopTarget = null;

      
function makeStopServiceCard(pseudo, isActive){
  const d=document.createElement('div'); d.className='glassCard clickable'; const h=document.createElement('h4'); h.textContent='Arr√™ter le service';
  const v=document.createElement('div'); v.className='val'; v.textContent='Forcer l\'arr√™t du timer';
  d.appendChild(h); d.appendChild(v);
  if(!(current && (current.grade==='admin' || current.grade==='technicien'))){ d.style.display='none'; return d; }
  if(!isActive){ d.classList.add('disabled'); v.textContent='Service inactif'; }
  d.addEventListener('click', async ()=>{
    if(d.classList.contains('disabled')) return;
    _stopTarget = pseudo;
    try{
      const uRef=doc(db,'users', pseudo); const snap=await getDoc(uRef);
      if(snap.exists()){
        const u=snap.data();
        if(u.serviceActive && u.serviceStart){
          const diffMs=Date.now()-new Date(u.serviceStart).getTime(); const addH=diffMs/1000/3600;
          await updateDoc(uRef,{ serviceActive:false, totalHours:(u.totalHours||0)+addH, weeklyHours:(u.weeklyHours||0)+addH });
          addLog(`${current?.pseudo||'staff'} a arr√™t√© le service de ${pseudo} (ajout ${addH.toFixed(2)}h)`); showToast(`Service arr√™t√© pour ${pseudo}`);
        } else { showToast(`Service d√©j√† inactif pour ${pseudo}`); }
      }
    }catch(e){ console.error('stop service error', e); alert('Erreur lors de l\'arr√™t du service'); }
    if(stopServiceOverlay){ stopReason.value=''; stopWarn.checked=false; stopServiceOverlay.style.display='flex'; }
  });
  return d;
}

      stopCancel?.addEventListener('click', ()=>{ if(stopServiceOverlay) stopServiceOverlay.style.display='none'; });
      stopConfirm?.addEventListener('click', async()=>{
        try{
          const reason=(stopReason?.value||'').trim(); const warn=!!(stopWarn?.checked);
          if(_stopTarget){
            // store to logs (reason + warn)
            await addLog(`${current?.pseudo||'staff'} a consign√© l'arr√™t pour ${_stopTarget} ‚Äî raison: ${reason||'aucune'} ‚Äî avertissement: ${warn?'oui':'non'}`);
            // if warn, increment user's warnings + create structured warning subdoc
            if(warn){
              const ref=doc(db,'users', _stopTarget);
              const snap=await getDoc(ref);
              const cur=Math.max(0,(snap.exists() && typeof snap.data().warnings==='number')? snap.data().warnings:0);
              await updateDoc(ref,{ warnings: cur+1 });
              try{
                await addDoc(collection(db, 'users', _stopTarget, 'warnings'), {
                  reason: reason || '‚Äî',
                  by: current?.pseudo || 'staff',
                  createdAt: new Date().toISOString()
                });
              }catch(e){ console.warn('write warnings subdoc failed', e); }
            }
          }
          showToast('Arr√™t enregistr√©'); 
        }catch(e){ console.error(e); alert('Erreur d\'enregistrement'); }
        if(stopServiceOverlay) stopServiceOverlay.style.display='none';
      });

      // 5) Open profile on left sidebar click (delegation, no change to renderUsers)
      document.getElementById('userList')?.addEventListener('click', async (e)=>{
        const li=e.target.closest('li'); if(!li) return;
        const strongEl = li.querySelector('strong'); const pseudo = strongEl ? strongEl.textContent.trim() : null;
        if(!pseudo) return;
        try{
          const uRef=doc(db,'users', pseudo); const uSnap=await getDoc(uRef); if(!uSnap.exists()){ alert('Utilisateur introuvable'); return; }
          const u=uSnap.data();
          let fichesCount=0; try{ const q=query(collection(db,'Fiche'), where('createdBy','==', pseudo)); const qs=await getDocs(q); fichesCount=qs.size; }catch(_e){}
          profileGrid.innerHTML='';
          profileGrid.appendChild(makeCard('Pseudo', pseudo));
          profileGrid.appendChild(makeGradeCard(pseudo, u.grade||'new'));
          profileGrid.appendChild(makeCard('Cr√©√© le', u.createdAt? formatDateFr(u.createdAt) : '-'));
          profileGrid.appendChild(makeCard('Heures totales', ((u.totalHours||0).toFixed(1)+' h')));
          profileGrid.appendChild(makeCard('Heures semaine', ((u.weeklyHours||0).toFixed(1)+' h')));
          profileGrid.appendChild(makeCard('Fiches cr√©√©es', String(fichesCount)));
          profileGrid.appendChild(makeWarningsCard(pseudo, (typeof u.warnings==='number')?u.warnings:0));
          profileGrid.appendChild(makeStopServiceCard(pseudo, !!(u.serviceActive && u.serviceStart)));
          profileOverlay.style.display='flex';
        }catch(err){ console.error('open profile error', err); console.warn('Erreur chargement profil'); }
      });

      // 6) ESC closes our overlays (in addition to base)
      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){
          if(profileOverlay && profileOverlay.style.display!=='none') profileOverlay.style.display='none';
          const so=document.getElementById('stopServiceOverlay'); if(so && so.style.display!=='none') so.style.display='none';
          const wo=document.getElementById('warningsOverlay'); if(wo && wo.style.display!=='none') wo.style.display='none';
        }
      });

      // Warnings history modal logic
      const warningsOverlay = document.getElementById('warningsOverlay');
      const closeWarnings = document.getElementById('closeWarnings');
      const warningsList = document.getElementById('warningsList');
      let _warnUnsub = null;
      function closeWarningsLive(){ if(_warnUnsub){ try{ _warnUnsub(); }catch(_e){} _warnUnsub=null; } }
      closeWarnings?.addEventListener('click', ()=>{ closeWarningsLive(); warningsOverlay.style.display='none'; });

      function openWarningsHistory(pseudo){
        warningsOverlay.style.display='flex';
        warningsList.innerHTML = '<p style="opacity:.8;margin:0">Chargement‚Ä¶</p>';
        try{
          const q = query(collection(db, 'users', pseudo, 'warnings'), orderBy('createdAt','desc'));
          closeWarningsLive();
          _warnUnsub = onSnapshot(q, (snap)=>{
            if(snap.empty){ warningsList.innerHTML = '<p style="opacity:.8;margin:0">Aucun avertissement.</p>'; return; }
            const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
            snap.forEach(d=>{
              const w=d.data(); const t=new Date(w.createdAt||Date.now());
              const li=document.createElement('li'); li.style.borderBottom='1px solid #4c4c62'; li.style.padding='8px 6px';
              const dateTxt = `${('0'+t.getDate()).slice(-2)}/${('0'+(t.getMonth()+1)).slice(-2)}/${t.getFullYear()} √† ${('0'+t.getHours()).slice(-2)}h${('0'+t.getMinutes()).slice(-2)}`;
              li.innerHTML = `<div style="font-weight:700;opacity:.95">${dateTxt}</div><div style="opacity:.9">Par <strong>${w.by||'‚Äî'}</strong></div><div style="opacity:.85;margin-top:4px">Raison : ${w.reason||'‚Äî'}</div>`;
              ul.appendChild(li);
            });
            warningsList.innerHTML=''; warningsList.appendChild(ul);
          });
        }catch(e){ console.warn('openWarningsHistory failed', e); }
      }

    })();


    // === Live profile updates + badge colorizer ===
    (function(){
      // Badge colorizer
      function applyBadgeColors(root){
        const list = (root||document).querySelectorAll('#userList .badge');
        list.forEach(b=>{
          const g = (b.textContent||'').trim().toLowerCase();
          b.classList.remove('role-technicien','role-certifi√©');
          if(g==='technicien'){ b.classList.add('role-technicien'); }
          else if(g==='certifi√©'){ b.classList.add('role-certifi√©'); }
        });
      }
      applyBadgeColors();
      const userListEl = document.getElementById('userList');
      if(userListEl){
        const mo = new MutationObserver(()=> applyBadgeColors(userListEl));
        mo.observe(userListEl, { childList:true, subtree:true, characterData:true });
      }

      // Live profile snapshot
      let _profileUnsub = null;
      let _fichesUnsub = null;
      function closeProfileLive(){
        if(_profileUnsub){ try{ _profileUnsub(); }catch(_e){} _profileUnsub=null; }
        if(_fichesUnsub){ try{ _fichesUnsub(); }catch(_e){} _fichesUnsub=null; }
      }
      const closeProfileBtn = document.getElementById('closeProfile');
      if(closeProfileBtn){
        closeProfileBtn.addEventListener('click', closeProfileLive);
      }

      // Hook into existing profile open handler by delegation (already added earlier)
      // Enhance to subscribe to realtime updates after initial render
      const origOpenHandler = (e)=>{}; // placeholder

      // We rebind the userList click to include onSnapshot setup but keep behavior
      const UL = document.getElementById('userList');
      if(UL){
        let _profileOpening=false;
      UL.addEventListener('click', async (e)=>{
          const li=e.target.closest('li'); if(!li) return;
          const strongEl = li.querySelector('strong'); const pseudo = strongEl ? strongEl.textContent.trim() : null;
          if(!pseudo) return;
          if(_profileOpening) return; _profileOpening=true; setTimeout(()=>{_profileOpening=false;}, 400);
          // Build initial once (reuse functions existing in file)
          try{
            const uRef=doc(db,'users', pseudo); const uSnap=await getDoc(uRef); if(!uSnap.exists()){ alert('Utilisateur introuvable'); return; }
            const u=uSnap.data();
            // Count fiches initial
            let fichesCount=0; try{ const q=query(collection(db,'Fiche'), where('createdBy','==', pseudo)); const qs=await getDocs(q); fichesCount=qs.size; }catch(_e){}
            // Build grid
            profileGrid.innerHTML='';
            profileGrid.appendChild(makeCard('Pseudo', pseudo));
            const gradeCard = makeGradeCard(pseudo, u.grade||'new'); profileGrid.appendChild(gradeCard);
            const createdEl = makeCard('Cr√©√© le', u.createdAt? formatDateFr(u.createdAt):'-'); profileGrid.appendChild(createdEl);
            const totalEl = makeCard('Heures totales', ((u.totalHours||0).toFixed(1)+' h')); profileGrid.appendChild(totalEl);
            const weekEl  = makeCard('Heures semaine', ((u.weeklyHours||0).toFixed(1)+' h')); profileGrid.appendChild(weekEl);
            const fichesEl= makeCard('Fiches cr√©√©es', String(fichesCount)); profileGrid.appendChild(fichesEl);
            const warnCard= makeWarningsCard(pseudo, (typeof u.warnings==='number')?u.warnings:0); profileGrid.appendChild(warnCard);
          if(current && (current.grade==='admin' || current.grade==='technicien')){ warnCard.style.cursor='pointer'; warnCard.addEventListener('click', ()=> openWarningsHistory(pseudo)); }
            if(current && (current.grade==='admin' || current.grade==='technicien')){ var _stopCard = makeStopServiceCard(pseudo, !!u.serviceActive); profileGrid.appendChild(_stopCard); }
            profileOverlay.style.display='flex';

            // Grab value refs for live updates
            const createdVal = createdEl.querySelector('.val');
            const totalVal   = totalEl.querySelector('.val');
            const weekVal    = weekEl.querySelector('.val');
            const warnVal    = warnCard.querySelector('.val');

            // Unsubscribe previous if any
            closeProfileLive();

            // Live user doc
            _profileUnsub = onSnapshot(uRef, snap=>{
              if(!snap.exists()) return;
              const data = snap.data();
              // Update grade badge in sidebar (in case it changed elsewhere)
              try{
                document.querySelectorAll('#userList li').forEach(li2=>{
                  const st=li2.querySelector('strong');
                  if(st && st.textContent.trim()===pseudo){
                    const b=li2.querySelector('.badge');
                    if(b){ b.textContent = data.grade || 'new'; applyBadgeColors(); }
                  }
                });
              }catch(_e){}
              // Update fields
              if(createdVal) createdVal.textContent = data.createdAt ? formatDateFr(data.createdAt) : '-';
              if(totalVal)   totalVal.textContent   = ((data.totalHours||0).toFixed(1)+' h');
              if(weekVal)    weekVal.textContent    = ((data.weeklyHours||0).toFixed(1)+' h');
              if(warnVal && typeof data.warnings==='number') warnVal.textContent = String(data.warnings);
              // live update stop card enabled/disabled
              try{ if(_stopCard){ if(data.serviceActive){ _stopCard.classList.remove('disabled'); _stopCard.querySelector('.val').textContent = "Forcer l'arr√™t du timer"; } else { _stopCard.classList.add('disabled'); _stopCard.querySelector('.val').textContent = 'Service inactif'; } } }catch(_e){}
            });

            // Live fiches count
            try{
              const fq = query(collection(db,'Fiche'), where('createdBy','==', pseudo));
              _fichesUnsub = onSnapshot(fq, snap2=>{
                if(fichesEl){
                  fichesEl.querySelector('.val').textContent = String(snap2.size);
                }
              });
            }catch(_e){}

          }catch(err){ console.error('open profile error', err); console.warn('Erreur chargement profil'); }
        }, { capture: true });
      }

      // Also close subscriptions if overlay itself is clicked outside (if base script handles, we add extra guard)
      const profOverlay = document.getElementById('profileOverlay');
      if(profOverlay){
        profOverlay.addEventListener('click', (e)=>{ if(e.target===profOverlay){ closeProfileLive(); } });
      }
      document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){ closeProfileLive(); }
      });

      // Warnings history modal logic
      const warningsOverlay = document.getElementById('warningsOverlay');
      const closeWarnings = document.getElementById('closeWarnings');
      const warningsList = document.getElementById('warningsList');
      let _warnUnsub = null;
      function closeWarningsLive(){ if(_warnUnsub){ try{ _warnUnsub(); }catch(_e){} _warnUnsub=null; } }
      closeWarnings?.addEventListener('click', ()=>{ closeWarningsLive(); warningsOverlay.style.display='none'; });

      function openWarningsHistory(pseudo){
        warningsOverlay.style.display='flex';
        warningsList.innerHTML = '<p style="opacity:.8;margin:0">Chargement‚Ä¶</p>';
        try{
          const q = query(collection(db, 'users', pseudo, 'warnings'), orderBy('createdAt','desc'));
          closeWarningsLive();
          _warnUnsub = onSnapshot(q, (snap)=>{
            if(snap.empty){ warningsList.innerHTML = '<p style="opacity:.8;margin:0">Aucun avertissement.</p>'; return; }
            const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
            snap.forEach(d=>{
              const w=d.data(); const t=new Date(w.createdAt||Date.now());
              const li=document.createElement('li'); li.style.borderBottom='1px solid #4c4c62'; li.style.padding='8px 6px';
              const dateTxt = `${('0'+t.getDate()).slice(-2)}/${('0'+(t.getMonth()+1)).slice(-2)}/${t.getFullYear()} √† ${('0'+t.getHours()).slice(-2)}h${('0'+t.getMinutes()).slice(-2)}`;
              li.innerHTML = `<div style="font-weight:700;opacity:.95">${dateTxt}</div><div style="opacity:.9">Par <strong>${w.by||'‚Äî'}</strong></div><div style="opacity:.85;margin-top:4px">Raison : ${w.reason||'‚Äî'}</div>`;
              ul.appendChild(li);
            });
            warningsList.innerHTML=''; warningsList.appendChild(ul);
          });
        }catch(e){ console.warn('openWarningsHistory failed', e); }
      }

    })();


// === Dossier m√©dical: d√©doublonnage par (Nom + DateNaissance) + historique ===
(function(){
  try{
    if(window.__dossierPatched) return; window.__dossierPatched = true;

    const _renderPatients = window.renderPatients;
    const _openPatientView = window.openPatientView;

    function normName(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,' '); }
    function normDate(d){
      try{
        if(d && typeof d === 'object' && 'seconds' in d){ const t=new Date(d.seconds*1000); return t.toISOString().slice(0,10); }
        const t = new Date(d); if(!t || isNaN(t)) return ''; return t.toISOString().slice(0,10);
      }catch(_){ return ''; }
    }
    function keyOf(p){ return `${normName(p.nom)}|${normDate(p.dateNaissance)}`; }
    function samePatient(a,b){ return keyOf(a) === keyOf(b); }

    function dedupLatestByKey(list){
      const map = new Map();
      (list||[]).forEach(p=>{
        const key = keyOf(p);
        const prev = map.get(key);
        const pa = new Date(p.createdAt||0);
        const pb = prev ? new Date(prev.createdAt||0) : new Date(0);
        if(!prev || pa > pb) map.set(key, p);
      });
      return Array.from(map.values());
    }

    if (typeof _renderPatients === 'function'){
      window.renderPatients = function(list){
        try{ _renderPatients(dedupLatestByKey(list)); }
        catch(_){ _renderPatients(list); }
      };
    }

    function fmtDate(d){
      try{
        if(d && typeof d === 'object' && 'seconds' in d){ const t=new Date(d.seconds*1000); return `${('0'+t.getDate()).slice(-2)}/${('0'+(t.getMonth()+1)).slice(-2)}/${t.getFullYear()} ${('0'+t.getHours()).slice(-2)}h${('0'+t.getMinutes()).slice(-2)}`; }
        const t=new Date(d); if(!t||isNaN(t)) return '‚Äî';
        return `${('0'+t.getDate()).slice(-2)}/${('0'+(t.getMonth()+1)).slice(-2)}/${t.getFullYear()} ${('0'+t.getHours()).slice(-2)}h${('0'+t.getMinutes()).slice(-2)}`;
      }catch(_){ return '‚Äî'; }
    }
    function computeAgeISO(iso){
      try{
        if(iso && typeof iso === 'object' && 'seconds' in iso){ const d=new Date(iso.seconds*1000); const diff=Date.now()-d.getTime(); return Math.max(0,new Date(diff).getUTCFullYear()-1970); }
        const d=new Date(iso); if(!d||isNaN(d)) return ''; const diff=Date.now()-d.getTime(); return Math.max(0,new Date(diff).getUTCFullYear()-1970);
      }catch(_){ return ''; }
    }

    async function fetchAllForPatient(p){
      const snap = await getDocs(collection(db,'Fiche'));
      const out=[];
      snap.forEach(d=>{ const x=d.data()||{}; if(samePatient(x,p)) out.push({id:d.id, ...x}); });
      out.sort((a,b)=> new Date(b.createdAt||0) - new Date(a.createdAt||0));
      return out;
    }

    function cardFor(p){
      const div=document.createElement('div');
      div.className='glassCard clickable';
      div.style.margin='8px 0';
      const created=fmtDate(p.createdAt);
      const age=p.age || computeAgeISO(p.dateNaissance);
      const birth=p.dateNaissance ? fmtDate(p.dateNaissance) : '‚Äî';
      div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <div style="font-weight:800">${(p.nom||'').trim()} ${(p.prenom||'').trim()}</div>
          <span class="badge">cr√©√©e le ${created}</span>
        </div>
        <div class="muted" style="margin-bottom:6px">Naissance: ${birth} ‚Äî √Çge: ${age||'‚Äî'} ‚Äî Sexe: ${(p.sexe||'‚Äî').toString().toUpperCase()} ‚Äî Groupe: ${p.groupeSanguin||'‚Äî'}</div>
        ${p.natureBlessure? `<div class="muted">Blessure: ${p.natureBlessure}</div>`:''}
      `;
      div.addEventListener('click', (e)=>{ e.stopPropagation(); _openPatientView(p); });
      return div;
    }

    function ensureHistoryOverlay(){
      let o=document.getElementById('patientHistoryOverlay'); if(o) return o;
      o=document.createElement('div'); o.id='patientHistoryOverlay'; o.className='overlay';
      o.innerHTML = `<div class="modal" style="max-width:900px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <h2 id="histTitle" style="margin:0">Historique des fiches</h2>
          <button id="closeHistory" class="btn-secondary" type="button">Fermer</button>
        </div>
        <div id="historyList" style="margin-top:10px;max-height:70vh;overflow:auto"></div>
      </div>`;
      document.body.appendChild(o);
      o.addEventListener('click', (e)=>{ if(e.target===o) o.style.display='none'; });
      o.querySelector('#closeHistory').addEventListener('click', ()=> o.style.display='none');
      return o;
    }

    function insertHistoryButton(currentPatient){
      const content=document.getElementById('patientViewContent');
      const overlay=document.getElementById('patientViewOverlay');
      if(!content || !overlay) return;
      if(content.querySelector('#goHistoryBtn')) return;
      const bar=document.createElement('div');
      bar.style.display='flex'; bar.style.justifyContent='space-between'; bar.style.margin='6px 0 8px 0'; bar.style.alignItems='center';
      const hint=document.createElement('div'); hint.className='muted'; hint.textContent='Astuce: descendez pour voir les anciennes fiches.';
      const btn=document.createElement('button');
      btn.id='goHistoryBtn'; btn.className='btn-secondary'; btn.type='button'; btn.textContent='Aller dans l‚Äôhistorique';
      btn.addEventListener('click', async (e)=>{
        e.stopPropagation();
        overlay.style.display='none';
        const o=ensureHistoryOverlay(); o.style.display='flex';
        const list=o.querySelector('#historyList'); const title=o.querySelector('#histTitle');
        title.textContent = `Historique ‚Äî ${(currentPatient.nom||'').trim()} ${(currentPatient.prenom||'').trim()} (${normDate(currentPatient.dateNaissance)||'‚Äî'})`;
        list.innerHTML = '<div class="muted" style="padding:8px 0">Chargement...</div>';
        try{
          const rows = await fetchAllForPatient(currentPatient);
          list.innerHTML='';
          if(!rows.length){ list.innerHTML = '<div class="muted" style="padding:8px 0">Aucune fiche trouv√©e.</div>'; return; }
          rows.forEach(r => list.appendChild(cardFor(r)));
        }catch(_){ list.innerHTML = '<div class="muted" style="padding:8px 0">Erreur de chargement.</div>'; }
      });
      bar.appendChild(hint);
      bar.appendChild(btn);
      content.prepend(bar);
    }

    function renderInlineHistory(base){
      const content=document.getElementById('patientViewContent'); if(!content) return;
      let hist = document.getElementById('patientHistory');
      if(!hist){
        hist = document.createElement('div');
        hist.id='patientHistory';
        hist.innerHTML='<h3 class="muted" style="margin:14px 0 8px 0">Historique des fiches</h3><div id="patientHistoryBody" style="display:flex;flex-direction:column;gap:10px"></div>';
        content.appendChild(hist);
      }
      const body=document.getElementById('patientHistoryBody');
      body.innerHTML='<div class="muted">Chargement...</div>';
      fetchAllForPatient(base).then(rows=>{
        const rest = rows.filter(r=> r.id !== base.id);
        body.innerHTML='';
        if(!rest.length){ body.innerHTML='<div class="muted">Aucune fiche ant√©rieure.</div>'; return; }
        rest.forEach(r => body.appendChild(cardFor(r)));
      }).catch(()=>{ body.innerHTML='<div class="muted">Erreur de chargement.</div>'; });
    }

    window.openPatientView = function(p){
      _openPatientView(p);
      try{
        insertHistoryButton(p);
        renderInlineHistory(p);
      }catch(_){}
    };

    // ---- Autocompl√©tion bas√©e sur (Nom + DateNaissance) pour √©viter doublons ----
    (function(){
      try{
        const nomEl = document.getElementById('nom');
        const prenomEl = document.getElementById('prenom');
        const modalOverlay = document.getElementById('modalOverlay');
        if(!nomEl) return;
        let box = null;
        function hideBox(){ if(box){ box.remove(); box=null; } }
        function ensureBox(){
          if(box) return box;
          const wrap = nomEl.parentElement; if(!wrap) return null;
          wrap.style.position='relative';
          box = document.createElement('div');
          box.id='nomSuggest'; box.style.position='absolute'; box.style.left='0'; box.style.right='0'; box.style.top='calc(100% + 4px)';
          box.style.zIndex='1000'; box.style.background='rgba(43,43,61,0.98)'; box.style.border='1px solid #4c4c62'; box.style.borderRadius='12px';
          box.style.boxShadow='0 8px 30px rgba(0,0,0,0.4)'; box.style.maxHeight='220px'; box.style.overflowY='auto';
          wrap.appendChild(box); return box;
        }
        function computeAgeISO(iso){
          try{
            if(iso && typeof iso === 'object' && 'seconds' in iso){ const d=new Date(iso.seconds*1000); const diff=Date.now()-d.getTime(); return Math.max(0,new Date(diff).getUTCFullYear()-1970); }
            const d=new Date(iso); if(!d||isNaN(d)) return ''; const diff=Date.now()-d.getTime(); return Math.max(0,new Date(diff).getUTCFullYear()-1970);
          }catch(_){ return ''; }
        }
        function lineFor(p){
          const l=document.createElement('div');
          l.style.padding='8px 10px'; l.style.cursor='pointer'; l.style.borderBottom='1px solid rgba(255,255,255,0.06)';
          l.addEventListener('mouseenter', ()=> l.style.background='rgba(255,255,255,0.06)');
          l.addEventListener('mouseleave', ()=> l.style.background='transparent');
          const dn = p.dateNaissance; const dnTxt = dn ? ( (dn && dn.seconds) ? new Date(dn.seconds*1000).toLocaleDateString('fr-FR') : new Date(dn).toLocaleDateString('fr-FR') ) : '‚Äî';
          l.textContent = `${(p.nom||'').trim()} ${(p.prenom||'').trim()} ‚Äî ${(p.sexe||'').toString().toUpperCase()||'A'} ‚Äî ${p.groupeSanguin||'-'} ‚Äî ${dnTxt}`;
          l.addEventListener('click', ()=>{
            try{
              const nomI=document.getElementById('nom'); if(nomI) nomI.value=p.nom||'';
              const preI=document.getElementById('prenom'); if(preI) preI.value=p.prenom||'';
              const sexI=document.getElementById('sexe'); if(sexI && p.sexe) sexI.value=p.sexe;
              const grpI=document.getElementById('groupeSanguin'); if(grpI && p.groupeSanguin) grpI.value=p.groupeSanguin;
              const dnI=document.getElementById('dateNaissance'); if(dnI && p.dateNaissance){ dnI.value = normDate(p.dateNaissance); }
              const ageI=document.getElementById('age'); if(ageI) ageI.value = computeAgeISO(p.dateNaissance);
            }catch(_){}
            hideBox();
          });
          return l;
        }
        function dedupLatest(list){
          const map=new Map();
          (list||[]).forEach(p=>{
            const key=keyOf(p);
            const prev=map.get(key);
            const pa=new Date(p.createdAt||0); const pb=prev? new Date(prev.createdAt||0): new Date(0);
            if(!prev || pa>pb) map.set(key,p);
          });
          return Array.from(map.values());
        }
        async function fetchSuggestions(){
          try{
            hideBox();
            const prefix = (nomEl.value||'').trim().toLowerCase();
            if(prefix.length < 3) return;
            const pre = (prenomEl?.value||'').trim().toLowerCase();
            const snap = await getDocs(collection(db,'Fiche'));
            const arr=[];
            snap.forEach(d=>{
              const p=d.data()||{};
              const n=normName(p.nom);
              const pr=normName(p.prenom);
              if(!n.startsWith(prefix)) return;
              if(pre && !pr.startsWith(pre)) return;
              arr.push({id:d.id, ...p});
            });
            const latest = dedupLatest(arr).sort((a,b)=> (a.nom||'').localeCompare(b.nom||'', 'fr', {sensitivity:'base'})).slice(0,8);
            if(!latest.length) return;
            const b=ensureBox(); if(!b) return;
            b.innerHTML=''; latest.forEach(p=> b.appendChild(lineFor(p)));
          }catch(_){}
        }
        function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
        const debounced = debounce(fetchSuggestions, 180);
        nomEl.addEventListener('input', debounced);
        prenomEl?.addEventListener('input', debounced);
        document.getElementById('closeModal')?.addEventListener('click', hideBox);
        modalOverlay?.addEventListener('click', (e)=>{
          const target=e.target;
          const inside = target===box || (box && box.contains(target)) || target===nomEl || target===prenomEl;
          if(!inside) hideBox();
        });
      }catch(_){}
    })();

  }catch(_){}
})();
// === Fin dossier m√©dical ===
</script>
</body>
</html>
