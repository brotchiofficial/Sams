<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; height:100vh; background:#2B2B3D; color:#f0f0f0; }
    #sidebar-left { width:250px; background:#1e1e2a; color:white; overflow-y:auto; padding:10px; }
    #sidebar-left h2 { margin:0 0 10px; text-align:center; }
    #userList { list-style:none; padding:0; }
    #userList li { display:flex; align-items:center; justify-content:space-between; padding:6px; border-bottom:1px solid #333; font-size:14px; }
    .status { display:flex; align-items:center; gap:6px; }
    .circle { width:12px; height:12px; border-radius:50%; display:inline-block; }
    .off { border:2px solid white; background:transparent; }
    .on { background:#28a745; }
    #content { flex:1; display:flex; justify-content:center; align-items:center; flex-direction:column; }
    .service-box { background:#3a3a50; padding:30px; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.4); text-align:center; width:420px; margin-bottom:20px; }
    button { display:block; margin:10px auto; padding:10px 20px; border:none; color:white; font-size:16px; border-radius:6px; cursor:pointer; width:80%; }
    #startService { background:#28a745; } #stopService { background:#dc3545; } #changePwd { background:#007BFF; } #logoutBtn { background:#6c757d; }
    #sidebar-right { width:300px; background:#1e1e2a; color:white; overflow-y:auto; padding:10px; }
    #sidebar-right h2 { margin:0 0 10px; text-align:center; }
    #patientList { list-style:none; padding:0; }
    #patientList li { padding:6px; border-bottom:1px solid #333; font-size:14px; }
    input, select { margin:4px; padding:6px; border-radius:6px; border:none; }
  </style>
</head>
<body>
  <div id="sidebar-left">
    <h2>Joueurs</h2>
    <ul id="userList"></ul>
  </div>
  <div id="content">
    <div class="service-box">
      <h1 id="welcome">Bienvenue ðŸŽ‰</h1>
      <p id="gradeInfo"></p>
      <p>Total heures de service : <span id="totalHours">0</span> h</p>
      <p>Heures cette semaine : <span id="weeklyHours">0</span> h</p>
      <p>Timer service : <span id="timer">00:00</span> <span id="statusIcon"></span></p>
      <button id="startService">Commencer le service</button>
      <button id="stopService">Finir le service</button>
      <button id="changePwd">Changer le mot de passe</button>
      <button id="logoutBtn" onclick="logout()">â¬… DÃ©connexion</button>
    </div>
  </div>
  <div id="sidebar-right">
    <h2>Patients</h2>
    <div>
      <input type="text" id="patientNom" placeholder="Nom">
      <input type="text" id="patientPrenom" placeholder="PrÃ©nom">
      <input type="date" id="patientDate">
      <button id="addPatient">Ajouter patient</button>
    </div>
    <ul id="patientList"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMGMkmVgl8h0WuknCA-AChlyoX95RufNs",
      authDomain: "base-de-donnee-b5c8c.firebaseapp.com",
      projectId: "base-de-donnee-b5c8c",
      storageBucket: "base-de-donnee-b5c8c.firebasestorage.app",
      messagingSenderId: "302677536354",
      appId: "1:302677536354:web:54e0d4562bad5f06c3ab3b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const savedUser = localStorage.getItem("currentUser");
    if (!savedUser) window.location.href = "index.html";
    const user = JSON.parse(savedUser);
    document.getElementById("welcome").textContent = "Bienvenue " + user.pseudo + " ðŸŽ‰";
    document.getElementById("gradeInfo").textContent = "Ton grade : " + user.grade;

    // Charger la liste des patients en temps rÃ©el
    function loadPatientsRealtime(){
      onSnapshot(collection(db,"patients"),(snapshot)=>{
        const list=document.getElementById("patientList");
        list.innerHTML="";
        let patients=[];
        snapshot.forEach(docSnap=>{
          patients.push({id:docSnap.id,...docSnap.data()});
        });
        patients.sort((a,b)=>a.nom.localeCompare(b.nom));
        patients.forEach(p=>{
          const li=document.createElement("li");
          li.textContent=p.nom+" "+p.prenom+" ("+p.dateNaissance+")";
          list.appendChild(li);
        });
      });
    }

    // Ajouter patient
    document.getElementById("addPatient").addEventListener("click",async()=>{
      const nom=document.getElementById("patientNom").value.trim();
      const prenom=document.getElementById("patientPrenom").value.trim();
      const date=document.getElementById("patientDate").value;
      if(!nom||!prenom||!date){ alert("Remplis tous les champs"); return; }
      await addDoc(collection(db,"patients"),{
        nom:nom,prenom:prenom,dateNaissance:date,createdAt:new Date().toISOString(),createdBy:user.pseudo
      });
      document.getElementById("patientNom").value="";
      document.getElementById("patientPrenom").value="";
      document.getElementById("patientDate").value="";
    });

    loadPatientsRealtime();

    window.logout=function(){ localStorage.removeItem("currentUser"); window.location.href="index.html"; }
  </script>
</body>
</html>