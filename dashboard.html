<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard v16.9</title>
  <style>
    body {
      margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:#2B2B3D; color:#f0f0f0; height:100vh; display:flex; justify-content:center; align-items:center;
    }
    .card {
      background:rgba(43,43,61,0.9); backdrop-filter:blur(10px);
      padding:30px; border-radius:20px; box-shadow:0 8px 30px rgba(0,0,0,0.5);
      text-align:center; width:420px; z-index:1;
    }
    button {
      padding:12px; margin:8px 0; width:90%; border:none; border-radius:10px;
      font-weight:bold; cursor:pointer; transition:0.3s;
    }
    #startService{background:#4CAF50;color:white;}
    #stopService{background:#dc3545;color:white;}
    #changePwd{background:#007BFF;color:white;}
    #logoutBtn{background:#6c757d;color:white;}
    /* Sidebars */
    #sidebarLeft, #sidebarRight {
      position:fixed; top:0; bottom:0; width:260px; padding:15px; overflow-y:auto;
      background:rgba(43,43,61,0.9); backdrop-filter:blur(10px); box-shadow:0 0 15px rgba(0,0,0,0.4);
    }
    #sidebarLeft { left:0; }
    #sidebarRight { right:0; }
    #sidebarLeft h2, #sidebarRight h2 { text-align:center; margin-top:0; }
    ul {list-style:none; padding:0; margin:0;}
    li {background:rgba(255,255,255,0.05); margin:6px 0; padding:10px; border-radius:10px;}
    /* Modal patient */
    #modalOverlay {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:10;
    }
    #modal {
      background:rgba(43,43,61,0.95); backdrop-filter:blur(12px);
      padding:20px; border-radius:20px; width:600px; max-height:90%; overflow-y:auto;
    }
    #modal h2 {text-align:center;}
    #modal label {display:block; margin-top:10px;}
    #modal input, #modal select {
      width:95%; padding:8px; border-radius:6px; border:none; margin-top:4px;
    }
    #modal button {width:100%; margin-top:10px;}
  </style>
</head>
<body>
  <!-- Sidebar gauche -->
  <div id="sidebarLeft">
    <h2>Joueurs</h2>
    <ul id="userList"></ul>
  </div>
  <!-- Contenu central -->
  <div class="card">
    <h1 id="welcome"></h1>
    <p id="gradeInfo"></p>
    <p>Total heures : <span id="totalHours">0</span> h</p>
    <p>Cette semaine : <span id="weeklyHours">0</span> h</p>
    <p>Timer : <span id="timer">00:00</span> <span id="statusIcon"></span></p>
    <button id="startService">Commencer</button>
    <button id="stopService">Finir</button>
    <button id="changePwd">Changer mot de passe</button>
    <button id="logoutBtn">â¬… DÃ©connexion</button>
  </div>
  <!-- Sidebar droite -->
  <div id="sidebarRight">
    <h2>Patients</h2>
    <button id="createPatientBtn" style="background:#007BFF;color:white;">CrÃ©er une fiche patient</button>
    <input type="text" id="searchPatient" placeholder="Rechercher...">
    <ul id="patientList"></ul>
  </div>
  <!-- Modal crÃ©ation patient -->
  <div id="modalOverlay">
    <div id="modal">
      <h2>Nouvelle fiche patient</h2>
      <form id="patientForm">
        <label>Nom<input type="text" id="nom" required></label>
        <label>PrÃ©nom<input type="text" id="prenom" required></label>
        <label>Date de naissance<input type="date" id="dateNaissance" required></label>
        <label>Ã‚ge<input type="number" id="age" readonly></label>
        <label>Nature de la blessure<input type="text" id="natureBlessure"></label>
        <button type="submit">Enregistrer</button>
        <button type="button" id="closeModal">Annuler</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMGMkmVgl8h0WuknCA-AChlyoX95RufNs",
      authDomain: "base-de-donnee-b5c8c.firebaseapp.com",
      projectId: "base-de-donnee-b5c8c",
      storageBucket: "base-de-donnee-b5c8c.firebasestorage.app",
      messagingSenderId: "302677536354",
      appId: "1:302677536354:web:54e0d4562bad5f06c3ab3b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // RÃ©cupÃ©ration user connectÃ©
    const savedUser = localStorage.getItem("currentUser");
    let user = savedUser ? JSON.parse(savedUser) : null;
    if(user){
      document.getElementById("welcome").textContent = "Bienvenue " + user.pseudo + " ðŸŽ‰";
      document.getElementById("gradeInfo").textContent = "Ton grade : " + user.grade;
    }

    // DÃ©connexion simple
    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      window.location.href="index.html";
    });

    // Modal patient
    const modalOverlay = document.getElementById("modalOverlay");
    document.getElementById("createPatientBtn").addEventListener("click", ()=>{ modalOverlay.style.display="flex"; });
    document.getElementById("closeModal").addEventListener("click", ()=>{ modalOverlay.style.display="none"; });

    // Calcul Ã¢ge auto
    document.getElementById("dateNaissance").addEventListener("change",(e)=>{
      const birth=new Date(e.target.value);
      const ageDifMs=Date.now()-birth.getTime();
      const ageDate=new Date(ageDifMs);
      document.getElementById("age").value=Math.abs(ageDate.getUTCFullYear()-1970);
    });

    // CrÃ©ation patient
    document.getElementById("patientForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const data={
        nom:document.getElementById("nom").value,
        prenom:document.getElementById("prenom").value,
        dateNaissance:document.getElementById("dateNaissance").value,
        age:document.getElementById("age").value,
        natureBlessure:document.getElementById("natureBlessure").value,
        createdBy:user ? user.pseudo : "inconnu",
        createdAt:new Date().toISOString()
      };
      await addDoc(collection(db,"patients"),data);
      modalOverlay.style.display="none";
    });

    // Affichage patients en temps rÃ©el
    onSnapshot(collection(db,"patients"),(snapshot)=>{
      const patientList=document.getElementById("patientList");
      patientList.innerHTML="";
      snapshot.forEach(docSnap=>{
        const p=docSnap.data();
        const li=document.createElement("li");
        li.textContent=`${p.nom} ${p.prenom} (${p.age} ans) - ${p.natureBlessure||""}`;
        patientList.appendChild(li);
      });
    });

    // Affichage joueurs en temps rÃ©el
    onSnapshot(collection(db,"users"),(snapshot)=>{
      const userList=document.getElementById("userList");
      userList.innerHTML="";
      snapshot.forEach(docSnap=>{
        const u=docSnap.data();
        const li=document.createElement("li");
        let status="âšª";
        if(u.serviceActive){ status="ðŸŸ¢"; }
        li.textContent=`${status} ${docSnap.id}`;
        userList.appendChild(li);
      });
    });

  </script>
</body>
</html>